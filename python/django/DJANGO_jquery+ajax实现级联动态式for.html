<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/dns_01_dns_problem_analysis.html">DNS解析问题排查实践</a>
            </li>
            <li>
              <a href="/linux/advance/dns_00_how_dns_work_in_linux.html">Linux中的DNS解析是如何工作的</a>
            </li>
            <li>
              <a href="/service/dnsmasq/dnsmasq_01.01_introduction_and_basic.html">dnsmasq基础知识</a>
            </li>
            <li>
              <a href="/linux/advance/memory_01_how_memory_work_in_linux.html">linux中的内存是如何工作的？</a>
            </li>
            <li>
              <a href="/database/mysql/mysql_4.0.1_problem_caused_by_auto_increment.html">mysql 4.0.1：auto_increment引起的问题</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
              <ul>
                <li>
                  <a href="/python/advance/index.html">advance</a>
                </li>
                <li>
                  <a href="/python/advanced/index.html">advanced</a>
                </li>
                <li>
                  <a href="/python/advance/index.html">advance</a>
                </li>
                <li>
                  <a href="/python/basic/index.html">basic</a>
                </li>
                <li>
                  <a href="/python/codefights/index.html">codefights</a>
                </li>
                <li>
                  <a href="/python/django/index.html">django</a>
                  <ul>
                    <li><a href="/python/django/django_error_1.1.0_sqlite3_import_error.html">django error: 1.1.0 "No module named _sqlite3"</a></li>
                    <li><a href="/python/django/django_error_1.2.0_bad_request_400.html">django error: 1.2.0 "bad request 400"</a></li>
                    <li><a href="/python/django/django_extension_knowledge.html">django 扩展: 扩展知识点</a></li>
                    <li><a href="/python/django/django_setting_1.1.0_centralize_settings_in_setting_conf.html">django settings: 1.1.0 集中所有项目配置到settings中</a></li>
                    <li><a href="/python/django/django_tutorial_1.1.0_project_create.html">django tutorial: 1.1.0 项目环境及创建项目</a></li>
                    <li><a href="/python/django/django_tutorial_1.2.0_create_app_and_views_basic.html">django tutorial: 1.2.0 创建APP及views基础</a></li>
                    <li><a href="/python/django/django_tutorial_1.2.1_app_models_and_admin_basic.html">django tutorial: 1.2.1 APP之models基础和admin基础</a></li>
                    <li><a href="/python/django/DJANGO_jquery+ajax实现级联动态式for.html">django+jquery+ajax实现级联动态式form</a></li>
                    <li><a href="/python/django/csrf_1.0_exempt.html">csrf: 1.0 为views去除csrf认证</a></li>
                    <li><a href="/python/django/django_autoreload_oserror.html">django中执行os.chdir()引起的"devserver autoreload: OSError"</a></li>
                    <li><a href="/python/django/django_splitlines_to_list.html">django中如何将多行string转换成list</a></li>
                    <li><a href="/python/django/models_1.0_query.html">models: 1.0 models中的数据，如何实现数据库中的select语句</a></li>
                    <li><a href="/python/django/models_1.1_query01.html">models: 1.1 通过model的查询操作，来获取某一个字段内容</a></li>
                    <li><a href="/python/django/models_1.2_query02_verbose_name.html">models: 1.2 在views中获取models中字段的verbose_name</a></li>
                    <li><a href="/python/django/models_2.0_dumpdata_loaddata.html">models: 2.0 数据导入及导出</a></li>
                    <li><a href="/python/django/models_3.0_prevent_duplicate_data.html">models: 3.0 字段不可重复</a></li>
                    <li><a href="/python/django/models_4.0_func01_save.html">models: 4.0 重写save方法</a></li>
                    <li><a href="/python/django/nginx_uwsgi_django.html">nginx+uwsgi+django组合</a></li>
                    <li><a href="/python/django/settings_1.1.0_template.html">settings 1.1.0 template配置</a></li>
                    <li><a href="/python/django/template_01_dict.html">template: 1.0 使用dict</a></li>
                    <li><a href="/python/django/urllib2_1.0_csrf_login.html">urllib: 1.0 登陆django的python客户端</a></li>
                    <li><a href="/python/django/uwsgi_nginx_timeout.html">uwsgi: nginx超时设定</a></li>
                    <li><a href="/python/django/views_1.0_login_logout.html">views: 1.0 login and logout</a></li>
                    <li><a href="/python/django/views_1.1_login_login_required.html">views: 1.1 装饰器login_required</a></li>
                    <li><a href="/python/django/views_2.0_get_client_ip.html">views: 2.0 获取用户ip</a></li>
                    <li><a href="/python/django/views_3.0_ajax.html">views: 3.0 ajax + views</a></li>
                    <li><a href="/python/django/views_4.0_func_auth.html">views: 4.0 控制function访问权限</a></li>
                    <li><a href="/python/django/views_5.0_models_save.html">views: 5.0 调用models，保存数据</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/python/flask/index.html">flask</a>
                </li>
                <li>
                  <a href="/python/fluent_py/index.html">fluent_py</a>
                </li>
                <li>
                  <a href="/python/py_tour/index.html">py_tour</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>django+jquery+ajax实现级联动态式form</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>13 Oct 2016</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>背景介绍</h3>

<p>使用django创建一个自动化运维系统，希望在页面上创建两个select标签，实现级联的效果，
即第二个select中的内容是由第一个select标签的选择所决定的。</p>

<p><strong>可参照选择省份，然后在选择城市的那种级联效果</strong></p>

<p><a href="https://github.com/xiaotuanyu120/django-devops">github地址</a></p>

<p>最终使用的解决方案是：
（此处以brand和host为例，每个brand有多个host）</p>

<ul>
<li>django的models来创建form</li>
<li>django的views来从models的form中获取brand，并渲染到第一个select中供用户选择</li>
<li>当用户选择了brand后，jquery+ajax动态的把用户的选择发送到views中处理，并获取返回数据，并将其渲染到第二个select中</li>
</ul>

<!--more-->

<h3>django的models.py内容</h3>
<pre class="chroma"><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Brand</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span><span class="p">:</span>
    <span class="n">brand</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">auto_now</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">brand</span>

    <span class="k">def</span> <span class="fm">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">brand</span>


<span class="k">class</span> <span class="nc">Host</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span><span class="p">:</span>
    <span class="n">service_type_list</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">web</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">web</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">,</span>
        <span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ser</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">service</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GenericIPAddressField</span><span class="p">(</span><span class="p">)</span>
    <span class="n">hosttag</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">brand</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Brand</span><span class="p">)</span>
    <span class="n">service_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">service_type_list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">web</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">auto_now</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>

    <span class="k">def</span> <span class="fm">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hosttag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">+</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">brand</span><span class="o">.</span><span class="n">brand</span> <span class="o">+</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_type</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">hosttag</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Host</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1"># Host类中的brand设定为外键，对象是Brand类</span>
<span class="c1"># Host类重写了save方法，用来自动生成hosttag</span>
</pre>
<h3>django的views.py相关内容</h3>
<pre class="chroma"><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">logout</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_protect</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">check_output</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Host</span><span class="p">,</span> <span class="n">Brand</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="c1"># ...省略非相关函数及模块导入...</span>


<span class="k">def</span> <span class="nf">dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">devops/login.html</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="c1"># username for main.html</span>
    <span class="n">user_login_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>

    <span class="c1"># initial hosts and brands for selection form</span>
    <span class="n">hosts</span> <span class="o">=</span> <span class="n">Host</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="p">)</span>
    <span class="n">brands</span> <span class="o">=</span> <span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">请选择产品品牌</span><span class="s2">&#34;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">brand</span> <span class="ow">in</span> <span class="n">Brand</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">brand</span> <span class="ow">in</span> <span class="n">brands</span><span class="p">:</span>
            <span class="n">brands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">brand</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">user_login_name</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">user_login_name</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">hosts</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">hosts</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">brands</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">brands</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># function for command running</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">run</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">:</span>
            <span class="c1"># strip去两边空格，split+join去除中间重复空格，然后split转换字符串为list</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1"> </span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">cmd</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">cmd</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">CMD:</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2"> CMD error:</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa"></span><span class="s1">&#39;</span><span class="s1">user_login_name</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">user_login_name</span><span class="p">,</span>
                <span class="sa"></span><span class="s2">&#34;</span><span class="s2">hosts</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">hosts</span><span class="p">,</span>
                <span class="sa"></span><span class="s2">&#34;</span><span class="s2">stdout</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span>
                <span class="sa"></span><span class="s2">&#34;</span><span class="s2">brands</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">brands</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># runner = AnsibleRunner()</span>
        <span class="c1"># runner.init_inventory(host_list=&#39;localhost&#39;)</span>
        <span class="c1"># runner.init_play(hosts=&#39;localhost&#39;, module=&#39;shell&#39;, args=&#39;ls&#39;)</span>
        <span class="c1"># result = runner.run_it()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">devops/dashboard.html</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@csrf_protect</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">form_interaction</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">selected_brand</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">selbrand</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">host_list</span> <span class="o">=</span> <span class="p">[</span><span class="p">]</span>
        <span class="n">filtered_host</span> <span class="o">=</span> <span class="n">Host</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">brand__brand</span><span class="o">=</span><span class="n">selected_brand</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">brand_item</span> <span class="ow">in</span> <span class="n">filtered_host</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">host_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">brand_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">brand_item</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">brand_item</span><span class="p">)</span>
                <span class="n">host_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">brand_item</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">host_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">application/json</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="c1">## dashboard函数用来响应dashboard页面的访问请求</span>
<span class="c1"># 其中处理了brand的&lt;select&gt;的初始化</span>

<span class="c1">## from_interaction函数用来响应ajax的请求，用来返回第二个&lt;select&gt;的内容</span>
<span class="c1"># 需要注意的是，filtered_host = Host.objects.filter(brand__brand=selected_brand)</span>
<span class="c1"># 一般的字段获取我们只要Host.objects.filter(host=&#39;something&#39;)，但是因为brand作为</span>
<span class="c1"># Host类的外键，所以需要brand__接Brand类中的brand字段名称，即&#34;brand__brand&#34;才可以</span>

<span class="c1">## brand_item = str(brand_item)</span>
<span class="c1"># 此举的意义是避免json.dumps()报错。</span>
</pre>
<h3>前端页面内容</h3>
<pre class="chroma"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p"></span><span class="p">&gt;</span>
  {\% csrf_token \%}

  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-group&#34;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-label&#34;</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;selbrand&#34;</span><span class="p"></span><span class="p">&gt;</span>Brand<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">select</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;selbrand&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;selbrand&#34;</span><span class="p"></span><span class="p">&gt;</span>
      {\% for brand in brands \%}
      <span class="p">&lt;</span><span class="nt">option</span><span class="p"></span><span class="p">&gt;</span>{{ brand }}<span class="p">&lt;</span><span class="p">/</span><span class="nt">option</span><span class="p">&gt;</span>
      {\% endfor \%}
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">select</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-group&#34;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-label&#34;</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;selhost&#34;</span><span class="p"></span><span class="p">&gt;</span>Host<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">select</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;selhost&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;selhost&#34;</span><span class="p"></span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">option</span><span class="p"></span><span class="p">&gt;</span>select brand first<span class="p">&lt;</span><span class="p">/</span><span class="nt">option</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">select</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;test_p&#34;</span><span class="p"></span><span class="p">&gt;</span><span class="p">&lt;</span><span class="p">/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-group&#34;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-label&#34;</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;cmd&#34;</span><span class="p"></span><span class="p">&gt;</span>Command<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;cmd&#34;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&#34;Enter cmd&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;cmd&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p"></span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;btn btn-primary&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;run&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Click&#34;</span><span class="p"></span><span class="p">&gt;</span>run<span class="p">&lt;</span><span class="p">/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="c">&lt;!--</span><span class="c">这部分重点注意id和class，这是html元素的身份标识</span><span class="c">--&gt;</span>
</pre>
<h3>jquery &amp; ajax</h3>

<p>这部分代码也是在前端页面中</p>
<pre class="chroma"><span class="c1">//jquery &amp; ajax 部分
</span><span class="c1"></span><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span><span class="o">&gt;</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">)</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">(</span><span class="p">{</span>
     <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">function</span> <span class="nx">getCookie</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
             <span class="kd">var</span> <span class="nx">cookieValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
             <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
                 <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="p">;</span>
                 <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>
                     <span class="c1">// Does this cookie string begin with the name we want?
</span><span class="c1"></span>                     <span class="k">if</span> <span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                         <span class="nx">cookieValue</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
                         <span class="k">break</span><span class="p">;</span>
                     <span class="p">}</span>
                 <span class="p">}</span>
             <span class="p">}</span>
             <span class="k">return</span> <span class="nx">cookieValue</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="sr">/^http:.*/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="o">||</span> <span class="sr">/^https:.*/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
             <span class="c1">// Only send the token to relative URLs i.e. locally.
</span><span class="c1"></span>             <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&#34;X-CSRFToken&#34;</span><span class="p">,</span> <span class="nx">getCookie</span><span class="p">(</span><span class="s1">&#39;csrftoken&#39;</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
<span class="p">}</span><span class="p">)</span><span class="p">;</span>

  <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#selbrand&#34;</span><span class="p">)</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span>
    <span class="nx">selbrand</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#selbrand&#34;</span><span class="p">)</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="nx">selbrand</span><span class="o">:</span> <span class="nx">selbrand</span><span class="p">}</span><span class="p">;</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="p">{</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;/form_interaction/&#34;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span><span class="p">{</span>
              <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#selhost&#34;</span><span class="p">)</span><span class="p">.</span><span class="nx">empty</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
              <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#selhost&#34;</span><span class="p">)</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&#34;&lt;option&gt;&#34;</span><span class="o">+</span><span class="s2">&#34;请选择主机&#34;</span><span class="o">+</span><span class="s2">&#34;&lt;/option&gt;&#34;</span><span class="p">)</span><span class="p">;</span>
              <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="p">{</span>
                  <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#selhost&#34;</span><span class="p">)</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&#34;&lt;option&gt;&#34;</span><span class="o">+</span><span class="nx">host</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="s2">&#34;&lt;/option&gt;&#34;</span><span class="p">)</span>
                <span class="p">}</span><span class="p">)</span>
            <span class="p">}</span>
    <span class="p">}</span><span class="p">)</span>
  <span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="o">&lt;</span><span class="err">/</span><span class="err">s</span><span class="err">c</span><span class="err">r</span><span class="err">i</span><span class="err">p</span><span class="err">t</span><span class="err">&gt;</span>

<span class="c1">// 此部分最为核心
</span><span class="c1"></span><span class="c1">// $(document).ready(function(){}含义是等待整个页面文档加载完成之后再去执行function
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// $.ajaxSetup()含义是ajax的预配置，此段代码解决了csrf_token(django的中间件)认证的问题，否则ajax的post会报403
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// $(&#34;#selbrand&#34;).change(function(){$.ajax()}含义是当id为selbrand的部分发生了改变(第一个select发生改变)，
</span><span class="c1"></span><span class="c1">// 则执行()之内的函数。
</span><span class="c1"></span><span class="c1">//   首先，取得selbrand的值，组合成dict数据形式，用ajax POST到&#34;/form_interaction/&#34;。
</span><span class="c1"></span><span class="c1">//   然后，success: function(host){}，含义为当post的结果是success(服务端未发生任何错误)时，执行{}内命令
</span><span class="c1"></span><span class="c1">//     其中的host为传入的参数，名称和views中的form_interaction函数return的值一致
</span><span class="c1"></span><span class="c1">//     首先ajax清空selhost(第二个select)的内容，然后再增加一条&#34;&lt;option&gt;请选择主机&lt;/option&gt;&#34;
</span><span class="c1"></span><span class="c1">//     最后，$.each(host,function(i){}，含义为传入host，用each进行循环执行function()，i为每次拿出的变量，
</span><span class="c1"></span><span class="c1">//       实际含义即把返回的host列表，每一项都以&#34;&lt;option&gt;host[i]&lt;/option&gt;&#34;增加到&lt;select&gt;中
</span></pre>
<h3>django的urls.py内容</h3>

<p>用来实现url访问时，映射到哪个views的函数的效果</p>
<pre class="chroma"><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="err">省</span><span class="err">略</span><span class="err">其</span><span class="err">他</span><span class="n">url配置</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="s1">^form_interaction/$</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">form_interaction</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">form_interaction</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># 当访问/from_interaction/时，把请求发送给views.py的form_interaction</span>
</pre>
    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>