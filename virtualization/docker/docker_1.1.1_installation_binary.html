<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/dns_01_dns_problem_analysis.html">Linux中的DNS解析问题排查</a>
            </li>
            <li>
              <a href="/linux/advance/dns_00_how_dns_work_in_linux.html">Linux中的DNS解析是如何工作的</a>
            </li>
            <li>
              <a href="/service/dnsmasq/dnsmasq_01.01_introduction_and_basic.html">dnsmasq基础知识</a>
            </li>
            <li>
              <a href="/linux/advance/memory_01_how_memory_work_in_linux.html">linux中的内存是如何工作的？</a>
            </li>
            <li>
              <a href="/database/mysql/mysql_4.0.1_problem_caused_by_auto_increment.html">mysql 4.0.1：auto_increment引起的问题</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
              <ul>
                <li>
                  <a href="/virtualization/container/index.html">container</a>
                </li>
                <li>
                  <a href="/virtualization/docker/index.html">docker</a>
                  <ul>
                    <li><a href="/virtualization/docker/docker-compose_2.1.0_network.html">docker-compose 2.1.0 network</a></li>
                    <li><a href="/virtualization/docker/docker-compose_2.1.0_network_container_name_vs_hostname_vs_service_name.html">docker-compose 2.1.1 network: container_name vs hostname vs service name</a></li>
                    <li><a href="/virtualization/docker/docker-compose_2.2.0_resource_limit.html">docker-compose 2.2.0 resource limit without swarm</a></li>
                    <li><a href="/virtualization/docker/docker_1.1.0.1_installation_mac.html">1.1.0.1 install docker on mac</a></li>
                    <li><a href="/virtualization/docker/docker_1.1.0_installation_centos7.html">1.1.0 安装(Centos7)</a></li>
                    <li><a href="/virtualization/docker/docker_1.1.1_installation_binary.html">1.1.1 二进制文件安装(Centos7)</a></li>
                    <li><a href="/virtualization/docker/docker_1.1.2_custom_bridge_to_docker.html">1.1.2 为docker创建docker0以外的网桥</a></li>
                    <li><a href="/virtualization/docker/docker_1.2.0_basic_command.html">1.2.0 基础命令</a></li>
                    <li><a href="/virtualization/docker/docker_2.1.1_image_search_pull.html">2.1.1 镜像-查找与下载镜像</a></li>
                    <li><a href="/virtualization/docker/docker_2.1.2_image_info_manage.html">2.1.2 镜像-镜像信息的查看与管理</a></li>
                    <li><a href="/virtualization/docker/docker_2.1.3_image_delete.html">2.1.3 镜像-镜像的删除</a></li>
                    <li><a href="/virtualization/docker/docker_2.1.4_image_import_outport.html">2.1.4 镜像-镜像的导入和导出</a></li>
                    <li><a href="/virtualization/docker/docker_2.1.5_image_docker_hub.html">2.1.5 镜像-镜像的上传</a></li>
                    <li><a href="/virtualization/docker/docker_2.1.6_image_build.html">2.1.6 镜像-build 镜像</a></li>
                    <li><a href="/virtualization/docker/docker_2.2.1_Dockerfile.html">1.2.1 Dockerfile</a></li>
                    <li><a href="/virtualization/docker/docker_2.2.2_Dockerfile_date_timezone.html">1.2.2 docker容器时间不准解决方案</a></li>
                    <li><a href="/virtualization/docker/docker_2.2.3_Dockerfile_entrypoint.html">2.2.3 Dockerfile entrypoint with script</a></li>
                    <li><a href="/virtualization/docker/docker_2.2.4_Dockerfile_msttcorefonts_installation.html">1.2.4 docker容器安装microsoft truetype 字体</a></li>
                    <li><a href="/virtualization/docker/docker_2.2.5_Dockerfile_example.html">1.2.5 dockerfile 示例</a></li>
                    <li><a href="/virtualization/docker/docker_2.2.6_Dockerfile_healthcheck.html">2.2.6 Dockerfile healthcheck</a></li>
                    <li><a href="/virtualization/docker/docker_2.2.6_Dockerfile_multiple_stage_build_golang.html">2.2.7 Containerfile multiple stage build and run golang</a></li>
                    <li><a href="/virtualization/docker/docker_3.1.0_example_nginx.html">3.1.0 docker封装nginx服务</a></li>
                    <li><a href="/virtualization/docker/docker_3.2.0_example_tomcat_standlone_arg_v.html">3.2.0 tomcat使用-v参数挂载本地代码和日志目录</a></li>
                    <li><a href="/virtualization/docker/docker_3.3.0_example_static_file.html">3.3.0 docker nginx with multiple sites</a></li>
                    <li><a href="/virtualization/docker/docker_3.4.0_example_error_alphine_java_not_found.html">3.4.0 alpine oracle java no such file or directory error</a></li>
                    <li><a href="/virtualization/docker/docker_4.0.0_local_registry.html">4.0.0 docker 本地registry</a></li>
                    <li><a href="/virtualization/docker/docker_4.0.1_local_registry-operation-tutorial.html">4.0.1 docker 本地registry 使用说明</a></li>
                    <li><a href="/virtualization/docker/docker_4.0.2_local_registry-error-push-always-retrying.html">4.0.2 docker 本地registry push时一直retrying</a></li>
                    <li><a href="/virtualization/docker/docker_4.1.0_gitlab.html">4.1.0 在docker中运行gitlab ce</a></li>
                    <li><a href="/virtualization/docker/docker_5.2.0_network_iptables.html">5.2.0 网络：docker中的iptables</a></li>
                    <li><a href="/virtualization/docker/docker_knowledge_1.1.0_security.html">docker 理论漫谈 1.1.0 docker存在的安全问题（浅谈）</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/virtualization/kvm/index.html">kvm</a>
                </li>
                <li>
                  <a href="/virtualization/openstack/index.html">openstack</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>1.1.1 二进制文件安装(Centos7)</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>28 Jul 2017</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>0. 准备</h3>

<p><a href="https://docs.docker.com/engine/installation/linux/docker-ce/binaries/">docker官方二进制文件安装文档</a></p>

<h4>1) 使用二进制文件安装docker之前，确认满足以下系统环境</h4>

<ul>
<li>系统是64位（这里使用的是centos7）, <code>uname -i</code></li>
<li>Linux kernel版本是 3.10 或更高, <code>uname -r</code></li>
<li>iptables版本是 1.4 或更高, <code>iptables --version</code></li>
<li>git版本是 1.7 或更高, <code>git --version</code></li>
<li>可执行的ps命令, <code>rpm -qa |grep procps; which ps</code></li>
<li>XZ Utils版本是 4.9 或更高, <code>xz --version</code></li>
<li>挂载合适的cgroupfs 分层, <code>yum install -y libcgroup libcgroup-tools;systemctl enable cgconfig;systemctl start cgconfig</code></li>
</ul>

<h4>2) 增强安全</h4>

<p>为了增强安全性，系统需要开启selinux，开启selinux后，docker会自动在创建容器时配置selinux的context，也就是说，我们只要开启selinux就好，其他的docker来做了。<br />
&gt; <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html/overview_of_containers_in_red_hat_systems/introduction_to_linux_containers#secure_containers_with_selinux">redhat 关于这docker和selinux的详细解释</a></p>

<blockquote>
<p>关于安全计算模式（seccomp）,参见<a href="https://docs.docker.com/engine/security/seccomp/">docker关于seccomp的详细介绍</a>，通过seccomp可以禁用某些系统调用，来增强docker的安全性。</p>
</blockquote>

<hr />

<h3>1. 安装docker静态二进制文件</h3>
<pre class="chroma"><span class="c1"># step 1 下载docker二进制文件</span>
wget https://download.docker.com/linux/static/stable/x86_64/docker-17.06.0-ce.tgz

<span class="c1"># step 2 解压</span>
tar zxvf docker-17.06.0-ce.tgz

<span class="c1"># step 3 拷贝二进制文件到PATH变量的路径中</span>
cp docker/* /usr/bin/

<span class="c1"># step 4 安装docker-compose</span>
wget https://github.com/docker/compose/releases/download/1.17.1/docker-compose-Linux-x86_64
mv docker-compose-Linux-x86_64 /usr/bin/docker-compose
chmod <span class="m">755</span> /usr/bin/docker-compose
</pre>
<hr />

<h3>2. 启动dockerd（systemd）</h3>
<pre class="chroma"><span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Docker Application Container Engine
</span><span class="s1">Documentation=https://docs.docker.com
</span><span class="s1">After=network-online.target docker.socket firewalld.service
</span><span class="s1">Wants=network-online.target
</span><span class="s1">Requires=docker.socket
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">Type=notify
</span><span class="s1"># the default is not to use systemd for cgroups because the delegate issues still
</span><span class="s1"># exists and systemd currently does not support the cgroup feature set required
</span><span class="s1"># for containers run by docker
</span><span class="s1">ExecStart=/usr/bin/dockerd -H fd://
</span><span class="s1">ExecReload=/bin/kill -s HUP $MAINPID
</span><span class="s1">LimitNOFILE=1048576
</span><span class="s1"># Having non-zero Limit*s causes performance problems due to accounting overhead
</span><span class="s1"># in the kernel. We recommend using cgroups to do container-local accounting.
</span><span class="s1">LimitNPROC=infinity
</span><span class="s1">LimitCORE=infinity
</span><span class="s1"># Uncomment TasksMax if your systemd version supports it.
</span><span class="s1"># Only systemd 226 and above support this version.
</span><span class="s1">#TasksMax=infinity
</span><span class="s1">TimeoutStartSec=0
</span><span class="s1"># set delegate yes so that systemd does not reset the cgroups of docker containers
</span><span class="s1">Delegate=yes
</span><span class="s1"># kill only the docker process, not all processes in the cgroup
</span><span class="s1">KillMode=process
</span><span class="s1"># restart the docker process if it exits prematurely
</span><span class="s1">Restart=on-failure
</span><span class="s1">StartLimitBurst=3
</span><span class="s1">StartLimitInterval=60s
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /usr/lib/systemd/system/docker.service

<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Docker Socket for the API
</span><span class="s1">PartOf=docker.service
</span><span class="s1">
</span><span class="s1">[Socket]
</span><span class="s1">ListenStream=/var/run/docker.sock
</span><span class="s1">SocketMode=0660
</span><span class="s1">SocketUser=root
</span><span class="s1">SocketGroup=docker
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=sockets.target&#39;</span> &gt; /usr/lib/systemd/system/docker.socket

<span class="c1"># 按照docker.socket中指定的增加docker组</span>
groupadd docker

<span class="c1"># 增加root用户对新建文件的selinux权限</span>
chcon -u system_u /usr/lib/systemd/system/docker.servcie
restorecon -vF /usr/lib/systemd/system/docker.servcie
ll /usr/lib/systemd/system/docker.servcie -Z
-rw-r--r--. root root system_u:object_r:systemd_unit_file_t:s0 /usr/lib/systemd/system/docker.servcie

<span class="c1"># 启动docker</span>
systemctl daemon-reload
systemctl <span class="nb">enable</span> docker
systemctl start docker
</pre>
<blockquote>
<p>docker的systemd unit文件参照<a href="https://github.com/moby/moby/tree/master/contrib/init/systemd">docker项目源码中的systemd文件示例</a></p>

<p>docker unit文件中&rdquo;dockerd -H fd://&ldquo;的&rdquo;fd://&ldquo;是linux中的文件描述符的缩写，-H是指定一种socket类型，可使用unix，tcp和fd，详细可参阅<a href="https://docs.docker.com/engine/reference/commandline/dockerd//#daemon-socket-option">docker文档中对于socket选项这部分的说明</a></p>
</blockquote>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>