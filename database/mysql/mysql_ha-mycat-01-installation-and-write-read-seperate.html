<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/shell/shell_1.2_read.html">SHELL: 1.2 read</a>
            </li>
            <li>
              <a href="/cryptography/basic/openssl_1.3.1_usage.html">openssl 1.3.1 SSL DEBUG: s_client</a>
            </li>
            <li>
              <a href="/linux/advance/network_theory-TCP-IP-note.html">网络: 理论 - TCP/IP详解读书笔记</a>
            </li>
            <li>
              <a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式</a>
            </li>
            <li>
              <a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
              <ul>
                <li>
                  <a href="/database/mysql/index.html">mysql</a>
                  <ul>
                    <li><a href="/database/mysql/MYSQL_多实例配置+启动脚本.html">MYSQL: 多实例配置+启动脚本</a></li>
                    <li><a href="/database/mysql/MYSQL_无法通过sock登陆.html">MYSQL-error: 无法通过sock登陆</a></li>
                    <li><a href="/database/mysql/MYSQL_查看表ENGINE(v5.6).html">MYSQL: 查看表ENGINE(v5.6)</a></li>
                    <li><a href="/database/mysql/MYSQL_设置wait_timeout控制sleep线程太多.html">MYSQL: 设置wait_timeout控制sleep线程太多</a></li>
                    <li><a href="/database/mysql/MySQL_增量备份-binlog.html">MySQL: 增量备份-binlog</a></li>
                    <li><a href="/database/mysql/MySQL_备份及恢复理论.html">MySQL:备份及恢复理论</a></li>
                    <li><a href="/database/mysql/MySQL_安装脚本.html">MySQL: 安装脚本</a></li>
                    <li><a href="/database/mysql/MySQL_配置及优化.html">MySQL: 配置及优化</a></li>
                    <li><a href="/database/mysql/error_1.0_force_close_of_thread.html">MYSQL-错误: 1.0 force close of thread xxx user: 'someuser'</a></li>
                    <li><a href="/database/mysql/error_1.1_cant_connect_mysql_remotely.html">MYSQL-错误: 1.1 DNS查询优化和Host缓存</a></li>
                    <li><a href="/database/mysql/error_5.6-error-1045.html">error: 5.6-error-1045</a></li>
                    <li><a href="/database/mysql/error_innodb_init.html">MYSQL-错误：无法启动排障</a></li>
                    <li><a href="/database/mysql/error_主从_1062Duplicateentry_.html">error: 主从"1062 Duplicate entry"</a></li>
                    <li><a href="/database/mysql/error_双主错误1593.html">error: 双主错误1593</a></li>
                    <li><a href="/database/mysql/error_服务无法启动报错.html">error: 服务无法启动报错</a></li>
                    <li><a href="/database/mysql/error_表只读.html">error: 表只读</a></li>
                    <li><a href="/database/mysql/mysql_1.0.0_installation.html">mysql 1.0.0: 安装教程</a></li>
                    <li><a href="/database/mysql/mysql_1.0.1_docker_compose.html">mysql 1.0.1: docker-compose(单实例和主从)</a></li>
                    <li><a href="/database/mysql/mysql_3.0.0_basic_operation.html">mysql 3.0.0：常用命令</a></li>
                    <li><a href="/database/mysql/mysql_4.0.1_problem_caused_by_auto_increment.html">mysql 4.0.1：auto_increment引起的问题</a></li>
                    <li><a href="/database/mysql/mysql_config_basic.html">MySQL: 配置 - 常用基本配置</a></li>
                    <li><a href="/database/mysql/mysql_config_optimize.html">MySQL: 配置 - 调优</a></li>
                    <li><a href="/database/mysql/mysql_config_set_character_collation.html">MySQL: 配置 - 配置字符集为utf8</a></li>
                    <li><a href="/database/mysql/mysql_error_start_login.html">MYSQL-错误：启动/登录报错</a></li>
                    <li><a href="/database/mysql/mysql_ha-mycat-00-introduction.html">MySQL: HA - mycat简介</a></li>
                    <li><a href="/database/mysql/mysql_ha-mycat-01-installation-and-write-read-seperate.html">MySQL: HA - mycat安装&读写分离</a></li>
                    <li><a href="/database/mysql/mysql_manage_backup_recovery.html">MySQL: 管理 - 备份及恢复</a></li>
                    <li><a href="/database/mysql/mysql_manage_reset_root_password.html">MySQL: 管理 - 忘记root密码</a></li>
                    <li><a href="/database/mysql/mysql_replica-master-and-master-v5.5.html">MySQL: 复制 - 双主配置(MySQL5.5)</a></li>
                    <li><a href="/database/mysql/mysql_replica-master-and-slave-v5.6-centos6.html">MySQL: 复制 - 主从配置(MySQL5.6 on centos6)</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/database/oracle/index.html">oracle</a>
                </li>
                <li>
                  <a href="/database/rabbitmq/index.html">rabbitmq</a>
                </li>
                <li>
                  <a href="/database/redis/index.html">redis</a>
                </li>
                <li>
                  <a href="/database/rocketmq/index.html">rocketmq</a>
                </li>
                <li>
                  <a href="/database/sql/index.html">sql</a>
                </li>
                <li>
                  <a href="/database/zookeeper/index.html">zookeeper</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>MySQL: HA - mycat安装&读写分离</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>22 Sep 2016</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>环境准备</h3>

<p>mycat：192.168.110.128</p>

<h3>JDK安装</h3>
<pre class="chroma">wget http://download.oracle.com/otn-pub/java/jdk/8u102-b14/server-jre-8u102-linux-x64.tar.gz?AuthParam<span class="o">=</span>1474528150_d01d99688bc1767305a1d288111bec92
tar zxf server-jre-8u102-linux-x64.tar.gz
mv jdk1.8.0_102/ /usr/local
ln -s /usr/local/jdk1.8.0_102 /usr/local/jdk
vi /etc/profile.d/java-env.sh
*********************
<span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/local/jdk
<span class="nv">JRE_HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/jre
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/bin:<span class="si">${</span><span class="nv">JRE_HOME</span><span class="si">}</span>/bin
<span class="nv">CLASSPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/lib:<span class="si">${</span><span class="nv">JRE_HOME</span><span class="si">}</span>/lib
*********************
<span class="nb">source</span> /etc/profile.d/java-env.sh
 
<span class="c1"># 检查Java环境</span>
Java -version
java version <span class="s2">&#34;1.8.0_102&#34;</span>
Java<span class="o">(</span>TM<span class="o">)</span> SE Runtime Environment <span class="o">(</span>build 1.8.0_102-b14<span class="o">)</span>
Java HotSpot<span class="o">(</span>TM<span class="o">)</span> 64-Bit Server VM <span class="o">(</span>build 25.102-b14, mixed mode<span class="o">)</span>
 
<span class="nb">echo</span> <span class="nv">$JAVA_HOME</span>
/usr/local/jdk
</pre>
<h3>MyCat安装</h3>
<pre class="chroma"><span class="c1"># 下载并解压mycat</span>
wget 
https://raw.githubusercontent.com/MyCATApache/Mycat-download/master/1.5-RELEASE/Mycat-server-1.5.1-RELEASE-20160816173057-linux.tar.gz
tar zxf Mycat-server-1.5.1-RELEASE-20160816173057-linux.tar.gz
 
<span class="c1"># 准备mycat用户</span>
groupadd dba
useradd -g dba mycat
passwd mycat
 
mkdir /home/mycat/app
mv mycat /home/mycat/app
chown -R mycat:dba /home/mycat/app
 
<span class="c1"># 设置环境变量</span>
vi /home/mycat/.bash_profile
*****************************
<span class="c1"># 在文件的最后添加</span>
<span class="nb">export</span> <span class="nv">MYCAT_HOME</span><span class="o">=</span>/home/mycat/app/mycat
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$MYCAT_HOME</span>/bin
*****************************
<span class="nb">source</span> /home/mycat/.bash_profile
 
<span class="c1"># 检查环境变量</span>
<span class="nb">echo</span> <span class="nv">$MYCAT_HOME</span>
/home/mycat/app/mycat
</pre>
<h3>MySQL准备</h3>

<p>mysql配置修改，需要在mysql的主机上修改mysql不区分大小写</p>
<pre class="chroma">vi /etc/my.cnf
****************************
<span class="nv">lower_case_table_names</span> <span class="o">=</span> <span class="m">1</span>
****************************
service mysqld restart
</pre>
<p>mysql节点对mycat主机进行访问授权</p>
<pre class="chroma"><span class="o">#</span> <span class="k">on</span> <span class="n">master01</span> <span class="o">&amp;</span> <span class="n">master02</span>
<span class="n">MySQL</span> <span class="p">[</span><span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">all</span> <span class="k">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">&#39;</span><span class="s1">root</span><span class="s1">&#39;</span><span class="o">@</span><span class="s1">&#39;</span><span class="s1">192.168.110.%</span><span class="s1">&#39;</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">&#39;</span><span class="s1">123456</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="n">MySQL</span> <span class="p">[</span><span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="k">privileges</span><span class="p">;</span>
</pre>
<p>若不对mycat主机授权，会出现ERROR 3009或1184，大意是无法从mycat连接其他数据节点</p>

<h3>MyCat配置</h3>

<p>server.xml，主要包含了mycat的系统配置</p>
<pre class="chroma">        &lt;user <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;test&#34;</span>&gt;
                &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>&gt;test&lt;/property&gt;
                &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;schemas&#34;</span>&gt;example&lt;/property&gt;
        &lt;/user&gt;
 
        &lt;user <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;user&#34;</span>&gt;
                &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>&gt;user&lt;/property&gt;
                &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;schemas&#34;</span>&gt;example&lt;/property&gt;
                &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;readOnly&#34;</span>&gt;true&lt;/property&gt;
        &lt;/user&gt;
</pre>
<p>上面配置了test和user两个用户，指定schema的同时，配置了test可读写，而user只读</p>

<p>schema.xml，包含了MyCat的逻辑库、表、分片规则、DataNode以及DataSource</p>
<pre class="chroma">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span>?&gt;
&lt;!DOCTYPE mycat:schema SYSTEM <span class="s2">&#34;schema.dtd&#34;</span>&gt;
&lt;mycat:schema xmlns:mycat<span class="o">=</span><span class="s2">&#34;http://org.opencloudb/&#34;</span> &gt;
 
        &lt;schema <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;example&#34;</span> <span class="nv">checkSQLschema</span><span class="o">=</span><span class="s2">&#34;false&#34;</span> <span class="nv">sqlMaxLimit</span><span class="o">=</span><span class="s2">&#34;100&#34;</span> <span class="nv">dataNode</span><span class="o">=</span><span class="s2">&#34;dn1&#34;</span>&gt;
        &lt;/schema&gt;
 
        &lt;dataNode <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;dn1&#34;</span> <span class="nv">dataHost</span><span class="o">=</span><span class="s2">&#34;localhost1&#34;</span> <span class="nv">database</span><span class="o">=</span><span class="s2">&#34;test&#34;</span> /&gt;
 
        &lt;dataHost <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;localhost1&#34;</span> <span class="nv">maxCon</span><span class="o">=</span><span class="s2">&#34;1000&#34;</span> <span class="nv">minCon</span><span class="o">=</span><span class="s2">&#34;10&#34;</span> <span class="nv">balance</span><span class="o">=</span><span class="s2">&#34;3&#34;</span>
                <span class="nv">writeType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="nv">dbType</span><span class="o">=</span><span class="s2">&#34;mysql&#34;</span> <span class="nv">dbDriver</span><span class="o">=</span><span class="s2">&#34;native&#34;</span> <span class="nv">switchType</span><span class="o">=</span><span class="s2">&#34;-1&#34;</span>  <span class="nv">slaveThreshold</span><span class="o">=</span><span class="s2">&#34;100&#34;</span>&gt;
                &lt;heartbeat&gt;select user<span class="o">(</span><span class="o">)</span>&lt;/heartbeat&gt;
                &lt;writeHost <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;hostM1&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;192.168.110.129:3306&#34;</span> <span class="nv">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span>
                        <span class="nv">password</span><span class="o">=</span><span class="s2">&#34;123456&#34;</span>&gt;
                        &lt;readHost <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;hostS2&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;192.168.110.130:3306&#34;</span> <span class="nv">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span> <span class="nv">password</span><span class="o">=</span><span class="s2">&#34;123456&#34;</span> /&gt;
                &lt;/writeHost&gt;
                &lt;!--&lt;writeHost <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;hostS1&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;localhost:3316&#34;</span> <span class="nv">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span>--&gt;
                        &lt;!--password<span class="o">=</span><span class="s2">&#34;123456&#34;</span> /&gt;--&gt;
                &lt;!-- &lt;writeHost <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;hostM2&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;localhost:3316&#34;</span> <span class="nv">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span> <span class="nv">password</span><span class="o">=</span><span class="s2">&#34;123456&#34;</span>/&gt; --&gt;
        &lt;/dataHost&gt;
&lt;/mycat:schema&gt;
</pre>
<p>具体配置详情可见mycat站点文档
重点配置介绍</p>

<ul>
<li>schema，配置了逻辑库名称，指定了数据节点</li>
<li>dataNode，配置了数据节点，指定了逻辑物理主机和实际数据库</li>
<li>dataHost，配置了逻辑物理主机、balance(3是绝对读写分离)、switchType(1是写主节点失败自动切换到备节点)</li>
</ul>

<h3>MyCat启动</h3>
<pre class="chroma"><span class="nb">cd</span> /home/mycat/app/mycat/bin
chmod u+x mycat
 
<span class="c1"># 方法1</span>
nohup sh mycat console <span class="p">&amp;</span>
 
<span class="c1"># 方法2</span>
mycat install
mycat start
 
<span class="c1"># 检查启动情况</span>
netstat -lnpt
Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name   
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22                  0.0.0.0:*                   LISTEN      999/sshd            
tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:32000             0.0.0.0:*                   LISTEN      5891/java           
tcp        <span class="m">0</span>      <span class="m">0</span> :::22                       :::*                        LISTEN      999/sshd            
tcp        <span class="m">0</span>      <span class="m">0</span> :::1984                     :::*                        LISTEN      5891/java           
tcp        <span class="m">0</span>      <span class="m">0</span> :::8066                     :::*                        LISTEN      5891/java           
tcp        <span class="m">0</span>      <span class="m">0</span> :::39683                    :::*                        LISTEN      5891/java           
tcp        <span class="m">0</span>      <span class="m">0</span> :::57509                    :::*                        LISTEN      5891/java           
tcp        <span class="m">0</span>      <span class="m">0</span> :::9066                     :::*                        LISTEN      5891/java     
 
</pre>
<h3>MyCat测试</h3>
<pre class="chroma"># 安装mysql客户端
yum install mysql -y
 
# 使用test测试读写功能
mysql -u test -p -P 8066 -h127.0.0.1
``` sql
MySQL [(none)]&gt; use example
Database changed
 
MySQL [example]&gt; create table persons ( age int(2), name varchar(10) );
Query OK, 0 rows affected (0.05 sec)
 
# 使用user测试只读
MySQL [(none)]&gt; use example
Database changed
 
MySQL [example]&gt; show tables;
+----------------+
| Tables_in_test |
+----------------+
| persons        |
+----------------+
1 row in set (0.00 sec)
 
MySQL [example]&gt; create table persons2 ( age int(2), name varchar(10) );
ERROR 1495 (HY000): User readonly
</pre>
    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>