<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/network_tcp-reset.html">网络: TCP - RST简介</a>
            </li>
            <li>
              <a href="/linux/shell/shell_1.0.4_variable_string.html">SHELL: 1.0.4 变量：字符串及字符串切片</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.4_start_init.html">GO 1.1.4 入口函数和包初始化</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.3_build.html">GO 1.1.3 构建应用</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.2_proj_struct.html">GO 1.1.2 目录结构</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                  <ul>
                    <li><a href="/service/apache/1.0.0_apache_installation.html">apache: 安装 - 脚本示例</a></li>
                    <li><a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式</a></li>
                    <li><a href="/service/apache/1.1.0_apache_config_basic.html">apache: 配置 - 基本配置</a></li>
                    <li><a href="/service/apache/1.1.0_b_apache_config_rewrite.html">apache: 配置 - rewrite</a></li>
                    <li><a href="/service/apache/1.1.0_c_apache_config_access_limit.html">apache: 配置 - htpasswd</a></li>
                    <li><a href="/service/apache/1.1.0_d_apache_config_anti_leech_file_gate.html">apache: 配置 - 防盗链</a></li>
                    <li><a href="/service/apache/1.1.0_e_apache_config_old_2.2_directory_access_limit.html">apache: 配置 - 目录文件限制（2.2旧版本）</a></li>
                    <li><a href="/service/apache/1.1.0_f_apache_config_log_and_cache.html">apache: 配置 - 日志/缓存</a></li>
                    <li><a href="/service/apache/1.1.1_apache_config_parse_php.html">apache: 配置 - PHP解析</a></li>
                    <li><a href="/service/apache/1.1.2_apache_config_security.html">apache: 配置 - 安全</a></li>
                    <li><a href="/service/apache/1.1.3_apache_config_make_servername_and_serveralias_an_ip.html">apache: 配置 - 可以把ServerName和ServerAlias配置为IP吗？</a></li>
                    <li><a href="/service/apache/1.2.0_apache_status_check.html">apache: 管理 - 状态查看</a></li>
                    <li><a href="/service/apache/1.3.0_apache_iptables_selinux.html">apache: 管理 - iptables和selinux</a></li>
                    <li><a href="/service/apache/1.4.0_apache_practice_discuz.html">apache: 实践 - discuz</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/haproxy/index.html">haproxy</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>apache: 配置 - 可以把ServerName和ServerAlias配置为IP吗？</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>24 Feb 2022</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>0. 前言</h2>

<h3>1) 首先铺垫一下apache的virtualhost的理论配置</h3>

<p>apache有两种配置virtualhost的方式，一种是基于IP（ip based），另外一种是基于名称（name based）。</p>

<ul>
<li>基于IP的就是使用多个ip:port的不同唯一搭配，来使用多个daemon或者单个daemon的形式来提供多个虚拟主机的访问。例如一台机器同时绑定了192.168.1.2和192.168.1.3两个ip，就可以同时提供192.168.1.2:80和192.168.1.3:80两个虚拟主机的访问</li>
<li>基于名称的可以在同一个ip:port上，通过ServerName和ServerAlias的不同设定，来提供多个虚拟主机的访问。</li>
</ul>

<blockquote>
<p>关于apache的virtualhost详细文档，可以参见<a href="https://httpd.apache.org/docs/2.4/vhosts/examples.html">httpd 官方文档</a></p>

<p>基于IP的方式中，多个daemon还是单个daemon的问题，这里不讨论，可以参见上面提供的官方文档查看详细信息</p>

<p>另一个需要注意的点是，使用基于名称的虚拟主机配置时，在httpd的配置文件中，最先加载的virtualhost配置为默认的虚拟主机</p>
</blockquote>

<p>通常，大部分情况下，我们常用的是使用基于名称的虚拟主机配置方式。</p>

<h3>2) 基于名称的配置中，增加了一个ip访问的需求</h3>

<p>有一天，在某办公室的神秘对话：</p>
<pre class="chroma">开发：运维同学，我想要用ip访问apache，辛苦您帮我配置一下
运维：好的
</pre>
<blockquote>
<p>这个场景中，也是使用的更常见的基于名称的虚拟主机的配置方式</p>
</blockquote>

<p>运维思索了一下，找出了以下方案：</p>

<ol>
<li>用第一个默认virtualhost来提供需要用ip访问的虚拟主机内容。</li>
<li>或者是在默认virtualhost之外，增加一个虚拟主机，配置ServerName（如果有多个ip，可以使用ServerAlias补充）。</li>
</ol>

<p>这两个方案中，第一个方案有明显的缺点，因为生产环境中通常都会给默认虚拟主机设定访问限制，来禁止使用ip或者其他未经授权的域名解析来访问服务器，只有那些明确监听的域名才会被响应。而第二个方案，运维同学心里有点打鼓，不确定同时拥有默认虚拟主机和将ServerName配置为IP的情况下，apache会使用哪个来发起响应。所以运维同学决定来验证一下。</p>

<h2>1. 验证过程</h2>

<h3>1) 准备环境</h3>

<p>配置三个虚拟主机，第一个是默认虚拟主机，访问会返回“from default”；第二个是配置ServerName为ip(127.0.0.1 &amp; 192.168.1.124)的虚拟主机，访问会返回“from ip virtualhost”；第三个是配置了本地测试域名“test.local.net”的虚拟主机，访问会返回“from test.local.net”。三个虚拟主机是按照介绍的顺序依次从上到下排列。</p>

<blockquote>
<p>虽然我们给ServerName配置了IP，但是使用ServerName本身实际上还是使用的基于名字的虚拟主机配置类型。</p>
</blockquote>
<pre class="chroma">mkdir -p <span class="o">{</span>conf/vhosts.d,www/<span class="o">{</span>default,ip,test.local.net<span class="o">}</span><span class="o">}</span>
sudo <span class="nb">echo</span> <span class="s2">&#34;127.0.0.1 test.local.net&#34;</span> &gt;&gt; /etc/hosts

<span class="c1"># 准备 httpd 配置文件</span>
cat <span class="s">&lt;&lt; EOF &gt; conf/vhosts.d/00-default.conf
</span><span class="s">&lt;VirtualHost *:80&gt;
</span><span class="s">  DocumentRoot &#34;/www/default&#34;  
</span><span class="s">
</span><span class="s">  &lt;Directory &#34;/www/default&#34;&gt;
</span><span class="s">    Require all granted
</span><span class="s">  &lt;/Directory&gt;
</span><span class="s">&lt;/VirtualHost&gt;
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; conf/vhosts.d/01-ip.conf
</span><span class="s">&lt;VirtualHost *:80&gt;
</span><span class="s">  DocumentRoot &#34;/www/ip&#34;
</span><span class="s">  ServerName   127.0.0.1:80
</span><span class="s">  ServerAlias  192.168.1.124:80
</span><span class="s">
</span><span class="s">  &lt;Directory &#34;/www/ip&#34;&gt;
</span><span class="s">    Require all granted
</span><span class="s">  &lt;/Directory&gt;
</span><span class="s">&lt;/VirtualHost&gt;
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; conf/vhosts.d/02-test.local.net
</span><span class="s">&lt;VirtualHost *:80&gt;
</span><span class="s">  DocumentRoot &#34;/www/test.local.net&#34; 
</span><span class="s">  ServerName   test.local.net:80
</span><span class="s">
</span><span class="s">  &lt;Directory &#34;/www/test.local.net&#34;&gt;
</span><span class="s">    Require all granted
</span><span class="s">  &lt;/Directory&gt;
</span><span class="s">&lt;/VirtualHost&gt;
</span><span class="s">EOF</span>

<span class="c1"># 准备不同虚拟主机的网站文件</span>
cat <span class="s">&lt;&lt; EOF &gt; www/default/index.html
</span><span class="s">from default
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; www/ip/index.html
</span><span class="s">from ip virtualhost
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; www/test.local.net/index.html
</span><span class="s">from test.local.net
</span><span class="s">EOF</span>

<span class="c1"># httpd:2.4.51使用的网站用户的uid是33，需要正确的授权</span>
sudo chown -R 33.33 www

<span class="c1"># 准备基于docker的启动脚本</span>
cat <span class="s">&lt;&lt; EOF &gt; start.sh
</span><span class="s">docker run -it -d --rm --name httpd \
</span><span class="s">    -p 80:80 \
</span><span class="s">    -v $(pwd)/www:/www \
</span><span class="s">    -v $(pwd)/conf/httpd.conf:/usr/local/apache2/conf/httpd.conf \
</span><span class="s">    -v $(pwd)/conf/vhosts.d:/usr/local/apache2/conf/vhosts.d \
</span><span class="s">    httpd:2.4.51
</span><span class="s">EOF</span>
</pre>
<h3>2) 启动httpd</h3>
<pre class="chroma">sh start.sh
</pre>
<h3>3) 验证</h3>

<p>首先，我们简单的使用curl访问一下，看看结果</p>
<pre class="chroma">curl 127.0.0.1
from ip virtualhost

curl 192.168.1.124
from ip virtualhost

curl test.local.net
from test.local.net
</pre>
<p>结果符合预期，每个访问都得到了设想的结果。</p>

<h3>4) 然而，apache是如何来给请求匹配虚拟主机的呢？</h3>

<p>在<a href="https://httpd.apache.org/docs/2.4/vhosts/name-based.html#page-header">《httpd基于名字的虚拟主机文档》</a>中发现了这样的说明。</p>

<p>首先，请求进来后，apache先通过ip:port来筛选。然后，再使用ServerName和ServerAlias来进行进一步匹配。若匹配到了，则响应请求，若未匹配到，就会进一步使用默认虚拟主机来响应。</p>

<p>在这个过程中，ServerName和ServerAlias部分的匹配，使用的是请求中的&rdquo;Host&rdquo;首部。</p>

<p>那么，来手动修改“Host”首部来验证一下</p>
<pre class="chroma">curl -H <span class="s2">&#34;Host: 127.0.0.1&#34;</span> test.local.net
from ip virtualhost

curl -H <span class="s2">&#34;Host: test.local.net&#34;</span> 192.168.1.124
from test.local.net

curl -H <span class="s2">&#34;Host: nonexist.com&#34;</span> 192.168.1.124
from default
</pre>
<p>果然，返回的内容竟然和请求的url无关，而是和“Host”首部强关联。比如访问test.local.net返回的竟然是“from ip virtualhost”，这和&rdquo;Host: 127.0.0.1&rdquo;首部相对应。</p>

<h2>3. 总结</h2>

<ul>
<li><strong>可以将ServerName和ServerAlias配置为IP</strong>，但这依然是基于名字的虚拟主机配置方式</li>
<li><strong>基于名字的虚拟主机配置方式中，虚拟主机在ServerName和ServerAlias匹配的过程中，使用的是“Host”首部</strong></li>
</ul>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>