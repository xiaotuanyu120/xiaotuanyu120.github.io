<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/dns_01_dns_problem_analysis.html">Linux中的DNS解析问题排查</a>
            </li>
            <li>
              <a href="/linux/advance/dns_00_how_dns_work_in_linux.html">Linux中的DNS解析是如何工作的</a>
            </li>
            <li>
              <a href="/service/dnsmasq/dnsmasq_01.01_introduction_and_basic.html">dnsmasq基础知识</a>
            </li>
            <li>
              <a href="/linux/advance/memory_01_how_memory_work_in_linux.html">linux中的内存是如何工作的？</a>
            </li>
            <li>
              <a href="/database/mysql/mysql_4.0.1_problem_caused_by_auto_increment.html">mysql 4.0.1：auto_increment引起的问题</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/lnmp/index.html">lnmp</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                  <ul>
                    <li><a href="/service/php/php_1.0.0_installation.html">php 1.0.0: 安装教程</a></li>
                    <li><a href="/service/php/php_1.1.0_check_php_env.html">php 1.1.0: 查看环境信息</a></li>
                    <li><a href="/service/php/php_1.1.1_history_of_cgi_fastcgi_php-cgi_php-fpm_spawn-fcgi.html">php: 1.0.0 解析工具 cgi,fastcgi,php-cgi,php-fpm,spawn-fcgi 杂谈</a></li>
                    <li><a href="/service/php/php_1.2.0_configuration_of_log.html">php 1.2.0: PHP配置 - access,slow,error 日志</a></li>
                    <li><a href="/service/php/php_1.2.1_configuration_security.html">php 1.2.1: PHP配置 - 安全配置</a></li>
                    <li><a href="/service/php/php_1.2.2_configuration_process.html">php 1.2.2: PHP配置 - 进程数调整</a></li>
                    <li><a href="/service/php/php_1.2.3_configuration_listen.html">php 1.2.3: PHP配置 - listen</a></li>
                    <li><a href="/service/php/php_1.3.0_concurrent_connection_tunning_with_nginx.html">php 1.3.0: 性能调优 - backlog</a></li>
                    <li><a href="/service/php/php_error_compile_process.html">php error: 编译过程中的错误</a></li>
                    <li><a href="/service/php/php_error_temporally_502.html">php error: 不间断502问题</a></li>
                    <li><a href="/service/php/php_ext_gd.html">php extensions: GD - graphic draw</a></li>
                    <li><a href="/service/php/php_ext_mysql_driver.html">php extensions: 编译时增加mysql驱动模块</a></li>
                    <li><a href="/service/php/php_ext_zip.html">php extensions: zip</a></li>
                    <li><a href="/service/php/php_fpm_error_1.1.0_permission_dennied_error_in_container_when_enable_slowlog.html">php-fpm error: 1.1.0 容器中开启慢日志后的permission dennied错误</a></li>
                    <li><a href="/service/php/php_security_zendguardloader.html">php: 安装zend guard loader</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/product_issues/index.html">product_issues</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>php 1.2.2: PHP配置 - 进程数调整</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>11 Jan 2016</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>0. 关于pm.max_children配置量的文章转发</h3>

<p>现在nginx + fpm 基本成为主流的配置，其中我们比较关注的是pm.max_children的配置</p>

<p><strong>首先，我们关注一个前提设置： pm = static/dynamic，这个选项是标识fpm子进程的产生模式：</strong></p>

<ul>
<li>static ：表示在fpm运行时直接fork出pm.max_chindren个worker进程，</li>
<li>dynamic：表示，运行时fork出start_servers个进程，随着负载的情况，动态的调整，最多不超过max_children个进程。</li>
</ul>

<blockquote>
<p>一般推荐用static，优点是不用动态的判断负载情况，提升性能，缺点是多占用些系统内存资源。</p>
</blockquote>

<p><strong>max_chindren代表的worker的进程数,普遍认为，这个配置越多能同时处理的并发也就越多。但这是一个比较大的误区：</strong></p>

<ol>
<li>查看了fpm的相关源码， 管理进程和worker进程是通过pipe进行数据通讯的。所以进程多了，增加进程管理的开销，系统进程切换的开销，更核心的是，能并发执行的fpm进程不会超过cpu个数。通过多开worker的个数来提升qps， 是错误的理解，不会说你多开了几个进程，就多出几个cpu来处理。</li>
<li>但worker进程开少了，如果server比较繁忙的话，会导到nginx把数据打到fpm的时候，发现所有的woker都在工作中，没有空闲的worker来接受请求，从而导致502。
那worker数到底该怎么配置呢？</li>
</ol>

<p>理论上woker进程数=cpu的个数是最合理的，但由于第2点的原因，可能每个worker都没处理完请求，这样，就会频现502了。但多开请求，只是说避免502，暂时把请求hang住，这只是缓解之道，实际上这不但不会增加系统的并发，而且会加重系统的负荷，所以，设置一个合理的worker数就比较重要了。</p>

<p>天下武功，唯快不破，只有尽可能的提升程序的效率，把单个请求的时间压缩到最低，这样，单个worker的处理时间变短了，那在单位时间里能处理的请求自然就多了。</p>

<p>那么可以通过每个worker在单位时间内处理的请求数来预估max_children的个数。假如最大的一个请求的处理时间是100ms内，而在100ms之内同时有100个请求过来，那了理论上就需要配置100个worker进程，先把请求给hang住。</p>

<p>但最大的请求耗时可能会受很多外在的情况影响，不太好预估，其实这里有一个捷径，来配置你的max_children数， 就是你前期先把max_childnren设置成一个比较大的值，稳定运行一段时间后，观察fpm的status里的 max active processes 是多少，然后把max_children配置比他大一些就ok了。</p>

<p>希望这些文章能给大家有一些帮助。</p>

<p>来自 <a href="http://www.epooll.com/archives/784/">http://www.epooll.com/archives/784/</a></p>

<h3>1. 进程模式和数量配置</h3>
<pre class="chroma"><span class="c1">## 模式选择</span>
<span class="nv">pm</span> <span class="o">=</span> static/dynamic
<span class="c1">## STATIC MODE</span>
生效配置：
pm.max_children<span class="o">(</span>同一时间可存在的最大进程数<span class="o">)</span>

<span class="c1">## DYNAMIC MODE</span>
生效配置：
pm.start_servers<span class="o">(</span>php启动时创建的进程数<span class="o">)</span>
pm.min_spare_servers<span class="o">(</span>处于idle状态下最少的进程数，少于此数会创建进程<span class="o">)</span>
pm.max_spare_servers<span class="o">(</span>处于idle状态下最多的进程数，多于此数会杀掉进程<span class="o">)</span>
pm.max_children<span class="o">(</span>同static中的效果，和pm.max_spare_servers区别在于，后者是设定的idel状态进程数，而前者是配置的所有状态下进程最大数目<span class="o">)</span>
</pre>
<blockquote>
<p>配置文件中的解释说明</p>
<pre class="chroma">; Choose how the process manager will control the number of child processes.
; Possible Values:
;   static  - a fixed number (pm.max_children) of child processes;
;   dynamic - the number of child processes are set dynamically based on the
;             following directives:
;             pm.max_children      - the maximum number of children that can
;                                    be alive at the same time.
;             pm.start_servers     - the number of children created on startup.
;             pm.min_spare_servers - the minimum number of children in &#39;idle&#39;
;                                    state (waiting to process). If the number
;                                    of &#39;idle&#39; processes is less than this
;                                    number then some children will be created.
;             pm.max_spare_servers - the maximum number of children in &#39;idle&#39;
;                                    state (waiting to process). If the number
;                                    of &#39;idle&#39; processes is greater than this
;                                    number then some children will be killed.
; Note: This value is mandatory.
</pre></blockquote>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>