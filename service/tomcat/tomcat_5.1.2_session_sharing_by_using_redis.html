<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/leetcode/binary_tree/easy_108_convert_sorted_array_to_binary_search_tree.html">108. Convert Sorted Array To Binary Search Tree</a>
            </li>
            <li>
              <a href="/leetcode/binary_tree/easy_543_diameter_of_binary_tree.html">543. Diameter Of Binary Tree</a>
            </li>
            <li>
              <a href="/leetcode/binary_tree/easy_101_symmetric_binary_tree.html">101. Symmetric Binary Tree</a>
            </li>
            <li>
              <a href="/leetcode/binary_tree/easy_226_revert_binary_tree.html">226. Revert Binary Tree</a>
            </li>
            <li>
              <a href="/leetcode/binary_tree/easy_104_maximum_depth_of_binary_tree.html">104. Maximum Depth Of Binary Tree</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/leetcode/index.html">leetcode</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/haproxy/index.html">haproxy</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                  <ul>
                    <li><a href="/service/tomcat/tomcat_00_error_startup.html">tomcat: 错误 - 启动问题</a></li>
                    <li><a href="/service/tomcat/tomcat_1.0.0_what_is_jakarta_ee_and_tomcat.html">tomcat 1.0.0 Jakarta EE 和 Tomcat</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.1_config_server_xml.html">tomcat 1.1.1 配置 server.xml 和 context</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.2_config_sercurity.html">tomcat 1.1.2 安全 - 隐藏版本号</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.0_log_cronolog_logrotate.html">tomcat 1.2.0 日志-cronolog日志切割</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.1_log_log4j.html">tomcat 1.2.1 日志-log4j配置相对路径</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.2_log_juli_loglevel.html">tomcat 1.2.2 日志-JULI日志级别</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.0_optimize_apr_mode.html">tomcat 1.3.0 优化-apr模式</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.1_optimize_server_xml.html">tomcat 1.3.1 优化-server.xml</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.2_optimize_test_concurrent_more_than_10000.html">tomcat 1.3.2 优化-如何承载上万并发</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.0_problem_startup_slow_tomcat7.html">tomcat 2.1.0 问题-tomcat7启动速度慢</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.1_entropy_source.html">tomcat 2.1.1 问题-tomcat7启动安全-熵池</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.2_error_shutdown_connection_refuse.html">tomcat 2.1.2 问题-tomcat7 shutdown 提示 connection refused</a></li>
                    <li><a href="/service/tomcat/tomcat_2.2.0_java.lang.ClassCastException.html">tomcat 2.2.0 问题-java.lang.ClassCastException</a></li>
                    <li><a href="/service/tomcat/tomcat_2.2.1_tomcat7_classloader_howto_translate.html">tomcat 2.2.1 tomcat7类加载器HOWTO-中文翻译</a></li>
                    <li><a href="/service/tomcat/tomcat_3.1.0_manage_check_version.html">tomcat 3.1.0 管理-查看tomcat版本</a></li>
                    <li><a href="/service/tomcat/tomcat_3.2.0_tomcat_manager.html">tomcat 3.2.0 tomcat manager</a></li>
                    <li><a href="/service/tomcat/tomcat_4.1.0_application_session_keep_with_memcached.html">tomcat 4.1.0 应用-memcached会话保持</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.0_redis_session_gradle_compile_jar.html">tomcat 5.1.0 gradle编译tomcat-redis-session-manager</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.1_redis_session_gradle_compile_jar_tomcat8.5_and_jdk8.html">tomcat 5.1.0 gradle编译tomcat-redis-session-manager - tomcat8.5</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.2_session_sharing_by_using_redis.html">tomcat: 5.1.2 tomcat-session sharing</a></li>
                    <li><a href="/service/tomcat/tomcat_6.1.0_tomcat6_vs_tomcat7.html">tomcat 6.1.0 tomcat6 和 tomcat7的简要区别</a></li>
                    <li><a href="/service/tomcat/tomcat_7.1.0_running_as_daemon_by_nonroot_jsvc.html">tomcat 7.1.0 使用非root用户用daemon运行tomcat - (jsvc)</a></li>
                    <li><a href="/service/tomcat/tomcat_7.1.1_running_as_daemon_by_nonroot_systemd.html">tomcat 7.1.1 使用非root用户用daemon运行tomcat - (systemd) - 推荐</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>tomcat: 5.1.2 tomcat-session sharing</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>27 Sep 2016</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>1. 环境介绍</h3>

<p><strong>软件版本</strong></p>

<ul>
<li>nginx: 1.10.1</li>
<li>jdk: 6.0.45</li>
<li>tomcat: 6.0.41</li>
<li>redis: 2.8.24</li>
</ul>

<p><strong>软件架构</strong></p>

<table>
<thead>
<tr>
<th align="center">软件名称</th>
<th align="center">HOST</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">nginx</td>
<td align="center">192.168.110.4</td>
</tr>

<tr>
<td align="center">tomcat01</td>
<td align="center">192.168.110.5</td>
</tr>

<tr>
<td align="center">tomcat02</td>
<td align="center">192.168.110.6</td>
</tr>

<tr>
<td align="center">redis</td>
<td align="center">192.168.110.5</td>
</tr>
</tbody>
</table>

<hr />

<h3>2. 安装并配置nginx</h3>

<p>在nginx节点执行以下命令</p>

<h4>1) 安装nginx</h4>
<pre class="chroma">yum install epel-release -y
yum install nginx -y
chkconfig nginx on
</pre>
<h4>2) 配置nginx</h4>
<pre class="chroma"><span class="c1"># 新建nginx虚拟机配置文件</span>
vim /etc/nginx/conf.d/sstest.conf
******************************
upstream ss <span class="o">{</span>
    server 192.168.110.5:8080<span class="p">;</span>
    server 192.168.110.6:8080<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name 192.168.110.4 default_server<span class="p">;</span>
    location / <span class="o">{</span>
        proxy_pass http://ss<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
******************************
service nginx restart
</pre>
<hr />

<h3>3. 安装并配置tomcat</h3>

<p>在两台tomcat节点执行以下命令</p>

<h4>1) 安装tomcat</h4>
<pre class="chroma"><span class="c1"># 下载并安装jdk1.6</span>
<span class="c1"># 需要注册oracle帐号才能在下面下载</span>
http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase6-419409.html
chmod u+x jre-6u45-linux-x64.bin
sh jre-6u45-linux-x64.bin
mv jre1.6.0_45 /usr/local/
ln -s /usr/local/jre1.6.0_45/ /usr/local/jdk
vi /etc/profile.d/java-env.sh
*******************************
<span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/local/jdk
<span class="nv">JRE_HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/jre
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/bin:<span class="si">${</span><span class="nv">JRE_HOME</span><span class="si">}</span>/bin
<span class="nv">CLASSPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/lib:<span class="si">${</span><span class="nv">JRE_HOME</span><span class="si">}</span>/lib
*******************************
<span class="nb">source</span> /etc/profile.d/java-env.sh

<span class="c1"># 安装tomcat</span>
wget http://mirror.rise.ph/apache/tomcat/tomcat-6/v6.0.45/bin/apache-tomcat-6.0.45.tar.gz
tar zxf apache-tomcat-6.0.45.tar.gz
mv apache-tomcat-6.0.45 /usr/local/tomcat
</pre>
<h4>2) 配置tomcat</h4>
<pre class="chroma"><span class="c1"># 配置tomcat虚拟主机</span>
vim /usr/local/tomcat/conf/server.xml
************************
&lt;Host <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span>  <span class="nv">appBase</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
      <span class="nv">unpackWARs</span><span class="o">=</span><span class="s2">&#34;true&#34;</span> <span class="nv">autoDeploy</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>&gt;
  &lt;Context <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nv">docBase</span><span class="o">=</span><span class="s2">&#34;/data/webapps&#34;</span> <span class="nv">reloadable</span><span class="o">=</span><span class="s2">&#34;true&#34;</span> /&gt;
  ......
&lt;/Host&gt;
************************

vim /usr/local/tomcat/conf/context.xml
******************************
    &lt;Valve <span class="nv">className</span><span class="o">=</span><span class="s2">&#34;com.radiadesign.catalina.session.RedisSessionHandlerValve&#34;</span>/&gt;
    &lt;Manager <span class="nv">className</span><span class="o">=</span><span class="s2">&#34;com.radiadesign.catalina.session.RedisSessionManager&#34;</span>
     <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;47.90.80.156&#34;</span>
     <span class="nv">port</span><span class="o">=</span><span class="s2">&#34;6379&#34;</span>
     <span class="nv">password</span><span class="o">=</span><span class="s2">&#34;mypass&#34;</span>
     <span class="nv">database</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>
     <span class="nv">maxInactiveInterval</span><span class="o">=</span><span class="s2">&#34;60&#34;</span>
    /&gt;
******************************
</pre>
<p>Valve要在Manager之前<br />
注意className，网上的都不一样，需要按照自己下载jar包的版本进行调整<br />
其中password配置，是对应redis master中的requirepass配置项配置的密码
其中maxInactiveInterval，配置的是非活动状态最大持续时间，即用户停止操作多长时间停掉session。</p>

<h4>3) 编写测试程序</h4>
<pre class="chroma"><span class="c1"># 创建web程序目录</span>
mkdir -p /data/webapps/<span class="o">{</span>WEB-INF,META-INF,classes,lib<span class="o">}</span>
<span class="nb">cd</span> /data/webapps

<span class="c1"># 编写首页程序</span>
<span class="c1"># ss02上把Tomcat01更换成Tomcat02</span>
vim index.jsp
***********************
&lt;%@ page <span class="nv">language</span><span class="o">=</span><span class="s2">&#34;java&#34;</span> %&gt;
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;Tomcat01&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;&lt;font <span class="nv">color</span><span class="o">=</span><span class="s2">&#34;red&#34;</span>&gt;Tomcat01.magedu.com&lt;/font&gt;&lt;/h1&gt;
    &lt;table <span class="nv">align</span><span class="o">=</span><span class="s2">&#34;centre&#34;</span> <span class="nv">border</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>&gt;
      &lt;tr&gt;
        &lt;td&gt;Session ID&lt;/td&gt;
    &lt;% session.setAttribute<span class="o">(</span><span class="s2">&#34;magedu.com&#34;</span>,<span class="s2">&#34;magedu.com&#34;</span><span class="o">)</span><span class="p">;</span> %&gt;
        &lt;td&gt;&lt;%<span class="o">=</span> session.getId<span class="o">(</span><span class="o">)</span> %&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Created on&lt;/td&gt;
        &lt;td&gt;&lt;%<span class="o">=</span> session.getCreationTime<span class="o">(</span><span class="o">)</span> %&gt;&lt;/td&gt;
     &lt;/tr&gt;
    &lt;/table&gt;
  &lt;/body&gt;
&lt;/html&gt;
***********************
</pre>
<hr />

<h3>4. 安装并配置redis</h3>

<h4>1) 安装redis</h4>
<pre class="chroma">wget http://download.redis.io/releases/redis-2.8.24.tar.gz
tar zxf redis-2.8.24.tar.gz
<span class="nb">cd</span> redis-2.8.24
make
make install
</pre>
<h4>2) 拷贝redis启动脚本</h4>
<pre class="chroma">cp utils/redis_init_script /etc/init.d/redis
chmod <span class="m">755</span> /etc/init.d/redis
vi /etc/init.d/redis
******************************
<span class="c1"># 在第2行添加</span>
<span class="c1">#chkconfig: 2345 80 90</span>

<span class="c1"># 修改配置文件位置</span>
<span class="nv">CONF</span><span class="o">=</span><span class="s2">&#34;</span><span class="s2">/etc/redis/</span><span class="si">${</span><span class="nv">REDISPORT</span><span class="si">}</span><span class="s2">.conf</span><span class="s2">&#34;</span>

<span class="c1"># 如果设置了auth的话，需要在关闭时提供密码字符串</span>
<span class="c1"># 配置一个自定义变量</span>
<span class="nv">AUTH_PASSWORD</span><span class="o">=</span><span class="s2">&#34;123456&#34;</span>
<span class="c1"># 在关闭stop case中增加&#34;-a $AUTH_PASSWORD&#34;</span>
<span class="nv">$CLIEXEC</span> -p <span class="nv">$REDISPORT</span> -a <span class="nv">$AUTH_PASSWORD</span> shutdown
******************************
chkconfig redis on
</pre>
<h4>3) 配置redis</h4>
<pre class="chroma">mkdir /etc/redis
cp redis.conf /etc/redis/6379.conf
vi /etc/redis/6379.conf
******************************
<span class="nb">bind</span> 0.0.0.0
daemonize yes
******************************
</pre>
<h4>4) 拷贝jar包到tomcat</h4>
<pre class="chroma">wget https://raw.githubusercontent.com/xiaotuanyu120/nginx_tomcat_redis_session_jar/master/tomcat6/tomcat-redis-session-manager-1.2.jar
wget https://raw.githubusercontent.com/xiaotuanyu120/nginx_tomcat_redis_session_jar/master/tomcat6/jedis-2.1.0.jar
wget https://raw.githubusercontent.com/xiaotuanyu120/nginx_tomcat_redis_session_jar/master/tomcat6/commons-pool-1.6.jar

mv tomcat-redis-session-manager-1.2.jar jedis-2.1.0.jar commons-pool-1.6.jar /usr/local/tomcat/lib/
</pre>
<p>根据jdk和tomcat版本,需要的jar包完全不一样,不同的jar包版本对应的tomcat Context配置亦不同</p>

<blockquote>
<p><strong>错误经历</strong><br />
按照官方的提示，使用的tomcat-redis-session-manager-1.2-tomcat-6.jar这个发行的包，但是实际使用时，发现主页登录的验证码无法刷出，tomcat报错以下信息：<br />
RedisSession.setAttribute(RedisSession.java:56，按照作者的解释，是因为原key和新key皆为空，产生了空指针错误。<br />
解决办法：<br />
jcoleman给发现这个问题的一个哥们单独修改和编译了一个包，因为tomcat6版本太过老旧，作者没有去更新官方的包，<a href="https://github.com/jcoleman/tomcat-redis-session-manager/issues/13，换成这个页面上下载的包后，问题得到了完整的解决">https://github.com/jcoleman/tomcat-redis-session-manager/issues/13，换成这个页面上下载的包后，问题得到了完整的解决</a></p>
</blockquote>

<h4>5) 启动redis、重启tomcat服务</h4>
<pre class="chroma">service redis start

<span class="c1"># 在两个tomcat节点上重启tomcat</span>
/usr/local/tomcat/bin/catalina.sh stop
/usr/local/tomcat/bin/catalina.sh start
</pre>
<hr />

<h3>5. 效果测试</h3>
<pre class="chroma"><span class="c1"># 分别访问tomca01和tomcat02</span>
curl -I http://47.90.80.156:8080/
HTTP/1.1 <span class="m">200</span> OK
Server: Apache-Coyote/1.1
Set-Cookie: <span class="nv">JSESSIONID</span><span class="o">=</span>7E548773A2181763F25C709490677B41<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
Content-Type: text/html
Content-Length: <span class="m">370</span>
Date: Tue, <span class="m">27</span> Sep <span class="m">2016</span> 08:32:06 GMT

curl -I http://47.90.80.167:8080/
HTTP/1.1 <span class="m">200</span> OK
Server: Apache-Coyote/1.1
Set-Cookie: <span class="nv">JSESSIONID</span><span class="o">=</span>2E10147173A1565E1BAA79D766A29410<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
Content-Type: text/html
Content-Length: <span class="m">370</span>
Date: Tue, <span class="m">27</span> Sep <span class="m">2016</span> 08:32:29 GMT

<span class="c1"># 负载均衡端访问</span>
web端访问，session值统一
</pre>
    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>