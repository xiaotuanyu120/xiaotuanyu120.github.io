<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/network_tcp-reset.html">网络: TCP - RST简介</a>
            </li>
            <li>
              <a href="/linux/shell/shell_1.0.4_variable_string.html">SHELL: 1.0.4 变量：字符串及字符串切片</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.4_start_init.html">GO 1.1.4 入口函数和包初始化</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.3_build.html">GO 1.1.3 构建应用</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.2_proj_struct.html">GO 1.1.2 目录结构</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
              <ul>
                <li>
                  <a href="/linux/advance/index.html">advance</a>
                </li>
                <li>
                  <a href="/linux/basic/index.html">basic</a>
                  <ul>
                    <li><a href="/linux/basic/01.1.0_linux简介.html">1.1.0: linux简介</a></li>
                    <li><a href="/linux/basic/01.2.0_vmware+C6系统安装.html">1.2.0: vmware+C6系统安装</a></li>
                    <li><a href="/linux/basic/02.1.0_network-config.html">2.1.0: 网络-基本配置</a></li>
                    <li><a href="/linux/basic/02.1.1_network-C6-check-gateway-info.html">2.1.1: 网络 - 静态路由及网关</a></li>
                    <li><a href="/linux/basic/02.1.2_network-bonding.html">2.1.2: 网络-bonding</a></li>
                    <li><a href="/linux/basic/02.1.3_network_resolv.conf.html">2.1.3: 网络-resolv.conf</a></li>
                    <li><a href="/linux/basic/02.2.0_yum_repo.html">2.2.0: yum源管理</a></li>
                    <li><a href="/linux/basic/02.3.0_linux-runlevel.html">2.3.0: linux-runlevel</a></li>
                    <li><a href="/linux/basic/02.4.0_ssh-tool-putty.html">2.4.0: ssh工具-putty</a></li>
                    <li><a href="/linux/basic/02.5.0_openSSH-密钥登陆.html">2.5.0: openSSH-密钥登陆</a></li>
                    <li><a href="/linux/basic/02.6.0_修改主机名.html">2.6.0: 修改主机名</a></li>
                    <li><a href="/linux/basic/03.1.0_单用户及救援模式.html">3.1.0: 单用户及救援模式</a></li>
                    <li><a href="/linux/basic/03.2.0_启动流程+目录结构.html">3.2.0: 启动流程+目录结构</a></li>
                    <li><a href="/linux/basic/03.3.0_basic_command-start.html">3.3.0: 基础命令 - 入门</a></li>
                    <li><a href="/linux/basic/04.1.0_basic_command-about-file.html">4.1.0: 基础命令 - 文件相关</a></li>
                    <li><a href="/linux/basic/04.2.0_basic_command-about-file-prop-and-perm.html">4.2.0: 基础命令 - 文件属性和权限相关</a></li>
                    <li><a href="/linux/basic/04.3.0_basic_command-about-shell.html">4.3.0: 基础命令 - shell基础</a></li>
                    <li><a href="/linux/basic/05.1.0_basic_command-special-perm.html">5.1.0: 基础命令 - 文件特殊权限</a></li>
                    <li><a href="/linux/basic/05.1.1_basic_command-sbit-practice.html">5.1.1: 基础命令 - 特殊权限sbit实践</a></li>
                    <li><a href="/linux/basic/05.2.0_basic_command-file-stat-check.html">5.2.0: 基础命令 - 文件类型查看</a></li>
                    <li><a href="/linux/basic/05.2.1_basic_command-file-locate.html">5.2.1: 基础命令 - 文件定位（find）</a></li>
                    <li><a href="/linux/basic/05.2.2-basic_command-file-locate-mtimen-study.html">5.2.2: 基础命令 - find中mtime n的实践</a></li>
                    <li><a href="/linux/basic/05.3.0_basic_command-soft-link-and-hard-link.html">5.3.0: 基础命令 - 软链接 和 硬链接</a></li>
                    <li><a href="/linux/basic/06.1.0_用户-配置文件.html">6.1.0: 用户-配置文件</a></li>
                    <li><a href="/linux/basic/06.2.0_用户-相关命令.html">6.2.0: 用户-相关命令</a></li>
                    <li><a href="/linux/basic/06.3.0_用户-su_sudo.html">6.3.0: 用户-su/sudo</a></li>
                    <li><a href="/linux/basic/07.1.0_disk_management-basic-info-and-command.html">7.1.0: 磁盘管理 - 基本知识和常用命令</a></li>
                    <li><a href="/linux/basic/07.2.0_disk_management-partition-command.html">7.2.0: 磁盘管理 - 分区工具 fdisk,parted</a></li>
                    <li><a href="/linux/basic/07.3.0_磁盘管理-格式化.html">7.3.0: 磁盘管理-格式化</a></li>
                    <li><a href="/linux/basic/07.4.0_磁盘管理-挂载.html">7.4.0: 磁盘管理-挂载</a></li>
                    <li><a href="/linux/basic/07.5.0_disk_management-lvm.html">7.5.0: 磁盘管理-lvm</a></li>
                    <li><a href="/linux/basic/07.6.0_磁盘管理-其他.html">7.6.0: 磁盘管理-其他</a></li>
                    <li><a href="/linux/basic/08.1.0_编辑工具-vi_vim.html">8.1.0: 编辑工具-vi&vim</a></li>
                    <li><a href="/linux/basic/09.1.0_archive_compress_command-basic.html">9.1.0: 打包压缩命令 - tar,gzip,bzip2,xz等</a></li>
                    <li><a href="/linux/basic/09.2.0_archive_compress_command-practice-study.html">9.2.0: 打包压缩命令 - 实践研究</a></li>
                    <li><a href="/linux/basic/09.2.1_command-dd.html">9.2.1: 命令 - dd</a></li>
                    <li><a href="/linux/basic/10.1.0_software_install-introduce.html">10.1.0: 软件安装-简介</a></li>
                    <li><a href="/linux/basic/10.2.0_software_install-sourcecode.html">10.2.0: 软件安装-源码安装</a></li>
                    <li><a href="/linux/basic/10.2.1_software_install-related-commands.html">10.2.1: 软件安装-相关命令wget</a></li>
                    <li><a href="/linux/basic/10.2.2_software_install-upgrade-gcc.html">10.2.2: 软件安装-升级gcc</a></li>
                    <li><a href="/linux/basic/10.3.0_software_install-rpm-tools.html">10.3.0: 软件安装-rpm</a></li>
                    <li><a href="/linux/basic/10.4.0_software-install-yum-tools.html">10.4.0: 软件安装-yum</a></li>
                    <li><a href="/linux/basic/11.01.0_shell_basic-bash-basic.html">11.1.0: shell基础-bash basic</a></li>
                    <li><a href="/linux/basic/11.02.0_shell_basic-wild_cards_and_output_redirect.html">11.2.0: shell基础-通配符&重定向</a></li>
                    <li><a href="/linux/basic/11.03.0_shell_basic-task-management.html">11.3.0: shell基础-任务管理(kill/ps)</a></li>
                    <li><a href="/linux/basic/11.04.0_shell_basic-variable_check.html">11.4.0: shell基础-变量查看(echo)</a></li>
                    <li><a href="/linux/basic/11.05.0_shell_basic-variable_set_and_unset.html">11.5.0: shell基础-变量声明&取消</a></li>
                    <li><a href="/linux/basic/11.06.0_shell_basic-global-variable.html">11.6.0: shell基础-全局变量</a></li>
                    <li><a href="/linux/basic/11.07.0_shell_basic-bash_env.html">11.7.0: shell基础-环境变量</a></li>
                    <li><a href="/linux/basic/11.08.0_shell_basic-pipe-related.html">11.8.0: shell基础-管道相关命令(cut/sort/uniq/tee/split/xargs)</a></li>
                    <li><a href="/linux/basic/11.09.0_shell_basic-and-or-logic.html">11.9.0: shell基础-与或逻辑操作符</a></li>
                    <li><a href="/linux/basic/11.10.0_shell_basic-array.html">11.10.0: shell基础-数组</a></li>
                    <li><a href="/linux/basic/12.1.0_regex_basic-expression.html">12.1.0: 正则基础-编码符号含义</a></li>
                    <li><a href="/linux/basic/12.2.0_regex_basic-grep.html">12.2.0: 正则基础-grep</a></li>
                    <li><a href="/linux/basic/12.3.0_regex_basic-sed.html">12.3.0: 正则基础-sed</a></li>
                    <li><a href="/linux/basic/12.3.1_regex_example-sed-delete-n-line-around.html">12.3.1: 正则基础-sed删除前后n行</a></li>
                    <li><a href="/linux/basic/12.3.2_regex_example-sed-advance.html">12.3.2: 正则基础-sed高级用法</a></li>
                    <li><a href="/linux/basic/12.4.0_regex_basic-awk.html">12.4.0: 正则基础-awk</a></li>
                    <li><a href="/linux/basic/13.1.0_shell_script-introduction.html">13.1.0: 脚本基础-什么是脚本</a></li>
                    <li><a href="/linux/basic/13.2.0_shell_script-date.html">13.2.0: 脚本基础-date用法</a></li>
                    <li><a href="/linux/basic/13.3.0_shell_script-var-and-caculate.html">13.3.0: 脚本基础-变量及计算</a></li>
                    <li><a href="/linux/basic/13.4.0_shell_script-gen-random-number.html">13.4.0: 脚本基础-随机数生成</a></li>
                    <li><a href="/linux/basic/13.5.0_shell_script_logic-basic.html">13.5.0: 脚本逻辑基础-逻辑判断标识含义</a></li>
                    <li><a href="/linux/basic/14.1.0_shell_script_logic-if-case.html">14.1.0: 脚本逻辑基础-流程控制-条件判断if/case</a></li>
                    <li><a href="/linux/basic/14.2.0_shell_script_logic-function.html">14.2.0: 脚本逻辑基础-功能抽象-function</a></li>
                    <li><a href="/linux/basic/14.3.0_shell_script_logic-loop.html">14.3.0: 脚本逻辑基础-流程控制-循环语句</a></li>
                    <li><a href="/linux/basic/14.4.0_shell_script_logic-example.html">14.4.0: 脚本基础-example</a></li>
                    <li><a href="/linux/basic/15.1.0_脚本示例-报警系统.html">15.1.0: 脚本示例-报警系统</a></li>
                    <li><a href="/linux/basic/15.1.1_脚本示例-报警系统py.html">15.1.0: 脚本示例-报警系统py</a></li>
                    <li><a href="/linux/basic/16.1.0_文件分发-expect+rsync.html">16.1.0: 文件分发 expect & rsync</a></li>
                    <li><a href="/linux/basic/17.1.0_系统管理-系统负载.html">17.1.0: 系统管理-系统负载</a></li>
                    <li><a href="/linux/basic/17.2.0_系统管理-内存管理.html">17.2.0: 系统管理-内存管理</a></li>
                    <li><a href="/linux/basic/17.3.0_系统管理-top工具.html">17.3.0: 系统管理-top工具</a></li>
                    <li><a href="/linux/basic/17.4.0_系统管理-sar.html">17.4.0: 系统管理-sar</a></li>
                    <li><a href="/linux/basic/17.5.0_系统管理-ps.html">17.5.0: 系统管理-ps</a></li>
                    <li><a href="/linux/basic/17.6.0_系统管理-netstat.html">17.6.0: 系统管理-netstat</a></li>
                    <li><a href="/linux/basic/17.7.0_实例-线程资源占用.html">17.7.0: 实例-线程资源占用</a></li>
                    <li><a href="/linux/basic/18.1.0_package_capture_tcpdump.html">18.1.0: 网络抓包 - tcpdump</a></li>
                    <li><a href="/linux/basic/18.1.0_package_capture_wireshark.html">18.1.0: 网络抓包 - wireshark</a></li>
                    <li><a href="/linux/basic/18.2.0_安全管理-selinux.html">18.2.0: 安全管理-selinux</a></li>
                    <li><a href="/linux/basic/18.3.0_计划任务-crontab.html">18.3.0: 计划任务-crontab</a></li>
                    <li><a href="/linux/basic/18.4.0_防火墙-iptables.html">18.4.0: 防火墙-iptables</a></li>
                    <li><a href="/linux/basic/19.1.0_服务管理-服务介绍.html">19.1.0: 服务管理-服务介绍</a></li>
                    <li><a href="/linux/basic/19.2.0_服务管理-ntsysv.html">19.2.0: 服务管理-ntsysv</a></li>
                    <li><a href="/linux/basic/19.3.0_服务管理-chkconfig.html">19.3.0: 服务管理-chkconfig</a></li>
                    <li><a href="/linux/basic/19.4.0_日志管理-日志介绍.html">19.4.0: 日志管理-日志介绍</a></li>
                    <li><a href="/linux/basic/19.5.0_虚拟终端-screen.html">19.5.0: 虚拟终端-screen</a></li>
                    <li><a href="/linux/basic/19.6.0_网络工具-基本介绍.html">19.6.0: 网络工具-基本介绍</a></li>
                    <li><a href="/linux/basic/20.1.0_网络管理-_etc_hosts.html">20.1.0: 网络管理-/etc/hosts</a></li>
                    <li><a href="/linux/basic/20.2.0_同步工具-rsync.html">20.2.0: 同步工具 rsync</a></li>
                    <li><a href="/linux/basic/24.1.0_扩展模块-基础介绍.html">24.1.0: 扩展模块-基础介绍</a></li>
                    <li><a href="/linux/basic/24.2.0_扩展模块-bz2.html">24.2.0: 扩展模块-bz2</a></li>
                    <li><a href="/linux/basic/24.3.0_扩展模块-memcache.html">24.3.0: 扩展模块-memcache</a></li>
                    <li><a href="/linux/basic/24.4.0_扩展模块-mysqli.html">24.4.0: 扩展模块-mysqli</a></li>
                    <li><a href="/linux/basic/24.5.0_扩展模块-pdo-mysql.html">24.5.0: 扩展模块-pdo-mysql</a></li>
                    <li><a href="/linux/basic/24.6.0_扩展模块-初始化错误.html">24.6.0: 扩展模块-初始化错误</a></li>
                    <li><a href="/linux/basic/24.7.0_扩展模块_redis.html">24.7.0: 扩展模块-redis</a></li>
                    <li><a href="/linux/basic/25.1.0_LNMP_install.html">LNMP: 安装+配置+启动脚本</a></li>
                    <li><a href="/linux/basic/25.2.0_LNMP-PHP安装.html">25.2.0: LNMP-PHP安装</a></li>
                    <li><a href="/linux/basic/25.3.0_LNMP-nginx安装.html">25.3.0: LNMP-nginx安装</a></li>
                    <li><a href="/linux/basic/25.5.0_LNMP-nginx启动报错.html">25.5.0: LNMP-nginx启动报错</a></li>
                    <li><a href="/linux/basic/25.6.0_LNMP-discuz安装.html">25.6.0: LNMP-discuz安装</a></li>
                    <li><a href="/linux/basic/25.7.0_LNMP-扩展ldd命令.html">25.7.0: LNMP-扩展ldd命令</a></li>
                    <li><a href="/linux/basic/26.1.0_nginx启动脚本.html">26.1.0: nginx启动脚本</a></li>
                    <li><a href="/linux/basic/26.10.0_NGINX配置-NGX_PHP状态页面.html">26.10.0: NGINX配置-NGX&PHP状态页面</a></li>
                    <li><a href="/linux/basic/26.11.0_NGINX配置-limit_req访问限制配置.html">26.11.0: NGINX配置-limit_req访问限制配置</a></li>
                    <li><a href="/linux/basic/26.2.0_NGINX配置-基本.html">26.2.0: NGINX配置-基本</a></li>
                    <li><a href="/linux/basic/26.3.0_NGINX配置-虚拟主机.html">26.3.0: NGINX配置-虚拟主机</a></li>
                    <li><a href="/linux/basic/26.4.0_NGINX配置-auth.html">26.4.0: NGINX配置-auth</a></li>
                    <li><a href="/linux/basic/26.5.0_NGINX配置-访问控制.html">26.5.0: NGINX配置-访问控制</a></li>
                    <li><a href="/linux/basic/26.6.0_NGINX配置-重定向_防盗链.html">26.6.0: NGINX配置-重定向&防盗链</a></li>
                    <li><a href="/linux/basic/26.7.0_NGINX配置-日志_切割脚本.html">26.7.0: NGINX配置-日志&切割脚本</a></li>
                    <li><a href="/linux/basic/26.8.0_NGINX配置-refer过滤.html">26.8.0: NGINX配置-refer过滤</a></li>
                    <li><a href="/linux/basic/26.9.0_NGINX配置-原地rewrite.html">26.9.0: NGINX配置-原地rewrite</a></li>
                    <li><a href="/linux/basic/27.1.0_nfs_intro.html">27.1.0: NFS简介</a></li>
                    <li><a href="/linux/basic/27.1.1_nfs_installation.html">27.1.1: NFS安装</a></li>
                    <li><a href="/linux/basic/27.1.2_nfs_command.html">27.1.2: NFS使用命令</a></li>
                    <li><a href="/linux/basic/28.1.0_samba-简介.html">28.1.0: samba-简介</a></li>
                    <li><a href="/linux/basic/28.2.0_samba-配置share共享.html">28.2.0: samba-配置share共享</a></li>
                    <li><a href="/linux/basic/28.3.0_samba-配置user共享.html">28.3.0: samba-配置user共享</a></li>
                    <li><a href="/linux/basic/28.4.0_samba-smbtree命令.html">28.4.0: samba-smbtree命令</a></li>
                    <li><a href="/linux/basic/28.5.0_squid_intro.html">28.5.0: squid简介</a></li>
                    <li><a href="/linux/basic/28.5.1_squid_installation.html">28.5.1: squid 安装</a></li>
                    <li><a href="/linux/basic/28.5.2_squid_acl.html">28.5.2: squid acl说明</a></li>
                    <li><a href="/linux/basic/28.5.3_squid_reverse_proxy.html">28.5.3: squid反向代理</a></li>
                    <li><a href="/linux/basic/28.5.4_squid_transparent_proxy.html">28.5.0: squid</a></li>
                    <li><a href="/linux/basic/29.0.0_tomcat_and_resin.html">29.0.0: tomcat and resin</a></li>
                    <li><a href="/linux/basic/30.0.0_mysql_master_slave.html">30.0.0: mysql主从同步</a></li>
                    <li><a href="/linux/basic/31.1.0_DNS.html">31.1.0: DNS服务</a></li>
                    <li><a href="/linux/basic/32.0.0_iredmail.html">32.0.0 IREDMAIL</a></li>
                    <li><a href="/linux/basic/33.0.0_heartbeat.html">33.0: heartbeat</a></li>
                    <li><a href="/linux/basic/34.0.0_lvs.html">34.0.0: lvs简介</a></li>
                    <li><a href="/linux/basic/34.1.0_keepalive.html">34.1.0: keepalive</a></li>
                    <li><a href="/linux/basic/34.2.0_lvs扩展资料.html">34.2.0: lvs扩展资料</a></li>
                    <li><a href="/linux/basic/37.0.0_monitor_software.html">37.0.0: 监控软件 - nagios,zabbix</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/linux/desktop/index.html">desktop</a>
                </li>
                <li>
                  <a href="/linux/monitoring/index.html">monitoring</a>
                </li>
                <li>
                  <a href="/linux/other/index.html">other</a>
                </li>
                <li>
                  <a href="/linux/service/index.html">service</a>
                </li>
                <li>
                  <a href="/linux/shell/index.html">shell</a>
                </li>
                <li>
                  <a href="/linux/tools/index.html">tools</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>16.1.0: 文件分发 expect & rsync</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>24 Dec 2014</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>1. expect基础</h3>

<h4>1) 学习目的</h4>

<p>前提：知道目标机器的帐号密码；<br />
操作：自动登录（可用密钥取代此过程）、远程执行命令、远程同步文件</p>

<h4>2) 基础命令安装</h4>

<p>expect命令安装：<code>yum install -y expect</code><br />
ssh命令安装：<code>yum install -y openssh-clients</code></p>

<h4>3) 扩展命令或选项作用解释</h4>

<p><em>仅有spawn是命令</em></p>

<p><strong>timeout</strong><br />
我们可以通过设置给timeout一个值（代表秒数）或者一个动作（可以不给出）来使得expect命令未寻找到关键字段情况发生时，告诉脚本如何处理此情况。</p>

<blockquote>
<p>man page description<br />
The pattern timeout introduces a timeout (in seconds) and action that is executed after no characters have been read for a given time. The timeout pattern applies to the most recently specified process. There is no default timeout. The special variable &ldquo;timeout&rdquo; (used by the expect command) has no affect on this timeout.</p>
</blockquote>

<p><strong>spawn</strong><br />
给进程一个spawn id，就像开了一个专属的tty给spawn用于执行该进程。</p>

<blockquote>
<p>man page description<br />
returns the UNIX process id. If no process is spawned, 0 is returned.
Internally, spawn uses a pty, initialized the same way as the user&rsquo;s tty.</p>
</blockquote>

<p><strong>exp_continue [-continue_timer]</strong><br />
此命令允许expect自己循环执行，而并不是按照默认的模式执行。默认情况下exp_continue会重置timeout的定时器，但是如果我们同时使用了-continue_timer的话，exp_continue就不会重置timeout定时器了。</p>

<blockquote>
<p>man page description<br />
The command exp_continue allows expect itself to continue executing rather than returning as it normally would. By default exp_continue resets the timeout timer. The -continue_timer flag prevents timer from being restarted. (Seeexpect for more information.)</p>
</blockquote>

<p><strong>interact [string1 body1] &hellip; [stringn [bodyn]]</strong><br />
此命令将当前进程的控制权交给用户，允许用户键盘敲出的字符传送给当前进程，而进程产生的错误输出和标准输出会传递到当前屏幕</p>

<blockquote>
<p>man page description<br />
gives control of the current process to the user, so that keystrokes are sent to the current process, and the stdout and stderr of the current process are returned.</p>
</blockquote>

<p><strong>EOF</strong><br />
有时候我们会用expect侦测这个返回值，此返回值代表的含义是当前进程已经执行到end-of-file。（就像timeout到时间了以后会返回timeout，eof就是一个进程执行状态返回值）</p>

<blockquote>
<p>man page description<br />
The pattern eof introduces an action that is executed upon end-of-file. A separate eof pattern may also follow the -outputflag in which case it is matched if an eof is detected while writing output. The default eof action is &ldquo;return&rdquo;, so that interactsimply returns upon any EOF.</p>
</blockquote>

<h4>4) 实例演示</h4>

<p><strong>自动登录脚本内容（登录完毕后等待交互）</strong></p>
<pre class="chroma"><span class="cp">#!/usr/bin/expect
</span><span class="cp"></span><span class="c1"># Program</span>
<span class="c1">#       used for auto login</span>
<span class="c1"># Author : Zhao Peiwu</span>
<span class="c1"># Date : 25/12/2014</span>

<span class="nb">set</span> user <span class="o">[</span>lindex <span class="nv">$argv</span> 0<span class="o">]</span>
<span class="c1"># [lindex $argv 0]相当于shell中的$1</span>
<span class="nb">set</span> host <span class="o">[</span>lindex <span class="nv">$argv</span> 1<span class="o">]</span>
<span class="c1"># 把第二个参数赋值给host，即ip地址</span>
<span class="nb">set</span> passwd <span class="s2">&#34;your passwd&#34;</span>
spawn ssh <span class="nv">$user</span>@<span class="nv">$host</span>
expect <span class="o">{</span>
<span class="s2">&#34;yes/no&#34;</span> <span class="o">{</span>send <span class="s2">&#34;yes&#34;</span><span class="o">}</span>
<span class="c1"># expect查询到&#34;yes/no&#34;字符串，然后发送&#34;yes&#34;</span>

<span class="s2">&#34;password:&#34;</span> <span class="o">{</span>send <span class="s2">&#34;</span><span class="nv">$passwd</span><span class="s2">\r</span><span class="s2">&#34;</span><span class="o">}</span>
<span class="c1"># 发送passwd变量的值和\r（回车键，但不换行）</span>
<span class="o">}</span>
interact
<span class="c1"># 登录成功后保持交互状态</span>
</pre>
<p><strong>执行结果</strong></p>
<pre class="chroma"><span class="c1"># 传递参数&#34;root&#34;和IP进入expect脚本</span>
<span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># expect login.exp root 192.168.0.30</span>    
spawn ssh root@192.168.0.30
root@192.168.0.30<span class="se">\&#39;</span>s password:
Last login: Thu Dec <span class="m">25</span> 11:36:09 <span class="m">2014</span> from web01.gateway.2wire.net
<span class="c1"># 正常登入</span>
</pre>
<p><strong>自动登录脚本内容（登陆后，执行命令然后退出）</strong></p>
<pre class="chroma"><span class="cp">#!/usr/bin/expect
</span><span class="cp"></span><span class="c1"># Program</span>
<span class="c1">#       used for auto login</span>
<span class="c1"># Author : Zhao Peiwu</span>
<span class="c1"># Date : 25/12/2014</span>

<span class="nb">set</span> user <span class="o">[</span>lindex <span class="nv">$argv</span> 0<span class="o">]</span>
<span class="nb">set</span> host <span class="o">[</span>lindex <span class="nv">$argv</span> 1<span class="o">]</span>
<span class="nb">set</span> passwd <span class="s2">&#34;sudoroot88&#34;</span>
<span class="c1">#set timeout 10</span>
spawn ssh <span class="nv">$user</span>@<span class="nv">$host</span>
expect <span class="o">{</span>
<span class="s2">&#34;yes/no&#34;</span> <span class="o">{</span>send <span class="s2">&#34;yes&#34;</span><span class="o">}</span>
<span class="s2">&#34;password:&#34;</span> <span class="o">{</span>send <span class="s2">&#34;</span><span class="nv">$passwd</span><span class="s2">\r</span><span class="s2">&#34;</span><span class="o">}</span>
<span class="c1"># 要把exp_continue去掉，否则退出会有延迟</span>
<span class="o">}</span>
expect <span class="s2">&#34;]*&#34;</span>
<span class="c1"># 执行命令靠这个匹配到待输入命令状态，然后后面可以send命令字符串</span>
send <span class="s2">&#34;exit\r&#34;</span>
<span class="c1"># 传送&#34;exit\r&#34;到进程</span>
</pre>
<p><strong>执行结果</strong></p>
<pre class="chroma"><span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># expect login.exp root 192.168.0.30</span>
spawn ssh root@192.168.0.30
root@192.168.0.30<span class="se">\&#39;</span>s password:
Last login: Thu Dec <span class="m">25</span> 13:45:29 <span class="m">2014</span> from web01.gateway.2wire.net
<span class="o">[</span>root@web02 ~<span class="o">]</span><span class="c1"># [root@web01 expect]#</span>
<span class="c1"># 立刻退出</span>
</pre>
<p><strong>exp_continue的效果（为了看到效果，特意把密码弄成错误的）</strong>
<strong>脚本内容</strong></p>
<pre class="chroma"><span class="cp">#!/usr/bin/expect
</span><span class="cp"></span><span class="c1"># Program</span>
<span class="c1">#       used for auto login</span>
<span class="c1"># Author : Zhao Peiwu</span>
<span class="c1"># Date : 25/12/2014</span>

<span class="nb">set</span> user <span class="o">[</span>lindex <span class="nv">$argv</span> 0<span class="o">]</span>
<span class="nb">set</span> host <span class="o">[</span>lindex <span class="nv">$argv</span> 1<span class="o">]</span>
<span class="nb">set</span> passwd <span class="s2">&#34;wrong passwd&#34;</span>
<span class="nb">set</span> timeout <span class="m">10</span>
spawn ssh <span class="nv">$user</span>@<span class="nv">$host</span>
expect <span class="o">{</span>
<span class="s2">&#34;yes/no&#34;</span> <span class="o">{</span>send <span class="s2">&#34;yes&#34;</span><span class="o">}</span>
<span class="s2">&#34;password:&#34;</span> <span class="o">{</span>send <span class="s2">&#34;</span><span class="nv">$passwd</span><span class="s2">\r</span><span class="s2">&#34;</span><span class="p">;</span>exp_continue<span class="o">}</span>
<span class="c1"># timeout到期了以后expect会重新传递passwd的值</span>
<span class="o">}</span>
interact
</pre>
<p><strong>执行结果</strong></p>
<pre class="chroma"><span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># expect login.exp root 192.168.0.30</span>
spawn ssh root@192.168.0.30
root@192.168.0.30<span class="se">\&#39;</span>s password:
Permission denied, please try again.
<span class="c1"># 因为是错误密码，所以登录失败，然后timeout到期后本应该退出，但因为有exp_continue的存在，所以继续循环执行</span>
root@192.168.0.30<span class="se">\&#39;</span>s password:             
Permission denied, please try again.
root@192.168.0.30<span class="se">\&#39;</span>s password:
Permission denied <span class="o">(</span>publickey,gssapi-keyex,gssapi-with-mic,password<span class="o">)</span>.
spawn_id: spawn id exp4 not open
    <span class="s1">&#39;while executing&#39;</span>
<span class="s2">&#34;interact&#34;</span>
    <span class="o">(</span>file <span class="s2">&#34;login.exp&#34;</span> line 16<span class="o">)</span>
</pre>
<hr />

<h3>2. rsync</h3>

<h4>1) 作用：</h4>

<p>一个快速、多功能、远程（含本地）的文件拷贝工具</p>

<blockquote>
<p>man page description<br />
a fast, versatile, remote (and local) file-copying tool</p>
</blockquote>

<h4>2) 语法：</h4>

<p><code>rsync [参数] 源文件(可远程) 目标文件(可远程)</code></p>

<blockquote>
<p>man page description<br />
 Pull: <code>rsync [OPTION&hellip;] [USER@]HOST:SRC&hellip; [DEST]</code><br />
 Push: <code>rsync [OPTION&hellip;] SRC&hellip; [USER@]HOST:DEST</code></p>
</blockquote>

<h4>3) 参数：</h4>

<ul>
<li>&rdquo;-a&rdquo; 存档模式，相当于-rlptgoD所有参数的集合<br />
&gt; man page description<br />
&ndash;archive     archive mode; equals -rlptgoD (no -H,-A,-X)<br />
</li>
<li>&rdquo;-v&rdquo; 增量拷贝<br />
&gt; man page description<br />
&ndash;verbose    increase verbosity<br />
&rdquo;&ndash;files-from&rdquo; 指定filelist</li>
</ul>

<h4>4) 实例演示：</h4>

<p><strong>源文件及目标文件所在机器必须同时安装了rsync命令才可执行</strong></p>
<pre class="chroma"><span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># rsync -av /root/shell root@192.168.0.30:/tmp</span>
root@192.168.0.30<span class="se">\&#39;</span>s password:
bash: rsync: <span class="nb">command</span> not found
<span class="c1"># 为啥会报错? 因为我在目标机器上把rsync命令卸载掉了</span>
rsync: connection unexpectedly closed <span class="o">(</span><span class="m">0</span> bytes received so far<span class="o">)</span> <span class="o">[</span>sender<span class="o">]</span>
rsync error: error in rsync protocol data stream <span class="o">(</span>code 12<span class="o">)</span> at io.c<span class="o">(</span>600<span class="o">)</span> <span class="o">[</span><span class="nv">sender</span><span class="o">=</span>3.0.6<span class="o">]</span>


<span class="c1"># 赶快把目标机器上的rsync命令安装上（yum install -y rsync)</span>
<span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># rsync -av /root/shell root@192.168.0.30:/tmp</span>
root@192.168.0.30<span class="se">\&#39;</span>s password:
sending incremental file list
shell/
shell/expect/
shell/expect/login.exp

sent <span class="m">408</span> bytes  received <span class="m">39</span> bytes  99.33 bytes/sec
total size is <span class="m">280</span>  speedup is 0.63
</pre>
<p><strong>用脚本来自动同步文件</strong><br />
<strong>脚本内容</strong></p>
<pre class="chroma"><span class="cp">#!/usr/bin/expect
</span><span class="cp"></span><span class="c1"># Program</span>
<span class="c1"># rsync auto archive file to the other machine</span>
<span class="c1"># Author : Zhao Peiwu</span>
<span class="c1"># Date : 25/12/2014</span>

<span class="nb">set</span> user <span class="o">[</span>lindex <span class="nv">$argv</span> 0<span class="o">]</span>
<span class="nb">set</span> host <span class="o">[</span>lindex <span class="nv">$argv</span> 1<span class="o">]</span>
<span class="nb">set</span> passwd <span class="s2">&#34;your password&#34;</span>
spawn rsync -av /root/shell <span class="nv">$user</span>@<span class="nv">$host</span>:/root/shell
expect <span class="o">{</span>
<span class="s2">&#34;yes/no&#34;</span> <span class="o">{</span>send <span class="s2">&#34;yes\r&#34;</span><span class="o">}</span>
<span class="s2">&#34;password&#34;</span> <span class="o">{</span>send <span class="s2">&#34;</span><span class="nv">$passwd</span><span class="s2">\r</span><span class="s2">&#34;</span><span class="o">}</span>
<span class="o">}</span>
expect eof
</pre>
<p><strong>执行过程</strong></p>
<pre class="chroma"><span class="c1"># web02上没有/root/shell的情况</span>
<span class="o">[</span>root@web02 expect<span class="o">]</span><span class="c1"># ls -d /root/shell</span>
ls: cannot access /root/shell: No such file or directory

<span class="c1"># web01上再次运行</span>
<span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># expect rsync.expect root 192.168.0.30</span>
spawn rsync -av /root/shell root@192.168.0.30:/root/shell
root@192.168.0.30<span class="se">\&#39;</span>s password:
sending incremental file list
created directory /root/shell
<span class="c1"># 不存在的shell文件夹被创建了，可是只能创建一层目录</span>
shell/
shell/expect/
shell/expect/login.exp
shell/expect/rsync.expect

sent <span class="m">799</span> bytes  received <span class="m">58</span> bytes  1714.00 bytes/sec
total size is <span class="m">602</span>  speedup is 0.70
</pre>
<hr />

<h3>3. 构建文件分发系统</h3>

<h4>1) 需求背景</h4>

<p>对于大公司而言，肯定时不时会有网站或者配置文件更新，而且使用的机器肯定也是好多台，少则几台，多则几十甚至上百台。所以，自动同步文件是至关重要的。</p>

<h4>2) 实现思路</h4>

<p>首先要有一台模板机器，把要分发的文件准备好，然后只要使用expect脚本批量把需要同步的文件分发到目标机器即可。</p>

<h4>3) 核心命令</h4>

<p><code>rsync -av &ndash;files-from=list.txt  /  root@host:/</code></p>

<h4>4) 文件分发系统的实现</h4>

<p>从filelist中获取文件路径，然后通过rsync同步</p>

<p><strong>脚本内容</strong></p>
<pre class="chroma"><span class="cp">#!/usr/bin/expect
</span><span class="cp"></span><span class="c1"># Program</span>
<span class="c1"># rsync auto archive file to the other machine</span>
<span class="c1"># Author : Zhao Peiwu</span>
<span class="c1"># Date : 25/12/2014</span>

<span class="nb">set</span> user <span class="o">[</span>lindex <span class="nv">$argv</span> 0<span class="o">]</span>
<span class="nb">set</span> host <span class="o">[</span>lindex <span class="nv">$argv</span> 1<span class="o">]</span>
<span class="nb">set</span> passwd <span class="s2">&#34;your password&#34;</span>
<span class="nb">set</span> file <span class="o">[</span>lindex <span class="nv">$argv</span> 2<span class="o">]</span>
spawn rsync -av --files-from<span class="o">=</span><span class="nv">$file</span> / <span class="nv">$user</span>@<span class="nv">$host</span>:/
expect <span class="o">{</span>
<span class="s2">&#34;yes/no&#34;</span> <span class="o">{</span>send <span class="s2">&#34;yes\r&#34;</span><span class="o">}</span>
<span class="s2">&#34;password&#34;</span> <span class="o">{</span>send <span class="s2">&#34;</span><span class="nv">$passwd</span><span class="s2">\r</span><span class="s2">&#34;</span><span class="o">}</span>
<span class="o">}</span>
expect eof
</pre>
<p><strong>执行过程</strong></p>
<pre class="chroma"><span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># cat rsynclist</span>
/root/good
<span class="o">[</span>root@web01 expect<span class="o">]</span><span class="c1"># expect /root/shell/expect/autors.expect root 192.168.0.30 rsynclist</span>
spawn rsync -av --files-from<span class="o">=</span>rsynclist / root@192.168.0.30:/
root@192.168.0.30<span class="se">\&#39;</span>s password:
building file list ... <span class="k">done</span>
root/
root/good

sent <span class="m">107</span> bytes  received <span class="m">40</span> bytes  294.00 bytes/sec
total size is <span class="m">12</span>  speedup is 0.08
</pre>
<p><strong>expect脚本：autoip.exp</strong><br />
<em>可以通过在expect脚本内部设置命令变量cm<br />
通过shell脚本的for循环命令来调用iplist里面的ip来逐个执行cm变量的命令</em></p>
<pre class="chroma"><span class="cp">#!/usr/bin/expect
</span><span class="cp"></span><span class="c1"># Program</span>
<span class="c1">#       used for auto login</span>
<span class="c1"># Author : Zhao Peiwu</span>
<span class="c1"># Date : 25/12/2014</span>

<span class="nb">set</span> user <span class="o">[</span>lindex <span class="nv">$argv</span> 0<span class="o">]</span>
<span class="nb">set</span> host <span class="o">[</span>lindex <span class="nv">$argv</span> 1<span class="o">]</span>
<span class="nb">set</span> cmd <span class="o">[</span>lindex <span class="nv">$argv</span> 2<span class="o">]</span>    <span class="c1">#第三个参数用来传递命令</span>
<span class="nb">set</span> passwd <span class="s2">&#34;your passwd&#34;</span>
<span class="c1">#set timeout 10</span>
spawn ssh <span class="nv">$user</span>@<span class="nv">$host</span>
expect <span class="o">{</span>
<span class="s2">&#34;yes/no&#34;</span> <span class="o">{</span>send <span class="s2">&#34;yes&#34;</span><span class="o">}</span>
<span class="s2">&#34;password:&#34;</span> <span class="o">{</span>send <span class="s2">&#34;</span><span class="nv">$passwd</span><span class="s2">\r</span><span class="s2">&#34;</span><span class="o">}</span>
<span class="o">}</span>
expect <span class="s2">&#34;]*&#34;</span>
send <span class="s2">&#34;</span><span class="nv">$cmd</span><span class="s2">\r</span><span class="s2">&#34;</span>     <span class="c1">#登陆后执行命令</span>
expect <span class="s2">&#34;]*&#34;</span>
send <span class="s2">&#34;exit\r&#34;</span>
</pre>
<p><strong>shell脚本：autoip.sh</strong></p>
<pre class="chroma"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nv">path1</span><span class="o">=</span><span class="s2">&#34;/root/shell/expect&#34;</span>     
<span class="c1">## 把autoip.exp路径指定一下</span>

<span class="k">for</span> ip in <span class="sb">`</span>cat <span class="nv">$path1</span>/iplist<span class="sb">`</span>
<span class="c1">## ip变量是在iplist中的ip列表，当然我只有两台机器，所以iplist只有一个ip</span>

<span class="k">do</span>
        <span class="nb">echo</span> <span class="nv">$ip</span>
        /usr/bin/expect <span class="nv">$path1</span>/autoip.exp root <span class="nv">$ip</span> <span class="s2">&#34;w;pwd;ls .&#34;</span>
<span class="k">done</span>
</pre>
<p><strong>执行过程</strong>
&ldquo;` bash
[root@web01 shell]# sh autoip.sh
192.168.0.30
spawn ssh root@192.168.0.30
root@192.168.0.30\&rsquo;s password:
Last login: Thu Dec 25 17:15:23 2014 from web01.gateway.2wire.net
w;pwd;ls .</p>

<h1>登录上机器以后执行三条命令，用分号间隔</h1>

<p>17:22:44 up 18:08,  1 user,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM              LOGIN@   IDLE   JCPU   PCPU WHAT
root     pts/0    web01.gateway.2w 17:22    0.00s  0.03s  0.00s w
/root
12.log  1.txt  awk  for.sh  good    perm       shell     stdin   woqunimei
1.log   aa     dd   fugai   md.txt  regep.txt  sort.txt  stdout
[root@web02 ~]# [root@web01 shell]#&rdquo;`</p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>