<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/leetcode/binary_tree/easy_94_binary_tree_inorder_traversal.html">94. Binary Tree Inorder Traversal</a>
            </li>
            <li>
              <a href="/leetcode/binary_tree/binary_tree.html">Binary Tree</a>
            </li>
            <li>
              <a href="/leetcode/linked_list/easy_21_merge_two_sorted_list.html">21. Merge Two Sorted List</a>
            </li>
            <li>
              <a href="/leetcode/linked_list/easy_206_reverse_linked_list.html">206. Reverse Linked List</a>
            </li>
            <li>
              <a href="/leetcode/linked_list/easy_141_linked_list_cycle.html">141. Linked List Cycle</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/leetcode/index.html">leetcode</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
              <ul>
                <li>
                  <a href="/linux/advance/index.html">advance</a>
                  <ul>
                    <li><a href="/linux/advance/auditd_1.0.0_basic.html">auditd: linux 审计</a></li>
                    <li><a href="/linux/advance/bash_02_00_login_shell_vs_non_login_shell.html">bash: login shell vs non-login shell</a></li>
                    <li><a href="/linux/advance/bash_1.1.0_.bashrc_vs_.bash_profile.html">bash 1.1.0 .bashrc vs .bash_profile</a></li>
                    <li><a href="/linux/advance/centos6_booted_services_optimize.html">centos6 开机服务优化</a></li>
                    <li><a href="/linux/advance/disk_1.0.1_xfs_undelete_recovery.html">disk: 1.0.1 xfs 硬盘数据恢复</a></li>
                    <li><a href="/linux/advance/dns_00_how_dns_work_in_linux.html">DNS: Linux中的DNS解析是如何工作的</a></li>
                    <li><a href="/linux/advance/dns_01_dns_problem_analysis.html">DNS: DNS解析问题排查实践</a></li>
                    <li><a href="/linux/advance/ffmpeg_1.1.0_convert_h265_to_h264.html">ffmpeg: 1.1.0 转换h265为h264</a></li>
                    <li><a href="/linux/advance/firewall_ipset_basic.html">firewall: ipset使用教程</a></li>
                    <li><a href="/linux/advance/firewall_ipset_bitmap_ip_mac.html">firewall: ipset-bitmap:ip,mac</a></li>
                    <li><a href="/linux/advance/firewall_iptables_filter_by_country.html">firewall: iptables防国家或地区流量</a></li>
                    <li><a href="/linux/advance/firewall_iptables_install_centos7.html">firewall: Centos7安装iptables</a></li>
                    <li><a href="/linux/advance/glibc_1.1.0_centos6.5_upgrade_2.14.html">glibc 1.1.0 centos6升级到2.14</a></li>
                    <li><a href="/linux/advance/kernel_1.1.0_tcp_time_wait.html">linux内核: TCP - TIME_WAIT</a></li>
                    <li><a href="/linux/advance/kernel_1.1.1_nf_conntrack_table.html">linux内核: TCP - nf_conntrack table</a></li>
                    <li><a href="/linux/advance/kernel_1.1.2_tcp_time_wait_len_vs_fin_timeout.html">linux内核: TCP - TIMEWAIT销毁时间是否可以通过tcp_fin_timeout优化？</a></li>
                    <li><a href="/linux/advance/kernel_1.1.3_listen_backlog.html">linux内核: listen()中的backlog</a></li>
                    <li><a href="/linux/advance/kernel_1.1.4_cgroup.html">linux内核: cgroup</a></li>
                    <li><a href="/linux/advance/kernel_1.1.5_enable_module.html">linux内核: 模块 - 启用模块</a></li>
                    <li><a href="/linux/advance/kernel_1.2.0_system_load_or_cpu_load.html">linux内核: 理论 - system load or cpu load</a></li>
                    <li><a href="/linux/advance/linux登录后显示_bash-4.1.html">linux登录后显示_bash-4.1</a></li>
                    <li><a href="/linux/advance/memory_01_how_memory_work_in_linux.html">内存: linux中的内存是如何工作的？</a></li>
                    <li><a href="/linux/advance/memory_02_what_is_inside_meminfo.html">内存: /proc/meminfo里面有什么？</a></li>
                    <li><a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a></li>
                    <li><a href="/linux/advance/network_ip-address.html">网络: IP - IP地址简介</a></li>
                    <li><a href="/linux/advance/network_tcp-alive-time-check.html">网络: TCP - tcp连接存活时间查询方法</a></li>
                    <li><a href="/linux/advance/network_tcp-handshake-and-close.html">网络: TCP - 理解TCP三次握手和四次挥手</a></li>
                    <li><a href="/linux/advance/network_tcp-keepalive.html">网络: TCP - tcp keepalive and http keepalive</a></li>
                    <li><a href="/linux/advance/network_tcp-queue.html">网络: TCP - tcp queue(转载)</a></li>
                    <li><a href="/linux/advance/network_tcp-reset.html">网络: TCP - RST简介</a></li>
                    <li><a href="/linux/advance/network_theory-TCP-IP-note.html">网络: 理论 - TCP/IP详解读书笔记</a></li>
                    <li><a href="/linux/advance/network_tools-nmcli.html">网络: 工具 - nmcli</a></li>
                    <li><a href="/linux/advance/network_tunnel-ipip.html">网络: 隧道 - IPIP</a></li>
                    <li><a href="/linux/advance/network_usage-Centos7-no-nic-device.html">网络: 应用 - 没有可用的网络设备(Centos7)</a></li>
                    <li><a href="/linux/advance/network_usage-centos7-dual-interface-card-dual-gateway.html">网络: 应用 - 多网卡+多网关配置</a></li>
                    <li><a href="/linux/advance/network_usage-centos7-network-error.html">网络: 应用 - 网络服务错误(Centos7)</a></li>
                    <li><a href="/linux/advance/network_usage-vmware-clone-Centos6.html">网络: 应用 - vmware克隆VM后的网络设置(Centos6)</a></li>
                    <li><a href="/linux/advance/openssh_1.0.1_sshd_key_auth_error.html">openssh 1.0.1 sshd 密钥认证错误原因排查</a></li>
                    <li><a href="/linux/advance/optimize_1.2.0_web.html">调优: 1.2.0 web服务器优化</a></li>
                    <li><a href="/linux/advance/performance_01_io_limit.html">performance: 限制进程的IO消耗</a></li>
                    <li><a href="/linux/advance/rlimit_fd_00_file_handler_vs_file_descriptor.html">rlimit: fd - 扩展文件句柄vs文件描述符</a></li>
                    <li><a href="/linux/advance/rlimit_fd_01_file_descriptor_brief_introduction.html">rlimit: fd - 简明介绍</a></li>
                    <li><a href="/linux/advance/rlimit_fd_02_commands_to_check_current_status.html">rlimit fd: 状态查看命令</a></li>
                    <li><a href="/linux/advance/rlimit_fd_03_how_linux_limit_fd.html">rlimit fd: linux中如何管理fd</a></li>
                    <li><a href="/linux/advance/rlimit_ulimit_01_introduce.html">rlimit ulimit: 简明介绍</a></li>
                    <li><a href="/linux/advance/rlimit_ulimit_02_permission_error.html">rlimit ulimit: 普通用户无法修改ulimit</a></li>
                    <li><a href="/linux/advance/selinux_1.0.0_basic.html">selinux 1.0.0 basic</a></li>
                    <li><a href="/linux/advance/selinux_1.0.1_enable_selinux_from_disabled.html">selinux 1.0.1 enable selinux from disabled status</a></li>
                    <li><a href="/linux/advance/selinux_1.0.2_sshd_public_key_lable.html">selinux 1.0.2 lable sshd public key file</a></li>
                    <li><a href="/linux/advance/server_time_NTP-install-and-config.html">SERVER TIME: NTP - 服务安装及配置</a></li>
                    <li><a href="/linux/advance/ssl_generate_key_cfssl.html">ssl: generate key by cfssl</a></li>
                    <li><a href="/linux/advance/sudo_1.1.0_SETENV_NOPASSWD.html">sudo 1.1.0 执行sudo时保持env变量</a></li>
                    <li><a href="/linux/advance/sys_mng_000_centos7-ntp-chrony.html">系统管理: 时间同步 - centos7-ntp-chrony</a></li>
                    <li><a href="/linux/advance/sys_mng_001_file_and_user_process.html">系统管理: 排查 - 查看文件与用户和进程的关联</a></li>
                    <li><a href="/linux/advance/systemd_00_00_rlimit_settings.html">systemd: 系统资源限制</a></li>
                    <li><a href="/linux/advance/systemd_1.0.0_hook_start_and_stop.html">systemd 1.0.0 同时启动关停多个服务</a></li>
                    <li><a href="/linux/advance/systemd_1.1.0_debug_cmd.html">systemd 1.1.0 排查错误使用的命令</a></li>
                    <li><a href="/linux/advance/systemd_1.2.0_unit_file_load_sequence_and_manual.html">systemd 1.2.0 unit file load sequence and manual</a></li>
                    <li><a href="/linux/advance/systemd_1.3.0_start_pre_and_post.html">systemd 1.3.0 exec pre and post</a></li>
                    <li><a href="/linux/advance/systemd_2.1.0_watchdog_for_tomcat.html">systemd 2.1.0 watchdog of systemd for tomcat</a></li>
                    <li><a href="/linux/advance/systemd_2.1.1_watchdog_for_tomcat_error_of_nonroot_user.html">systemd 2.1.1 watchdog of systemd for tomcat continue: nonroot user problem</a></li>
                    <li><a href="/linux/advance/systeminfo_1.1.0_cpuinfo.html">系统信息：1.1.0 cpuinfo 超线程引起的争吵</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/linux/basic/index.html">basic</a>
                </li>
                <li>
                  <a href="/linux/desktop/index.html">desktop</a>
                </li>
                <li>
                  <a href="/linux/monitoring/index.html">monitoring</a>
                </li>
                <li>
                  <a href="/linux/operation/index.html">operation</a>
                </li>
                <li>
                  <a href="/linux/other/index.html">other</a>
                </li>
                <li>
                  <a href="/linux/service/index.html">service</a>
                </li>
                <li>
                  <a href="/linux/shell/index.html">shell</a>
                </li>
                <li>
                  <a href="/linux/tools/index.html">tools</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>rlimit ulimit: 简明介绍</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>23 Aug 2016</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>0. linux系统资源限制简介</h3>

<p>单台计算机的资源不可能是无限的，所以linux系统需要对资源进行限制。linux系统中对系统资源的限制设定，提供了三个系统调用</p>

<ul>
<li>setrlimit，设定当前进程的rlimit</li>
<li>getrlimit，设定当前进程的rlimit</li>
<li>prlimit，update指定pid的进程的rlimit</li>
</ul>

<blockquote>
<p>资源限制分为soft limit和hard limit。只有root可以调高hard limit，其他用户可以调整soft limit和hard limit，但无法将其设定为超过hard limit的数值。</p>
</blockquote>

<p>ulimit就是shell内置的基于上面的系统调用研发的，应用对象为用户或用户组的系统级别的rlimit管理工具。</p>

<p><strong>ulimit命令使用范围，特别注意 ！！</strong>
ulimit命令只能对当前登录的shell环境生效，一旦用户登出当前shell，之前所做的设定修改则失效；</p>

<p><strong>ulimit配置文件使用范围和生效方式，特别注意！！</strong>
ulimit的主要配置文件为<code>/etc/security/limits.conf</code>，而<code>/etc/security/limits.d/*.conf</code>以c中的字符排序进行加载，重复的规则会以后加载的顺序覆盖前者。上述配置修改过后，只对通过<a href="https://en.wikipedia.org/wiki/Linux_PAM">PAM（Pluggable Authentication Modules）</a>登录的用户环境生效（已经登录过的需要重新登录shell）。</p>

<p>鉴于以上使用限制，ulimit只能应用于未经过其他rlimit管理工具管理的，且通过<strong>PAM登录</strong>过的login shell中fork出的进程。</p>

<blockquote>
<p>“通过PAM登录”，这里是针对shell环境来说的，其实并不一定是需要登录这个动作，而是只要经过PAM授权，调用了PAM的pam_limits.so这个模块，这个模块就会加载<code>/etc/security/limits.conf</code>，从而给进程修改了limit。（可见下面的crontab，就是未经过ulimit的一个例子）</p>

<p><a href="/linux/advance/bash_02_00_login_shell_vs_non_login_shell.html">login shell vs non-login shell</a></p>

<p><code>/etc/security/limits.conf</code>中的注释说明
This file sets the resource limits for the users logged in via PAM.
It does not affect resource limits of the system services.</p>
</blockquote>

<h3>1. ulimit工具使用说明</h3>

<p><strong>ulimit命令使用说明</strong></p>
<pre class="chroma"><span class="c1"># 查看所有信息</span>
<span class="nb">ulimit</span> -a
core file size          <span class="o">(</span>blocks, -c<span class="o">)</span> <span class="m">0</span>
data seg size           <span class="o">(</span>kbytes, -d<span class="o">)</span> unlimited
scheduling priority             <span class="o">(</span>-e<span class="o">)</span> <span class="m">0</span>
file size               <span class="o">(</span>blocks, -f<span class="o">)</span> unlimited
pending signals                 <span class="o">(</span>-i<span class="o">)</span> <span class="m">3876</span>
max locked memory       <span class="o">(</span>kbytes, -l<span class="o">)</span> <span class="m">64</span>
max memory size         <span class="o">(</span>kbytes, -m<span class="o">)</span> unlimited
open files                      <span class="o">(</span>-n<span class="o">)</span> <span class="m">1024</span>
pipe size            <span class="o">(</span><span class="m">512</span> bytes, -p<span class="o">)</span> <span class="m">8</span>
POSIX message queues     <span class="o">(</span>bytes, -q<span class="o">)</span> <span class="m">819200</span>
real-time priority              <span class="o">(</span>-r<span class="o">)</span> <span class="m">0</span>
stack size              <span class="o">(</span>kbytes, -s<span class="o">)</span> <span class="m">10240</span>
cpu <span class="nb">time</span>               <span class="o">(</span>seconds, -t<span class="o">)</span> unlimited
max user processes              <span class="o">(</span>-u<span class="o">)</span> <span class="m">3876</span>
virtual memory          <span class="o">(</span>kbytes, -v<span class="o">)</span> unlimited
file locks                      <span class="o">(</span>-x<span class="o">)</span> unlimited

<span class="c1"># 查看针对当前用户的最大文件打开数软限制</span>
<span class="nb">ulimit</span> -Sn
<span class="m">1024</span>

<span class="c1"># 查看针对当前用户的最大文件打开数硬限制</span>
<span class="nb">ulimit</span> -Hn
<span class="m">1024</span>
</pre>
<p><strong>ulimit配置文件：limits.conf</strong></p>
<pre class="chroma">1. 修改/etc/security/limits.conf，增加或修改以下值
* soft nofile 32768
* hard nofile 65535

!!重点需要注意!!
后来发现编辑此文件并没有改变ulimit -a 中的open files值，原来是因为，
当我们用&#39;*&#39;入口来配置时，会被/etc/security/limits.d/90-nproc.conf中的配置所覆盖，
所以需要注意配置文件的覆盖顺序（前面有提及）


2. limits.conf实际是linux pam中的pam_limits.so的配置文件，针对于单个会话
编辑/etc/pam.d/login
session    required     /lib64/security/pam_limits.so
</pre>
<blockquote>
<p><strong>!!重点注意!!</strong>
<code>/etc/pam.d/login</code>中有<code>session    include      system-auth</code>这条记录，意味着<code>/etc/pam.d/system-auth</code>这个文件的记录都会包含到<code>/etc/pam.d/login</code>中。
在<code>/etc/pam.d/system-auth</code>中有配置<code>session    required     /lib64/security/pam_limits.so</code></p>

<p>PS: /etc/pam.d中文件的名称就是service，对应不同的application，例如login、sshd</p>
</blockquote>

<p><strong><code>limits.conf</code>的详细说明</strong></p>
<pre class="chroma">格式：&lt;domain&gt;        &lt;type&gt;  &lt;item&gt;  &lt;value&gt;

&lt;domain&gt; can be:
- a user name
- a group name, with @group syntax
- the wildcard *, for default entry
- the wildcard %, can be also used with %group syntax, for maxlogin limit

&lt;type&gt; can have the two values:
- &#34;soft&#34; for enforcing the soft limits - 取值范围是0-该用户资源上限，普通用户可配置
- &#34;hard&#34; for enforcing hard limits - 设定了该用户资源上限，只有管理员可配置
- &#34;-&#34; for both enforcing hard and soft limits

&lt;item&gt; can be one of the following:
- core - limits the core file size (KB)
- data - max data size (KB)
- fsize - maximum filesize (KB)
- memlock - max locked-in-memory address space (KB)
- nofile - max number of open file descriptors
- rss - max resident set size (KB)
- stack - max stack size (KB)
- cpu - max CPU time (MIN)
- nproc - max number of processes
- as - address space limit (KB)
- maxlogins - max number of logins for this user
- maxsyslogins - max number of logins on the system
- priority - the priority to run user process with
- locks - max number of file locks the user can hold
- sigpending - max number of pending signals
- msgqueue - max memory used by POSIX message queues (bytes)
- nice - max nice priority allowed to raise to values: [-20, 19]
- rtprio - max realtime priority
</pre>
<h3>2. ulimit应用范围示例</h3>

<h4>2.1 sysvinit script是否受ulimit中的配置限制</h4>

<h4>2.2 关于ulimit，手动创建子shell(login shell 和 non-login shell)，是配置文件生效，还是继承的父进程的值？</h4>
<pre class="chroma"><span class="c1"># ulimit配置文件</span>
cat /etc/security/limits.conf <span class="p">|</span> grep nofile
root soft nofile <span class="m">65535</span> 
root hard nofile <span class="m">65535</span>

<span class="c1"># ulimit内存配置值</span>
<span class="nb">ulimit</span> -Hn
<span class="m">2048</span>

<span class="nb">ulimit</span> -Sn
<span class="m">2048</span>

<span class="c1"># 无论是login shell还是non-login shell，都是继承内存中的值</span>
bash -l -c <span class="s2">&#34;</span><span class="s2">shopt login_shell; cat /proc/</span><span class="nv">$$</span><span class="s2">/limits|grep files</span><span class="s2">&#34;</span>
login_shell       on
Max open files            <span class="m">2048</span>                 <span class="m">2048</span>                 files     

bash -c <span class="s2">&#34;</span><span class="s2">shopt login_shell; cat /proc/</span><span class="nv">$$</span><span class="s2">/limits|grep files</span><span class="s2">&#34;</span>
login_shell       off
Max open files            <span class="m">2048</span>                 <span class="m">2048</span>                 files
</pre>
<blockquote>
<p>在login shell和non-login shell中进行上述测试，结果一致</p>
</blockquote>

<p><strong>原因分析</strong></p>

<p>并不是login shell都调用了PAM，未经过PAM调用的login shell也不会受到ulimit配置文件的影响，而是继承了父进程（当前bash进程）的limit值。</p>

<h4>2.3 关于ulimit，crontab中的任务，是配置文件生效，还是当前内存值生效</h4>

<p><strong>首先，crontab中的任务的父进程是谁？</strong></p>
<pre class="chroma">crontab -l
* * * * * sleep <span class="m">50</span>

<span class="c1"># 查看crond的进程数</span>
pstree -p <span class="m">3849</span>
crond<span class="o">(</span>3849<span class="o">)</span>---crond<span class="o">(</span>7836<span class="o">)</span>---sleep<span class="o">(</span>7838<span class="o">)</span>

<span class="c1"># ulimit配置文件</span>
cat /etc/security/limits.conf <span class="p">|</span> grep nofile
root soft nofile <span class="m">2048</span> 
root hard nofile <span class="m">65535</span>

<span class="c1"># ulimit内存配置值</span>
<span class="nb">ulimit</span> -Hn
<span class="m">1025</span>

<span class="nb">ulimit</span> -Sn
<span class="m">1025</span>

<span class="c1"># 查看进程的limit</span>
cat /proc/3849/limits <span class="p">|</span> grep files
Max open files            <span class="m">1024</span>                 <span class="m">262144</span>               files 

cat /proc/7838/limits<span class="p">|</span>grep files
Max open files            <span class="m">2048</span>                 <span class="m">65535</span>                files     

cat /proc/7836/limits<span class="p">|</span>grep files
Max open files            <span class="m">2048</span>                 <span class="m">65535</span>                files
</pre>
<p>从上面可以验证两个事情：</p>

<ol>
<li>cron jobs是由crond fork出的子进程</li>
<li>cron jobs虽然是由crond fork出来，但是并未继承crond的limit值，而是继承了<code>/etc/security/limits.conf</code>中设定的值。</li>
</ol>

<p><strong>其次，当ulimit配置文件中更新值后，cron job获取的limit设定会实时变动吗？</strong></p>
<pre class="chroma">crontab -l
* * * * * sh -l -c <span class="s2">&#34;</span><span class="s2">shopt login_shell &gt;&gt; /tmp/result-login; cat /proc/</span><span class="nv">$$</span><span class="s2">/limits | grep files &gt;&gt; /tmp/result-login</span><span class="s2">&#34;</span>
* * * * * <span class="nb">shopt</span> login_shell &gt;&gt; /tmp/result-non-login<span class="p">;</span> cat /proc/<span class="nv">$$</span>/limits <span class="p">|</span> grep files &gt;&gt; /tmp/result-non-login

<span class="c1"># 中间将ulimit配置文件&#39;/etc/security/limits.conf&#39;中的值从1025改为65535</span>
cat /tmp/result-login
login_shell     on
Max open files            <span class="m">1025</span>                 <span class="m">1025</span>                 files     
login_shell     on
Max open files            <span class="m">65535</span>                <span class="m">65535</span>                files 

cat /tmp/result-non-login
login_shell     off
Max open files            <span class="m">1025</span>                 <span class="m">1025</span>                 files     
login_shell     off
Max open files            <span class="m">65535</span>                <span class="m">65535</span>                files 
</pre>
<p>对于cron job，如果<code>/etc/securit/limits.conf</code>中的值中途修改过，那么最新的cron job获取的是配置中的最新值。</p>

<p><strong>原因分析</strong></p>

<p>不是说只有经过PAM登录的login shell才会加载这个配置吗？为什么crontab中无论启动login shell还是non-login shell都会加载这个配置？原因是因为<code>/etc/security/limits.conf</code>其实本质上是PAM中pam_limit.so的配置文件，前面的介绍中提到这个配置文件都在说ulimit的配置文件，是因为前面的语境都是在shell环境中。ulimit是shell内置的一个limit配置管理工具，而跳出shell语境下后，只要某个进程的授权经过了PAM，并且在PAM中针对性的配置了对应这个application的pam_limits.so的require，那么它就和前面提到的经过PAM登录的login shell一样，会将<code>/etc/security/limits.conf</code>中的资源限制在子进程上生效。</p>

<p>果不其然，在/etc/pam.d中发现了crond这个配置，在下面是它的内容。</p>
<pre class="chroma">cat /etc/pam.d/crond 
#
<span class="c1"># The PAM configuration file for the cron daemon</span>
#
#
<span class="c1"># Although no PAM authentication is called, auth modules</span>
<span class="c1"># are used for credential setting</span>
auth       include    password-auth
account    required   pam_access.so
account    include    password-auth
session    required   pam_loginuid.so
session    include    password-auth

cat /etc/pam.d/password-auth <span class="p">|</span> grep pam_limits.so
session     required                                     pam_limits.so
</pre>
<blockquote>
<p>crond中session 部分 include了password-auth。而password-auth中包含了pam_limits.so。</p>
</blockquote>

<p>这样我们前面的猜测就得到了验证，crond是通过调用PAM(<a href="https://man7.org/linux/man-pages/man8/cron.8.html">crond 的man文档中有说明</a>)来应用了资源的限制。</p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>