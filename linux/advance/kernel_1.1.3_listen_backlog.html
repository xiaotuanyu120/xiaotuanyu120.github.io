<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a>
            </li>
            <li>
              <a href="/service/nginx/nginx_2.1.9.03_configuration_log.html">nginx: 配置 - 日志</a>
            </li>
            <li>
              <a href="/linux/advance/network_tunnel-ipip.html">网络: 隧道 - IPIP</a>
            </li>
            <li>
              <a href="/linux/advance/network_ip-address.html">网络: IP - IP地址简介</a>
            </li>
            <li>
              <a href="/linux/advance/bash_02_00_login_shell_vs_non_login_shell.html">bash: login shell vs non-login shell</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
              <ul>
                <li>
                  <a href="/linux/advance/index.html">advance</a>
                  <ul>
                    <li><a href="/linux/advance/auditd_1.0.0_basic.html">auditd: linux 审计</a></li>
                    <li><a href="/linux/advance/bash_02_00_login_shell_vs_non_login_shell.html">bash: login shell vs non-login shell</a></li>
                    <li><a href="/linux/advance/bash_1.1.0_.bashrc_vs_.bash_profile.html">bash 1.1.0 .bashrc vs .bash_profile</a></li>
                    <li><a href="/linux/advance/centos6_booted_services_optimize.html">centos6 开机服务优化</a></li>
                    <li><a href="/linux/advance/curl_1.1.0_post_usage.html">curl 1.1.0 POST usage</a></li>
                    <li><a href="/linux/advance/disk_1.0.1_xfs_undelete_recovery.html">disk: 1.0.1 xfs 硬盘数据恢复</a></li>
                    <li><a href="/linux/advance/dns_00_how_dns_work_in_linux.html">DNS: Linux中的DNS解析是如何工作的</a></li>
                    <li><a href="/linux/advance/dns_01_dns_problem_analysis.html">DNS: DNS解析问题排查实践</a></li>
                    <li><a href="/linux/advance/ffmpeg_1.1.0_convert_h265_to_h264.html">ffmpeg: 1.1.0 转换h265为h264</a></li>
                    <li><a href="/linux/advance/firewall_ipset_basic.html">firewall: ipset使用教程</a></li>
                    <li><a href="/linux/advance/firewall_ipset_bitmap_ip_mac.html">firewall: ipset-bitmap:ip,mac</a></li>
                    <li><a href="/linux/advance/firewall_iptables_filter_by_country.html">firewall: iptables防国家或地区流量</a></li>
                    <li><a href="/linux/advance/firewall_iptables_install_centos7.html">firewall: Centos7安装iptables</a></li>
                    <li><a href="/linux/advance/glibc_1.1.0_centos6.5_upgrade_2.14.html">glibc 1.1.0 centos6升级到2.14</a></li>
                    <li><a href="/linux/advance/kernel_1.1.0_tcp_time_wait.html">linux内核: TCP - TIME_WAIT</a></li>
                    <li><a href="/linux/advance/kernel_1.1.1_nf_conntrack_table.html">linux内核: TCP - nf_conntrack table</a></li>
                    <li><a href="/linux/advance/kernel_1.1.2_tcp_time_wait_len_vs_fin_timeout.html">linux内核: TCP - TIMEWAIT销毁时间是否可以通过tcp_fin_timeout优化？</a></li>
                    <li><a href="/linux/advance/kernel_1.1.3_listen_backlog.html">linux内核: listen()中的backlog</a></li>
                    <li><a href="/linux/advance/kernel_1.1.4_cgroup.html">linux内核: cgroup</a></li>
                    <li><a href="/linux/advance/kernel_1.1.5_enable_module.html">linux内核: 模块 - 启用模块</a></li>
                    <li><a href="/linux/advance/kernel_1.2.0_system_load_or_cpu_load.html">linux内核: 理论 - system load or cpu load</a></li>
                    <li><a href="/linux/advance/linux登录后显示_bash-4.1.html">linux登录后显示_bash-4.1</a></li>
                    <li><a href="/linux/advance/memory_01_how_memory_work_in_linux.html">内存: linux中的内存是如何工作的？</a></li>
                    <li><a href="/linux/advance/memory_02_what_is_inside_meminfo.html">内存: /proc/meminfo里面有什么？</a></li>
                    <li><a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a></li>
                    <li><a href="/linux/advance/network_ip-address.html">网络: IP - IP地址简介</a></li>
                    <li><a href="/linux/advance/network_tcp-alive-time-check.html">网络: TCP - tcp连接存活时间查询方法</a></li>
                    <li><a href="/linux/advance/network_tcp-handshake-and-close.html">网络: TCP - 理解TCP三次握手和四次挥手</a></li>
                    <li><a href="/linux/advance/network_tcp-keepalive.html">网络: TCP - tcp keepalive and http keepalive</a></li>
                    <li><a href="/linux/advance/network_tcp-queue.html">网络: TCP - tcp queue(转载)</a></li>
                    <li><a href="/linux/advance/network_tools-nmcli.html">网络: 工具 - nmcli</a></li>
                    <li><a href="/linux/advance/network_tunnel-ipip.html">网络: 隧道 - IPIP</a></li>
                    <li><a href="/linux/advance/network_usage-Centos7-no-nic-device.html">网络: 应用 - 没有可用的网络设备(Centos7)</a></li>
                    <li><a href="/linux/advance/network_usage-centos7-dual-interface-card-dual-gateway.html">网络: 应用 - 多网卡+多网关配置</a></li>
                    <li><a href="/linux/advance/network_usage-centos7-network-error.html">网络: 应用 - 网络服务错误(Centos7)</a></li>
                    <li><a href="/linux/advance/network_usage-vmware-clone-Centos6.html">网络: 应用 - vmware克隆VM后的网络设置(Centos6)</a></li>
                    <li><a href="/linux/advance/openssh_1.0.1_sshd_key_auth_error.html">openssh 1.0.1 sshd 密钥认证错误原因排查</a></li>
                    <li><a href="/linux/advance/optimize_1.2.0_web.html">调优: 1.2.0 web服务器优化</a></li>
                    <li><a href="/linux/advance/performance_01_io_limit.html">performance: 限制进程的IO消耗</a></li>
                    <li><a href="/linux/advance/rlimit_fd_00_file_handler_vs_file_descriptor.html">rlimit: fd - 扩展文件句柄vs文件描述符</a></li>
                    <li><a href="/linux/advance/rlimit_fd_01_file_descriptor_brief_introduction.html">rlimit: fd - 简明介绍</a></li>
                    <li><a href="/linux/advance/rlimit_fd_02_commands_to_check_current_status.html">rlimit fd: 状态查看命令</a></li>
                    <li><a href="/linux/advance/rlimit_fd_03_how_linux_limit_fd.html">rlimit fd: linux中如何管理fd</a></li>
                    <li><a href="/linux/advance/rlimit_ulimit_01_introduce.html">rlimit ulimit: 简明介绍</a></li>
                    <li><a href="/linux/advance/rlimit_ulimit_02_permission_error.html">rlimit ulimit: 普通用户无法修改ulimit</a></li>
                    <li><a href="/linux/advance/rsync_1.1.0_max_connections.html">rsync 1.1.0 error: max connections reached</a></li>
                    <li><a href="/linux/advance/rsync_1.2.0_chmod_chown.html">rsync 1.2.0 chown chmod</a></li>
                    <li><a href="/linux/advance/selinux_1.0.0_basic.html">selinux 1.0.0 basic</a></li>
                    <li><a href="/linux/advance/selinux_1.0.1_enable_selinux_from_disabled.html">selinux 1.0.1 enable selinux from disabled status</a></li>
                    <li><a href="/linux/advance/selinux_1.0.2_sshd_public_key_lable.html">selinux 1.0.2 lable sshd public key file</a></li>
                    <li><a href="/linux/advance/server_time_NTP-install-and-config.html">SERVER TIME: NTP - 服务安装及配置</a></li>
                    <li><a href="/linux/advance/ssl_generate_key_cfssl.html">ssl: generate key by cfssl</a></li>
                    <li><a href="/linux/advance/sudo_1.1.0_SETENV_NOPASSWD.html">sudo 1.1.0 执行sudo时保持env变量</a></li>
                    <li><a href="/linux/advance/sys_mng_000_centos7-ntp-chrony.html">系统管理: 时间同步 - centos7-ntp-chrony</a></li>
                    <li><a href="/linux/advance/sys_mng_001_file_and_user_process.html">系统管理: 排查 - 查看文件与用户和进程的关联</a></li>
                    <li><a href="/linux/advance/systemd_00_00_rlimit_settings.html">systemd: 系统资源限制</a></li>
                    <li><a href="/linux/advance/systemd_1.0.0_hook_start_and_stop.html">systemd 1.0.0 同时启动关停多个服务</a></li>
                    <li><a href="/linux/advance/systemd_1.1.0_debug_cmd.html">systemd 1.1.0 排查错误使用的命令</a></li>
                    <li><a href="/linux/advance/systemd_1.2.0_unit_file_load_sequence_and_manual.html">systemd 1.2.0 unit file load sequence and manual</a></li>
                    <li><a href="/linux/advance/systemd_1.3.0_start_pre_and_post.html">systemd 1.3.0 exec pre and post</a></li>
                    <li><a href="/linux/advance/systemd_2.1.0_watchdog_for_tomcat.html">systemd 2.1.0 watchdog of systemd for tomcat</a></li>
                    <li><a href="/linux/advance/systemd_2.1.1_watchdog_for_tomcat_error_of_nonroot_user.html">systemd 2.1.1 watchdog of systemd for tomcat continue: nonroot user problem</a></li>
                    <li><a href="/linux/advance/systeminfo_1.1.0_cpuinfo.html">系统信息：1.1.0 cpuinfo 超线程引起的争吵</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/linux/basic/index.html">basic</a>
                </li>
                <li>
                  <a href="/linux/desktop/index.html">desktop</a>
                </li>
                <li>
                  <a href="/linux/monitoring/index.html">monitoring</a>
                </li>
                <li>
                  <a href="/linux/other/index.html">other</a>
                </li>
                <li>
                  <a href="/linux/service/index.html">service</a>
                </li>
                <li>
                  <a href="/linux/shell/index.html">shell</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>linux内核: listen()中的backlog</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>10 Dec 2015</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>0. listen()的backlog含义？</h2>

<p>listen man文档中的description：</p>
<pre class="chroma">listen() marks the socket referred to by sockfd as a passive socket, that is, as a socket that will be used to accept incoming connection requests using accept(2).
The sockfd argument is a file descriptor that refers to a socket of type SOCK_STREAM or SOCK_SEQPACKET.
 
The backlog argument defines the maximum length to which the queue of pending connections for sockfd may grow. If a connection request arrives when the queue is full, the client may receive an error with an indication of ECONNREFUSED or, if the underlying protocol supports retransmission, the request may be ignored so that a later reattempt at connection succeeds.
</pre>
<p>总结来说，由backlog定义了等待连接（因为连接已经达到上限）的队列的长度。每个socket开始调用listen()时，系统会分配一个backlog参数给socket。如果等待连接的请求数超过了这个最大值，会返回给客户端一个ECONNREFUSED。</p>

<p>简单的一个比喻就是，socket是一个餐厅，listen()相当于开始营业的动作，餐厅内部最多可以招待一定数量的客人（accept()处理的最大的连接数）。然后当餐厅满了，后面的客人可以在餐厅外排队，这个队伍的长度由backlog来定义，队伍超过最大长度后，服务员会直接拒绝后面的客人继续排队。</p>

<h2>1. backlog的长度限制</h2>

<p>可以通过调整下面参数来调整</p>
<pre class="chroma">net.core.somaxconn <span class="o">=</span> <span class="m">655360</span>
</pre>
<p>但是从linux 2.2开始，backlog变更为指定已建立的等待accept的套接字队列长度，而不再是未完全建立连接的请求。未完全建立连接的请求的队列长度需要通过<code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code>来指定。</p>

<blockquote>
<p>但是当syncookies启用时，上面这个配置会被忽略，不会存在syn队列的最大长度。</p>
</blockquote>
<pre class="chroma">net.core.netdev_max_backlog <span class="o">=</span> <span class="m">1048576</span>
<span class="c1"># 每个网络接口，允许后台排队队列数据包的最大数目</span>

net.ipv4.tcp_max_syn_backlog <span class="o">=</span> <span class="m">1048576</span>
<span class="c1"># 尚未收到客户端确认信息的连接请求的最大值</span>
</pre>
    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>