<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/service/haproxy/haproxy_01_config_log.html">haproxy: 配置和日志</a>
            </li>
            <li>
              <a href="/service/haproxy/haproxy_00_start_up_with_docker_compose.html">haproxy: 使用docker-compose启动haproxy</a>
            </li>
            <li>
              <a href="/service/apache/1.1.3_apache_config_make_servername_and_serveralias_an_ip.html">apache 配置: 可以把ServerName和ServerAlias配置为IP吗？</a>
            </li>
            <li>
              <a href="/linux/advance/performance_01_io_limit.html">performance: 限制进程的IO消耗</a>
            </li>
            <li>
              <a href="/linux/advance/memory_02_what_is_inside_meminfo.html">/proc/meminfo里面有什么？</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
              <ul>
                <li>
                  <a href="/database/mysql/index.html">mysql</a>
                  <ul>
                    <li><a href="/database/mysql/MYSQL_5.6主从(centos6).html">MYSQL: 5.6主从(centos6)</a></li>
                    <li><a href="/database/mysql/MYSQL_MyCat安装_读写分离.html">MYSQL: MyCat安装，读写分离</a></li>
                    <li><a href="/database/mysql/MYSQL_多实例配置+启动脚本.html">MYSQL: 多实例配置+启动脚本</a></li>
                    <li><a href="/database/mysql/MYSQL_无法通过sock登陆.html">MYSQL-error: 无法通过sock登陆</a></li>
                    <li><a href="/database/mysql/MYSQL_查看表ENGINE(v5.6).html">MYSQL: 查看表ENGINE(v5.6)</a></li>
                    <li><a href="/database/mysql/MYSQL_设置wait_timeout控制sleep线程太多.html">MYSQL: 设置wait_timeout控制sleep线程太多</a></li>
                    <li><a href="/database/mysql/MySQL_增量备份-binlog.html">MySQL: 增量备份-binlog</a></li>
                    <li><a href="/database/mysql/MySQL_备份及恢复理论.html">MySQL:备份及恢复理论</a></li>
                    <li><a href="/database/mysql/MySQL_安装脚本.html">MySQL: 安装脚本</a></li>
                    <li><a href="/database/mysql/MySQL_配置及优化.html">MySQL: 配置及优化</a></li>
                    <li><a href="/database/mysql/error_1.0_force_close_of_thread.html">MYSQL-错误: 1.0 force close of thread xxx user: 'someuser'</a></li>
                    <li><a href="/database/mysql/error_1.1_cant_connect_mysql_remotely.html">MYSQL-错误: 1.1 DNS查询优化和Host缓存</a></li>
                    <li><a href="/database/mysql/error_5.6-error-1045.html">error: 5.6-error-1045</a></li>
                    <li><a href="/database/mysql/error_innodb_init.html">MYSQL-错误：无法启动排障</a></li>
                    <li><a href="/database/mysql/error_主从_1062Duplicateentry_.html">error: 主从"1062 Duplicate entry"</a></li>
                    <li><a href="/database/mysql/error_双主错误1593.html">error: 双主错误1593</a></li>
                    <li><a href="/database/mysql/error_服务无法启动报错.html">error: 服务无法启动报错</a></li>
                    <li><a href="/database/mysql/error_表只读.html">error: 表只读</a></li>
                    <li><a href="/database/mysql/mysql_1.0.0_installation.html">mysql 1.0.0: 安装教程</a></li>
                    <li><a href="/database/mysql/mysql_1.0.1_docker_compose.html">mysql 1.0.1: docker-compose(单实例和主从)</a></li>
                    <li><a href="/database/mysql/mysql_3.0.0_basic_operation.html">mysql 3.0.0：常用命令</a></li>
                    <li><a href="/database/mysql/mysql_4.0.1_problem_caused_by_auto_increment.html">mysql 4.0.1：auto_increment引起的问题</a></li>
                    <li><a href="/database/mysql/mysql_config_basic.html">MYSQL-配置：常用基本配置</a></li>
                    <li><a href="/database/mysql/mysql_config_optimize.html">MYSQL-配置：调优</a></li>
                    <li><a href="/database/mysql/mysql_config_set_character_collation.html">MYSQL-配置：配置字符集为utf8</a></li>
                    <li><a href="/database/mysql/mysql_error_start_login.html">MYSQL-错误：启动/登录报错</a></li>
                    <li><a href="/database/mysql/mysql_manage_backup_recovery.html">MYSQL-管理：备份及恢复</a></li>
                    <li><a href="/database/mysql/mysql_manage_reset_root_password.html">MYSQL-管理：忘记root密码</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/database/oracle/index.html">oracle</a>
                </li>
                <li>
                  <a href="/database/rabbitmq/index.html">rabbitmq</a>
                </li>
                <li>
                  <a href="/database/redis/index.html">redis</a>
                </li>
                <li>
                  <a href="/database/rocketmq/index.html">rocketmq</a>
                </li>
                <li>
                  <a href="/database/sql/index.html">sql</a>
                </li>
                <li>
                  <a href="/database/zookeeper/index.html">zookeeper</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>MySQL: 增量备份-binlog</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>22 Nov 2015</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>0、修改配置</h3>
<pre class="chroma">vim /etc/my.cnf
<span class="nv">log_bin</span><span class="o">=</span>/data/mysql/bin_log
binlog-do-db<span class="o">=</span>replication
binlog-ignore-db<span class="o">=</span>replication2,replication3
<span class="c1">## 开启binlog记录</span>
</pre>
<h3>1、完整备份</h3>
<pre class="chroma">mysqldump -u root -p --all-databases --master-data &gt; lastback.sql 
<span class="c1"># --master-data的目地是保存binlog信息到sql备份文件中</span>
</pre>
<h3>2、查看最后一次完整备份</h3>
<pre class="chroma">head -50 lastback.sql <span class="p">|</span> grep <span class="s1">&#39;CHANGE MASTER&#39;</span>
CHANGE MASTER TO <span class="nv">MASTER_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;bin_log.000007&#39;</span>, <span class="nv">MASTER_LOG_POS</span><span class="o">=</span>1236<span class="p">;</span>
<span class="c1"># 我们可以看到binlog文件，position位置</span>
<span class="sb">`</span><span class="sb">`</span><span class="sb">`</span> 

<span class="c1">### 3、进去replication，删掉唯一的表replitab</span>
<span class="sb">`</span><span class="sb">`</span><span class="sb">`</span> bash
mysql&gt; use replication
Reading table information <span class="k">for</span> completion of table and column names
You can turn off this feature to get a quicker startup with -A
 
Database changed
mysql&gt; show tables<span class="p">;</span>
+-----------------------+
<span class="p">|</span> Tables_in_replication <span class="p">|</span>
+-----------------------+
<span class="p">|</span> replitab              <span class="p">|</span>
+-----------------------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
 
mysql&gt; create table replitab2 <span class="o">(</span>
    -&gt; id int<span class="o">(</span>5<span class="o">)</span>,
    -&gt; name varchar<span class="o">(</span>10<span class="o">)</span><span class="o">)</span><span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.01 sec<span class="o">)</span>
 
mysql&gt; drop table replitab<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.01 sec<span class="o">)</span>
 
mysql&gt; show tables<span class="p">;</span>
+-----------------------+
<span class="p">|</span> Tables_in_replication <span class="p">|</span>
+-----------------------+
<span class="p">|</span> replitab2             <span class="p">|</span>
+-----------------------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</pre>
<h3>4、恢复最后一次完整备份</h3>
<pre class="chroma">mysql -u root -p &lt; lastback.sql
``` 

### 5、查看目前的binlog位置
</pre>
<p>mysql&gt; show binary logs;
+&mdash;&mdash;&mdash;&mdash;&mdash;-+&mdash;&mdash;&mdash;&ndash;+
| Log_name       | File_size |
+&mdash;&mdash;&mdash;&mdash;&mdash;-+&mdash;&mdash;&mdash;&ndash;+
| bin_log.000001 |       143 |
| bin_log.000002 |       959 |
| bin_log.000003 |       653 |
| bin_log.000004 |       392 |
| bin_log.000005 |       259 |
| bin_log.000006 |       120 |
| bin_log.000007 |      3878 |
+&mdash;&mdash;&mdash;&mdash;&mdash;-+&mdash;&mdash;&mdash;&ndash;+
7 rows in set (0.00 sec)</p>

<p>mysql&gt; show master status\G
*************************** 1. row ***************************</p>
<pre class="chroma">         File: bin_log.000007
     Position: 3878
 Binlog_Do_DB: replication
</pre>
<p>Binlog_Ignore_DB: replication2,replication3
Executed_Gtid_Set:
1 row in set (0.00 sec)</p>
<pre class="chroma"> 
### 6、根据lastback.sql备份中的position和上面的postion恢复
</pre>
<h1>下面命令可以查看binlog文件的详情，找到需要恢复的时间、位置</h1>

<p>mysqlbinlog /data/mysql/bin_log.000007 | grep -C 2 &lsquo;DROP&rsquo;
use <code>replication</code>/<em>!</em>/;
SET TIMESTAMP=1448201487/<em>!</em>/;
DROP TABLE IF EXISTS <code>replitab</code> /* generated by server <em>/
/</em>!*/;</p>

<h1>at 448</h1>

<p>&ndash;
SET @@session.foreign_key_checks=1, @@session.unique_checks=1/<em>!</em>/;
SET @@session.sql_mode=1075838976/<em>!</em>/;
DROP TABLE <code>replitab</code> /* generated by server <em>/
/</em>!*/;</p>

<h1>at 1371</h1>

<p>&ndash;
use <code>replication</code>/<em>!</em>/;
SET TIMESTAMP=1448206056/<em>!</em>/;
DROP TABLE IF EXISTS <code>replitab</code> /* generated by server <em>/
/</em>!*/;</p>

<h1>at 1699</h1>

<p>&ndash;
#151122 23:28:58 server id 1  end_log_pos 2762 CRC32 0xfe743fd2         Query   thread_id=11    exec_time=0     error_code=0
SET TIMESTAMP=1448206138/<em>!</em>/;
DROP TABLE <code>replitab</code> /* generated by server <em>/
/</em>!*/;</p>

<h1>at 2762</h1>

<p>&ndash;
use <code>replication</code>/<em>!</em>/;
SET TIMESTAMP=1448206454/<em>!</em>/;
DROP TABLE IF EXISTS <code>replitab</code> /* generated by server <em>/
/</em>!*/;</p>

<h1>at 3090</h1>

<h2>上面发现最后一次DROP掉replitab是在position 2762，那我们就恢复到2761</h2>

<h1>mysqlbinlog &ndash;stop-position=2761 /data/mysql/bin_log.000007 | mysql -u root -p</h1>

<p>Enter password:
ERROR 1050 (42S01) at line 120: Table &lsquo;replitab2&rsquo; already exists</p>

<h2>报错是因为MySQL根据binlog执行的时候根据binlog去创建replitab2，发现它已经存在，这个错误是因为我之前为了尝试备份命令多次操作的原因</h2>
<pre class="chroma">
### 7、检查效果
</pre>
<p>mysql&gt; show tables ;
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+
| Tables_in_replication |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+
| replitab              |
| replitab2             |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+
2 rows in set (0.00 sec)</p>
<pre class="chroma">
### 8、总结
问题：
- 在实验过程中，尝试了删掉表然后接着就开始了恢复进程，误操作是在2762位置，但是如果我们没有及时发现这个错误，当我们过了一个小时发现这个错误的时候，可能当前的position已经是4000多了。

操作：
- 利用上面的过程，先恢复到postion 2761，然后`mysqlbinlog --start-position=2763 /data/mysql/bin_log.000007 | mysql -u root -p`相当于从2763开始继续恢复，用先stop后start指定position的方式跳过故障点。

扩展：
- 同理我们也可以使用--start-date和--stop-date来跳过故障时间
&gt; 官方文档：
&gt; https://dev.mysql.com/doc/refman/5.5/en/point-in-time-recovery.html

定时备份binlog
</pre>
<h1>既然我们需要做incremental备份，那最好是有规划的去处理binlog而不是让系统自动去分割binlog文件，这时我们就需要利用一个命令&rdquo;flush&rdquo;</h1>

<p>ll /data/mysql/bin_log.0*
-rw-rw&mdash;-. 1 mysql mysql  143 Nov 19 08:17 /data/mysql/bin_log.000001
-rw-rw&mdash;-. 1 mysql mysql  959 Nov 19 08:53 /data/mysql/bin_log.000002
-rw-rw&mdash;-. 1 mysql mysql  653 Nov 19 17:38 /data/mysql/bin_log.000003
-rw-rw&mdash;-. 1 mysql mysql  392 Nov 19 17:46 /data/mysql/bin_log.000004
-rw-rw&mdash;-. 1 mysql mysql  259 Nov 20 22:02 /data/mysql/bin_log.000005
-rw-rw&mdash;-  1 mysql mysql  120 Nov 22 21:02 /data/mysql/bin_log.000006
-rw-rw&mdash;-  1 mysql mysql 6290 Nov 23 01:14 /data/mysql/bin_log.000007</p>

<p>mysql -u root -p -e &ldquo;flush logs&rdquo;
Enter password:</p>

<p>ll /data/mysql/bin_log.0*
-rw-rw&mdash;-. 1 mysql mysql  143 Nov 19 08:17 /data/mysql/bin_log.000001
-rw-rw&mdash;-. 1 mysql mysql  959 Nov 19 08:53 /data/mysql/bin_log.000002
-rw-rw&mdash;-. 1 mysql mysql  653 Nov 19 17:38 /data/mysql/bin_log.000003
-rw-rw&mdash;-. 1 mysql mysql  392 Nov 19 17:46 /data/mysql/bin_log.000004
-rw-rw&mdash;-. 1 mysql mysql  259 Nov 20 22:02 /data/mysql/bin_log.000005
-rw-rw&mdash;-  1 mysql mysql  120 Nov 22 21:02 /data/mysql/bin_log.000006
-rw-rw&mdash;-  1 mysql mysql 6290 Nov 23 01:14 /data/mysql/bin_log.000007
-rw-rw&mdash;-  1 mysql mysql  120 Nov 23 01:14 /data/mysql/bin_log.000008</p>

<h2>执行flush logs之后，系统自动创建新的binlog</h2>

<p>&rdquo;`</p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>