<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/network_tcp-reset.html">网络: TCP - RST简介</a>
            </li>
            <li>
              <a href="/linux/shell/shell_1.0.4_variable_string.html">SHELL: 1.0.4 变量：字符串及字符串切片</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.4_start_init.html">GO 1.1.4 入口函数和包初始化</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.3_build.html">GO 1.1.3 构建应用</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.2_proj_struct.html">GO 1.1.2 目录结构</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
              <ul>
                <li>
                  <a href="/virtualization/container/index.html">container</a>
                  <ul>
                    <li><a href="/virtualization/container/OCI_1.1.0_buildah_in_container.html">OCI 1.1.0 在容器中运行buildah</a></li>
                    <li><a href="/virtualization/container/OCI_1.1.1_buildah_with_insecure_repository.html">OCI 1.1.1 buildah 推送镜像到非https的repository</a></li>
                    <li><a href="/virtualization/container/cgroups_1.0.0_introduction_concept.html">cgroups 1.0.0 什么是cgroups？</a></li>
                    <li><a href="/virtualization/container/container_1.0.1_linux_kernel_user_namespaces.html">container 1.0.1 linux kernel - user namespaces</a></li>
                    <li><a href="/virtualization/container/container_1.1.1_java_encoding_and_container_locale.html">container 1.1.1 java encoding and container locale</a></li>
                    <li><a href="/virtualization/container/coreos_1.1.0_install.html">coreos 1.1.0 系统安装-bare metal</a></li>
                    <li><a href="/virtualization/container/coreos_1.2.0_vagrant_install.html">coreos 1.2.0 系统安装-vagrant</a></li>
                    <li><a href="/virtualization/container/coreos_2.1.0_ignition_intro.html">coreos 2.1.0 ignition简介</a></li>
                    <li><a href="/virtualization/container/coreos_2.2.0_boot_via_pxe_cloudinit.html">coreos 2.2.0 pxe引导coreos启动(cloudinit)</a></li>
                    <li><a href="/virtualization/container/coreos_2.2.1_boot_via_pxe_ignition.html">coreos 2.2.1 pxe引导coreos启动(ignition)</a></li>
                    <li><a href="/virtualization/container/coreos_2.2.2_boot_via_pxe_install.html">coreos 2.2.2 pxe引导coreos启动并安装到硬盘</a></li>
                    <li><a href="/virtualization/container/coreos_2.3.0_boot_via_matchbox_ignition.html">coreos 2.3.0 ignition+matchbox安装coreos集群</a></li>
                    <li><a href="/virtualization/container/coreos_2.4.0_generate-self-signed-certificates.html">coreos 2.4.0 生成ssl/tls自签名认证证书</a></li>
                    <li><a href="/virtualization/container/etcd_1.1.2_install_single_node_systemd.html">etcd 1.1.2 etcd install single node(systemd)</a></li>
                    <li><a href="/virtualization/container/etcd_1.1.3_install_static_cluster_centos6.html">etcd 1.1.3 etcd install static cluster(centos6)</a></li>
                    <li><a href="/virtualization/container/etcd_1.1.4_install_static_cluster_with_ssl_tls.html">etcd 1.1.4 etcd install static cluster with ssl/tls</a></li>
                    <li><a href="/virtualization/container/etcd_1.1.5_install_discovery_cluster_coreos.html">etcd 1.1.5 etcd install discovery cluster(coreos)</a></li>
                    <li><a href="/virtualization/container/etcd_1.1.6_install_discovery_cluster_coreos_systemd.html">etcd 1.1.6 etcd install discovery cluster(coreos)-systemd</a></li>
                    <li><a href="/virtualization/container/etcd_2.1.0_python_api.html">etcd 2.1.0 etcd-api python-etcd</a></li>
                    <li><a href="/virtualization/container/etcd_2.2.0_confd.html">etcd 2.2.0 搭配confd做配置管理</a></li>
                    <li><a href="/virtualization/container/flannel_1.1.0_binary_install_systemd.html">flannel 1.1.0 install flannel using binaries（systemd）</a></li>
                    <li><a href="/virtualization/container/flannel_1.2.0_configuration_and_option.html">flannel 1.2.0 configuration ans option</a></li>
                    <li><a href="/virtualization/container/helm_1.1.0_centos_installation_and_usage.html">helm 1.1.0 安装（centos 7）及使用</a></li>
                    <li><a href="/virtualization/container/helm_1.1.1_chartmuseum.html">helm 1.1.1 chartmuseum</a></li>
                    <li><a href="/virtualization/container/helm_2.1.0_create_tomcat_app.html">helm 2.1.0 从零开始创建tomcat的charts</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.1.0_intro.html">kubernetes 1.1.0 简介</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.0_install_vagrant_coreos_flannel.html">kubernetes 1.2.0 vagrant+coreos(flannel)</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.1_centos_baremetal_cluster_install.html">kubernetes 1.2.1 kubernetes集群安装(centos7裸机)</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.2_centos_baremetal_cluster_install_ssl.html">kubernetes 1.2.2 kubernetes集群加密安装(centos7裸机)</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.3_centos_baremetal_cluster_install_product.html">kubernetes 1.2.3 kubernetes集群安装(生产环境)</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.4_traefik_ingress.html">kubernetes 1.2.4 traefik ingress</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.5_traefik_ingress_ssl.html">kubernetes 1.2.5 ingress ssl</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.6_kube_dns.html">kubernetes 1.2.6 kube-dns</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.2.7_efk.html">kubernetes 1.2.7 EFK</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.3.0_run_stateless_application_deployment.html">kubernetes 1.3.0 run-stateless-application-deployment</a></li>
                    <li><a href="/virtualization/container/kubernetes_1.3.1_guestbook_redis_cluster_and_php_frontend.html">kubernetes 1.3.1 guestbook(php frontend with redis cluster)</a></li>
                    <li><a href="/virtualization/container/kubernetes_2.1.0_cri_containerd_installation.html">kubernetes 2.1.0 CRI containerd installation</a></li>
                    <li><a href="/virtualization/container/kubernetes_v1.17_1.1.0_centos_baremetal_cluster_install_production.html">kubernetes v1.17 1.1.0 kubernetes集群安装(生产环境)</a></li>
                    <li><a href="/virtualization/container/kubernetes_v1.17_1.1.1_pull_image_from_private_registry.html">kubernetes v1.17 1.1.1 pull image from private registry</a></li>
                    <li><a href="/virtualization/container/kubernetes_v1.17_2.1.0_cicd_using_gitlab_and_helm.html">kubernetes v1.17 2.1.0 CI/CD using gitlab and helm</a></li>
                    <li><a href="/virtualization/container/kubernetes_v1.21_1.1.0_centos_baremetal_cluster_install_production.html">kubernetes v1.21 1.1.0 kubernetes集群安装(生产环境)</a></li>
                    <li><a href="/virtualization/container/podman_1.1.0_rootless_tutorial.html">podman: 1.1.0 rootless</a></li>
                    <li><a href="/virtualization/container/podman_config_00_rlimit.html">podman config: 系统资源限制</a></li>
                    <li><a href="/virtualization/container/podman_kownledge_1.0.1_more_security_than_docker.html">podman knowledge 1.0.1 为何podman比docker安全</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/virtualization/docker/index.html">docker</a>
                </li>
                <li>
                  <a href="/virtualization/kvm/index.html">kvm</a>
                </li>
                <li>
                  <a href="/virtualization/openstack/index.html">openstack</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>kubernetes 1.2.3 kubernetes集群安装(生产环境)</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>25 Jan 2018</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>0. 背景介绍</h2>

<h3>1) 参照文档</h3>

<ul>
<li>教程参照文档-<a href="https://www.kubernetes.org.cn/3336.html">[Creating a Custom Cluster from Scratch]</a></li>
</ul>

<h3>2) 软件版本</h3>

<table>
<thead>
<tr>
<th>items</th>
<th>version</th>
<th>comment</th>
</tr>
</thead>

<tbody>
<tr>
<td>OS</td>
<td>centos7</td>
<td>内核版本:	4.4(支持overlay2)</td>
</tr>

<tr>
<td>kubernetes</td>
<td>1.9.1</td>
<td></td>
</tr>

<tr>
<td>docker</td>
<td>17.09.0-ce</td>
<td>Storage	Driver: overlay2 <br>Logging	Driver: journald <br>Cgroup	Driver: systemd</td>
</tr>

<tr>
<td>etcd</td>
<td>v3.2.11</td>
<td></td>
</tr>

<tr>
<td>flannel</td>
<td></td>
<td>使用flannel做overlay网络，支持不同主机间pods间网络互通</td>
</tr>
</tbody>
</table>

<h3>3) 节点规划</h3>

<table>
<thead>
<tr>
<th>hostname</th>
<th>ip address</th>
<th>service</th>
<th>comment</th>
</tr>
</thead>

<tbody>
<tr>
<td>master1</td>
<td>172.16.1.73</td>
<td>kube-apiserver,kube-controller-manager,kube-scheduler</td>
<td>主节点1</td>
</tr>

<tr>
<td>master2</td>
<td>172.16.1.74</td>
<td>kube-apiserver,kube-controller-manager,kube-scheduler</td>
<td>主节点2</td>
</tr>

<tr>
<td>master3</td>
<td>172.16.1.75</td>
<td>kube-apiserver,kube-controller-manager,kube-scheduler</td>
<td>主节点3</td>
</tr>

<tr>
<td>etcd1</td>
<td>172.16.1.76</td>
<td>etcd</td>
<td>etcd 节点1</td>
</tr>

<tr>
<td>etcd2</td>
<td>172.16.1.77</td>
<td>etcd</td>
<td>etcd 节点2</td>
</tr>

<tr>
<td>etcd3</td>
<td>172.16.1.78</td>
<td>etcd</td>
<td>etcd 节点3</td>
</tr>

<tr>
<td>node01</td>
<td>172.16.1.79</td>
<td>flannel,docker,kubelet,kube-proxy</td>
<td>node 节点1</td>
</tr>

<tr>
<td>node02</td>
<td>172.16.1.82</td>
<td>flannel,docker,kubelet,kube-proxy</td>
<td>node 节点2</td>
</tr>

<tr>
<td>node03</td>
<td>172.16.1.83</td>
<td>flannel,docker,kubelet,kube-proxy</td>
<td>node 节点3</td>
</tr>
</tbody>
</table>

<h3>4) 网络规划</h3>

<table>
<thead>
<tr>
<th>网络名称</th>
<th>网段范围</th>
</tr>
</thead>

<tbody>
<tr>
<td>pod网络</td>
<td>10.5.0.0/16</td>
</tr>

<tr>
<td>service网络</td>
<td>10.254.0.0/16</td>
</tr>

<tr>
<td>主机网络</td>
<td>172.16.1.0/24</td>
</tr>
</tbody>
</table>

<hr />

<h2>1. 主机环境</h2>

<p>为了将系统环境和软件环境对安装的影响度降低，需要确保以下几项需求满足</p>

<ul>
<li><p>升级内核(overlay2需求)<br />
<code>rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm; yum --enablerepo=elrepo-kernel install kernel-lt-devel kernel-lt -y</code><br />
查看内核启动顺序,确认默认是新内核<br />
<code>awk -F\' '$1==&quot;menuentry &quot; {print $2}' /etc/grub2.cfg;grub2-set-default 0;reboot</code></p></li>

<li><p>安装必要的工具包<br />
<code>yum install -y wget vim iptables iptables-services</code></p></li>

<li><p>关闭selinux</p>
<pre class="chroma">sed -i <span class="s2">&#34;s/SELINUX=enforcing/SELINUX=disabled/g&#34;</span> /etc/selinux/config
setenforce <span class="m">0</span>
</pre>
<ul>
<li>关闭iptables-services和firewalld<br />
<code>systemctl stop firewalld;systemctl stop iptables</code><br />
&gt; 防火墙后期需要开启，并开放api服务的端口</li>
<li>设定hostname到hosts文件中
<code>bash
echo &quot;172.16.1.73 master1
172.16.1.74 master2
172.16.1.75 master3
172.16.1.76 etcd1
172.16.1.77 etcd2
172.16.1.78 etcd3
172.16.1.79 node01
172.16.1.82 node02
172.16.1.83 node03&quot; &gt;&gt; /etc/hosts
</code></li>
</ul></li>

<li><p>设定sysctl中的net.ipv4.ip_forward = 1</p>
<pre class="chroma"><span class="nb">echo</span> <span class="s2">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
sysctl -p
</pre>
<blockquote>
<p>net.ipv4.ip_forward = 1的配置确保了可以通过映射docker容器端口到外网，否则我们无法通过外网ip访问容器</p>

<ul>
<li>关闭系统swap<br />
<code>bash
swapoff -a
</code></li>
</ul>
</blockquote>
</li>
</ul>

<p>注释swap的开机挂载项，修改<code>/etc/fstab</code></p>
<pre class="chroma">#/dev/mapper/VolGroup00-LogVol01 swap                    swap    defaults        0 0
</pre>
<blockquote>
<p>关闭系统swap，是为了严格的按照cpu和内存的限制，这样scheduler在规划pod的时候就不会把pod放进swap中了，这是为了性能考虑。</p>
</blockquote>

<!--
- 安装ipvsadm  
`yum install ipvsadm -y`
安装kube-router才需要这个
-->

<hr />

<h2>2. 准备 k8s、etcd、flanneld、docker二进制文件</h2>

<p>master1上准备二进制文件，统一下发给所有其他机器，所以提前做好ssh信任</p>

<h3>0) 准备各节点二进制文件目录</h3>
<pre class="chroma">mkdir -p /root/k8s/<span class="o">{</span>node,master,etcd,base<span class="o">}</span>/bin
</pre>
<blockquote>
<p>base目录存放flanneld和docker文件</p>
</blockquote>

<h3>1) 下载二进制文件</h3>
<pre class="chroma"><span class="nb">cd</span> /root
<span class="c1"># 下载kubernetes</span>
<span class="nv">K8S_VER</span><span class="o">=</span>v1.9.1
wget https://dl.k8s.io/<span class="si">${</span><span class="nv">K8S_VER</span><span class="si">}</span>/kubernetes-server-linux-amd64.tar.gz
tar zxvf kubernetes-server-linux-amd64.tar.gz
cp kubernetes/server/bin/<span class="o">{</span>kube-apiserver,kube-scheduler,kube-controller-manager,kubectl<span class="o">}</span> k8s/master/bin
cp kubernetes/server/bin/<span class="o">{</span>kubelet,kube-proxy<span class="o">}</span> k8s/node/bin

<span class="c1"># 下载etcd</span>
<span class="nv">ETCD_VER</span><span class="o">=</span>v3.2.11
<span class="nv">DOWNLOAD_URL</span><span class="o">=</span>https://github.com/coreos/etcd/releases/download
curl -L <span class="si">${</span><span class="nv">DOWNLOAD_URL</span><span class="si">}</span>/<span class="si">${</span><span class="nv">ETCD_VER</span><span class="si">}</span>/etcd-<span class="si">${</span><span class="nv">ETCD_VER</span><span class="si">}</span>-linux-amd64.tar.gz -o etcd-<span class="si">${</span><span class="nv">ETCD_VER</span><span class="si">}</span>-linux-amd64.tar.gz
tar xzvf etcd-<span class="si">${</span><span class="nv">ETCD_VER</span><span class="si">}</span>-linux-amd64.tar.gz
cp etcd-<span class="si">${</span><span class="nv">ETCD_VER</span><span class="si">}</span>-linux-amd64/<span class="o">{</span>etcd,etcdctl<span class="o">}</span> k8s/etcd/bin/

<span class="c1"># 下载flannel</span>
<span class="nv">FLANNEL_VER</span><span class="o">=</span>v0.9.1
wget https://github.com/coreos/flannel/releases/download/<span class="si">${</span><span class="nv">FLANNEL_VER</span><span class="si">}</span>/flannel-<span class="si">${</span><span class="nv">FLANNEL_VER</span><span class="si">}</span>-linux-amd64.tar.gz
mkdir flannel
tar zxvf flannel-<span class="si">${</span><span class="nv">FLANNEL_VER</span><span class="si">}</span>-linux-amd64.tar.gz -C flannel
cp flannel/<span class="o">{</span>flanneld,mk-docker-opts.sh<span class="o">}</span> k8s/base/bin

<span class="c1"># 下载docker</span>
<span class="nv">DOCKER_VER</span><span class="o">=</span>17.09.0
wget https://download.docker.com/linux/static/stable/x86_64/docker-<span class="si">${</span><span class="nv">DOCKER_VER</span><span class="si">}</span>-ce.tgz
tar zxvf docker-<span class="si">${</span><span class="nv">DOCKER_VER</span><span class="si">}</span>-ce.tgz
wget https://github.com/docker/compose/releases/download/1.17.1/docker-compose-Linux-x86_64 -O docker-compose
mv docker-compose docker/docker-compose
cp docker/* k8s/base/bin
</pre>
<h3>2) 分发二进制文件</h3>
<pre class="chroma">chmod +x k8s/etcd/bin/*
chmod +x k8s/node/bin/*
chmod +x k8s/master/bin/*
chmod +x k8s/base/bin/*

<span class="c1"># 下发flanneld和docker二进制文件到所有节点</span>
cp /root/k8s/base/bin/* /usr/local/bin
<span class="k">for</span> target in <span class="o">{</span>master2,master3,node01,node02,node03<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  rsync -av /root/k8s/base/bin/ <span class="si">${</span><span class="nv">target</span><span class="si">}</span>:/usr/local/bin
<span class="k">done</span>

<span class="c1"># 下发master二进制文件</span>
cp /root/k8s/master/bin/* /usr/local/bin
<span class="k">for</span> master in <span class="o">{</span>master2,master3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  rsync -av /root/k8s/master/bin/ <span class="si">${</span><span class="nv">master</span><span class="si">}</span>:/usr/local/bin/
<span class="k">done</span>

<span class="c1"># 下发node二进制文件</span>
<span class="k">for</span> node in <span class="o">{</span>node01,node02,node03<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  rsync -av /root/k8s/node/bin/ <span class="si">${</span><span class="nv">node</span><span class="si">}</span>:/usr/local/bin/
<span class="k">done</span>

<span class="c1"># 下发etcd二进制文件</span>
<span class="k">for</span> etcd in <span class="o">{</span>etcd1,etcd2,etcd3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  rsync -av /root/k8s/etcd/bin/ <span class="si">${</span><span class="nv">etcd</span><span class="si">}</span>:/usr/local/bin/
<span class="k">done</span>
</pre>
<hr />

<h2>3. 准备master、node、etcd - systemd unit文件</h2>

<h3>0) 创建各节点unit文件目录</h3>
<pre class="chroma">mkdir -p /root/k8s/<span class="o">{</span>node,master,etcd,base<span class="o">}</span>/service
</pre>
<h3>1) 创建master所需unit文件</h3>

<p>需要各master节点根据自身调整ip地址</p>
<pre class="chroma"><span class="c1"># kube-apiserver.service</span>
<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Kubernetes API Server
</span><span class="s1">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s1">After=network.target
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">ExecStart=/usr/local/bin/kube-apiserver \
</span><span class="s1">  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \
</span><span class="s1">  --advertise-address=172.16.1.73 \
</span><span class="s1">  --bind-address=172.16.1.73 \
</span><span class="s1">  --insecure-bind-address=127.0.0.1 \
</span><span class="s1">  --kubelet-https=true \
</span><span class="s1">  --runtime-config=rbac.authorization.k8s.io/v1beta1 \
</span><span class="s1">  --authorization-mode=RBAC,Node \
</span><span class="s1">  --enable-bootstrap-token-auth \
</span><span class="s1">  --token-auth-file=/etc/kubernetes/ssl/token.csv \
</span><span class="s1">  --service-cluster-ip-range=10.254.0.0/16 \
</span><span class="s1">  --service-node-port-range=30000-32767 \
</span><span class="s1">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \
</span><span class="s1">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \
</span><span class="s1">  --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem \
</span><span class="s1">  --service-account-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem \
</span><span class="s1">  --etcd-cafile=/etc/kubernetes/ssl/k8s-root-ca.pem \
</span><span class="s1">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \
</span><span class="s1">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \
</span><span class="s1">  --etcd-servers=https://172.16.1.76:2379,https://172.16.1.77:2379,https://172.16.1.78:2379 \
</span><span class="s1">  --enable-swagger-ui=true \
</span><span class="s1">  --allow-privileged=true \
</span><span class="s1">  --apiserver-count=3 \
</span><span class="s1">  --audit-log-maxage=30 \
</span><span class="s1">  --audit-log-maxbackup=3 \
</span><span class="s1">  --audit-log-maxsize=100 \
</span><span class="s1">  --audit-log-path=/var/lib/audit.log \
</span><span class="s1">  --event-ttl=1h \
</span><span class="s1">  --v=2
</span><span class="s1">Restart=on-failure
</span><span class="s1">RestartSec=5
</span><span class="s1">Type=notify
</span><span class="s1">LimitNOFILE=65536
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /root/k8s/master/service/kube-apiserver.service

<span class="c1"># kube-controller-manager.service</span>
<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Kubernetes Controller Manager
</span><span class="s1">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">ExecStart=/usr/local/bin/kube-controller-manager \
</span><span class="s1">  --address=127.0.0.1 \
</span><span class="s1">  --master=http://127.0.0.1:8080 \
</span><span class="s1">  --allocate-node-cidrs=true \
</span><span class="s1">  --service-cluster-ip-range=10.254.0.0/16 \
</span><span class="s1">  --cluster-cidr=10.5.0.0/16 \
</span><span class="s1">  --cluster-name=kubernetes \
</span><span class="s1">  --cluster-signing-cert-file=/etc/kubernetes/ssl/k8s-root-ca.pem \
</span><span class="s1">  --cluster-signing-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem \
</span><span class="s1">  --service-account-private-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem \
</span><span class="s1">  --root-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem \
</span><span class="s1">  --leader-elect=true \
</span><span class="s1">  --v=2
</span><span class="s1">Restart=on-failure
</span><span class="s1">RestartSec=5
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /root/k8s/master/service/kube-controller-manager.service  

<span class="c1"># kube-scheduler.service</span>
<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Kubernetes Scheduler
</span><span class="s1">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">ExecStart=/usr/local/bin/kube-scheduler \
</span><span class="s1">  --address=127.0.0.1 \
</span><span class="s1">  --master=http://127.0.0.1:8080 \
</span><span class="s1">  --leader-elect=true \
</span><span class="s1">  --v=2
</span><span class="s1">Restart=on-failure
</span><span class="s1">RestartSec=5
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /root/k8s/master/service/kube-scheduler.service
</pre>
<h3>2) 创建etcd所需unit文件</h3>
<pre class="chroma"><span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Etcd Server
</span><span class="s1">After=network.target
</span><span class="s1">After=network-online.target
</span><span class="s1">Wants=network-online.target
</span><span class="s1">Documentation=https://github.com/coreos
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">Type=notify
</span><span class="s1">WorkingDirectory=/var/lib/etcd/
</span><span class="s1">EnvironmentFile=-/etc/etcd/etcd.conf
</span><span class="s1">ExecStart=/usr/local/bin/etcd \
</span><span class="s1">  --name=etcd01 \
</span><span class="s1">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \
</span><span class="s1">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \
</span><span class="s1">  --peer-cert-file=/etc/kubernetes/ssl/kubernetes.pem \
</span><span class="s1">  --peer-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \
</span><span class="s1">  --trusted-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem \
</span><span class="s1">  --peer-trusted-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem \
</span><span class="s1">  --initial-advertise-peer-urls=https://172.16.1.76:2380 \
</span><span class="s1">  --listen-peer-urls=https://172.16.1.76:2380 \
</span><span class="s1">  --listen-client-urls=https://172.16.1.76:2379,http://127.0.0.1:2379 \
</span><span class="s1">  --advertise-client-urls=https://172.16.1.76:2379 \
</span><span class="s1">  --initial-cluster-token=etcd-cluster-0 \
</span><span class="s1">  --initial-cluster=etcd01=https://172.16.1.76:2380,etcd02=https://172.16.1.77:2380,etcd03=https://172.16.1.78:2380 \
</span><span class="s1">  --initial-cluster-state=new \
</span><span class="s1">  --data-dir=/var/lib/etcd
</span><span class="s1">Restart=on-failure
</span><span class="s1">RestartSec=5
</span><span class="s1">LimitNOFILE=65536
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /root/k8s/etcd/service/etcd.service
</pre>
<h3>3) 创建node所需unit文件</h3>
<pre class="chroma"><span class="c1"># kubelet.service</span>
<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Kubernetes Kubelet
</span><span class="s1">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s1">After=docker.service
</span><span class="s1">Requires=docker.service
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">WorkingDirectory=/var/lib/kubelet
</span><span class="s1">ExecStart=/usr/local/bin/kubelet \
</span><span class="s1">  --address=172.16.1.79 \
</span><span class="s1">  --hostname-override=node01 \
</span><span class="s1">  --pod-infra-container-image=k8s.gcr.io/pause-amd64:3.0 \
</span><span class="s1">  --experimental-bootstrap-kubeconfig=/etc/kubernetes/ssl/bootstrap.kubeconfig \
</span><span class="s1">  --kubeconfig=/etc/kubernetes/ssl/kubelet.kubeconfig \
</span><span class="s1">  --cert-dir=/etc/kubernetes/ssl \
</span><span class="s1">  --hairpin-mode promiscuous-bridge \
</span><span class="s1">  --allow-privileged=true \
</span><span class="s1">  --serialize-image-pulls=false \
</span><span class="s1">  --logtostderr=true \
</span><span class="s1">  --cgroup-driver=systemd \
</span><span class="s1">  --cluster_dns=10.254.0.2 \
</span><span class="s1">  --cluster_domain=cluster.local \
</span><span class="s1">  --v=2
</span><span class="s1">Restart=on-failure
</span><span class="s1">RestartSec=5
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /root/k8s/node/service/kubelet.service

<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Kubernetes Kube-Proxy Server
</span><span class="s1">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s1">After=network.target
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">ExecStart=/usr/local/bin/kube-proxy \
</span><span class="s1">  --logtostderr=true \
</span><span class="s1">  --v=0 \
</span><span class="s1">  --master=https://172.16.1.73:6443 \
</span><span class="s1">  --bind-address=172.16.1.79 \
</span><span class="s1">  --hostname-override= \
</span><span class="s1">  --kubeconfig=/etc/kubernetes/ssl/kube-proxy.kubeconfig \
</span><span class="s1">  --cluster-cidr=10.254.0.0/16
</span><span class="s1">Restart=on-failure
</span><span class="s1">LimitNOFILE=65536
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /root/k8s/node/service/kube-proxy.service
</pre>
<h3>4) 创建flanneld和docker unit文件</h3>
<pre class="chroma"><span class="c1"># flanneld.service</span>
<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Flanneld overlay address etcd agent
</span><span class="s1">After=network.target
</span><span class="s1">After=network-online.target
</span><span class="s1">Wants=network-online.target
</span><span class="s1">After=etcd.service
</span><span class="s1">Before=docker.service
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">Type=notify
</span><span class="s1">ExecStart=/usr/local/bin/flanneld \
</span><span class="s1">  -etcd-cafile=/etc/kubernetes/ssl/k8s-root-ca.pem \
</span><span class="s1">  -etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \
</span><span class="s1">  -etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \
</span><span class="s1">  -etcd-endpoints=https://172.16.1.76:2379,https://172.16.1.77:2379,https://172.16.1.78:2379 \
</span><span class="s1">  -etcd-prefix=/kubernetes/network \
</span><span class="s1">  -iface=eth1
</span><span class="s1">ExecStartPost=/usr/local/bin/mk-docker-opts.sh -c
</span><span class="s1">Restart=on-failure
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target
</span><span class="s1">RequiredBy=docker.service&#39;</span> &gt; /root/k8s/base/service/flanneld.service

<span class="c1"># docker配置文件</span>
<span class="nb">echo</span> <span class="s1">&#39;{
</span><span class="s1">  &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span><span class="s1">  &#34;storage-opts&#34;: [
</span><span class="s1">    &#34;overlay2.override_kernel_check=true&#34;
</span><span class="s1">  ]
</span><span class="s1">}&#39;</span> &gt; /root/k8s/base/daemon.json

<span class="c1"># docker.service</span>
<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Docker Application Container Engine
</span><span class="s1">Documentation=http://docs.docker.com
</span><span class="s1">After=network-online.target docker.socket flannel.service
</span><span class="s1">Wants=network-online.target
</span><span class="s1">Requires=docker.socket
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">Type=notify
</span><span class="s1">NotifyAccess=all
</span><span class="s1">KillMode=process
</span><span class="s1">EnvironmentFile=/run/docker_opts.env
</span><span class="s1">Environment=GOTRACEBACK=crash
</span><span class="s1">Environment=DOCKER_HTTP_HOST_COMPAT=1
</span><span class="s1">ExecStart=/usr/local/bin/dockerd \
</span><span class="s1">  --exec-opt native.cgroupdriver=systemd \
</span><span class="s1">  --config-file=/etc/docker/daemon.json \
</span><span class="s1">  -H fd:// $DOCKER_OPTS
</span><span class="s1">ExecReload=/bin/kill -s HUP $MAINPID
</span><span class="s1">LimitNOFILE=1048576
</span><span class="s1">LimitNPROC=1048576
</span><span class="s1">LimitCORE=infinity
</span><span class="s1">TimeoutStartSec=0
</span><span class="s1">Delegate=yes
</span><span class="s1">Restart=on-failure
</span><span class="s1">MountFlags=slave
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /root/k8s/base/service/docker.service

<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Docker Socket for the API
</span><span class="s1">PartOf=docker.service
</span><span class="s1">
</span><span class="s1">[Socket]
</span><span class="s1">ListenStream=/var/run/docker.sock
</span><span class="s1">SocketMode=0660
</span><span class="s1">#SocketUser=root
</span><span class="s1">#SocketGroup=docker
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=sockets.target&#39;</span> &gt; /root/k8s/base/service/docker.socket
</pre>
<h3>5) 下发systemd unit文件</h3>
<pre class="chroma"><span class="c1"># 下发flanneldhedocker文件</span>
mkdir -p /etc/docker
cp /root/k8s/base/daemon.json /etc/docker
cp /root/k8s/base/service/* /usr/lib/systemd/system
<span class="k">for</span> target in <span class="o">{</span>master2,master3,node01,node02,node03<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="nv">$target</span> <span class="s2">&#34;mkdir -p /etc/docker&#34;</span>
  rsync -av /root/k8s/base/daemon.json <span class="si">${</span><span class="nv">target</span><span class="si">}</span>:/etc/docker
  rsync -av /root/k8s/base/service/ <span class="si">${</span><span class="nv">target</span><span class="si">}</span>:/usr/lib/systemd/system
<span class="k">done</span>

<span class="c1"># 下发master unit文件</span>
cp /root/k8s/master/service/* /usr/lib/systemd/system
<span class="k">for</span> master in <span class="o">{</span>master2,master3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  rsync -av /root/k8s/master/service/ <span class="si">${</span><span class="nv">master</span><span class="si">}</span>:/usr/lib/systemd/system
<span class="k">done</span>
<span class="c1">#注意更改master里面的ip为各节点ip</span>

<span class="c1"># 下发node unit文件</span>
<span class="k">for</span> node in <span class="o">{</span>node01,node02,node03<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  rsync -av /root/k8s/node/service/ <span class="si">${</span><span class="nv">node</span><span class="si">}</span>:/usr/lib/systemd/system
<span class="k">done</span>
<span class="c1">#注意更改node里面的ip为各节点ip</span>

<span class="c1"># 下发etcd unit文件</span>
<span class="k">for</span> etcd in <span class="o">{</span>etcd1,etcd2,etcd3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  rsync -av /root/k8s/etcd/service/ <span class="si">${</span><span class="nv">etcd</span><span class="si">}</span>:/usr/lib/systemd/system
<span class="k">done</span>
<span class="c1">#注意更改etcd里面的ip为各节点ip</span>
</pre>
<hr />

<h2>4. 生成k8s集群认证文件</h2>

<h3>1) 安装cfssl</h3>
<pre class="chroma">curl -s -L -o /usr/local/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
curl -s -L -o /usr/local/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
curl -s -L -o /usr/local/bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x /usr/local/bin/*
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/bin
</pre>
<h3>2) 创建json文件</h3>

<p>创建k8s-ssl目录</p>
<pre class="chroma">mkdir /root/k8s-ssl
<span class="nb">cd</span> /root/k8s-ssl
</pre>
<blockquote>
<p>此目录只是临时存放ca生成文件，可随意更换位置</p>
</blockquote>

<p>创建 CA 证书签名请求</p>
<pre class="chroma">cat &gt; k8s-root-ca-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">{
</span><span class="s">  &#34;CN&#34;: &#34;kubernetes&#34;,
</span><span class="s">  &#34;key&#34;: {
</span><span class="s">    &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">    &#34;size&#34;: 4096
</span><span class="s">  },
</span><span class="s">  &#34;names&#34;: [
</span><span class="s">    {
</span><span class="s">      &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;O&#34;: &#34;k8s&#34;,
</span><span class="s">      &#34;OU&#34;: &#34;System&#34;
</span><span class="s">    }
</span><span class="s">  ]
</span><span class="s">}
</span><span class="s">EOF</span>
</pre>
<p>生成 CA 证书和私钥</p>
<pre class="chroma">cfssl gencert -initca k8s-root-ca-csr.json <span class="p">|</span> cfssljson -bare k8s-root-ca

ls k8s-root-ca*
k8s-root-ca-csr.json  k8s-root-ca-key.pem  k8s-root-ca.csr  k8s-root-ca.pem
</pre>
<p>创建CA配置文件</p>
<pre class="chroma">cat &gt; ca-config.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">  &#34;signing&#34;: {
</span><span class="s">    &#34;default&#34;: {
</span><span class="s">      &#34;expiry&#34;: &#34;87600h&#34;
</span><span class="s">    },
</span><span class="s">    &#34;profiles&#34;: {
</span><span class="s">      &#34;kubernetes&#34;: {
</span><span class="s">        &#34;usages&#34;: [
</span><span class="s">            &#34;signing&#34;,
</span><span class="s">            &#34;key encipherment&#34;,
</span><span class="s">            &#34;server auth&#34;,
</span><span class="s">            &#34;client auth&#34;
</span><span class="s">        ],
</span><span class="s">        &#34;expiry&#34;: &#34;87600h&#34;
</span><span class="s">      }
</span><span class="s">    }
</span><span class="s">  }
</span><span class="s">}
</span><span class="s">EOF</span>
</pre>
<p>创建 kubernets 证书</p>
<pre class="chroma">cat &gt; kubernetes-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">{
</span><span class="s">    &#34;CN&#34;: &#34;kubernetes&#34;,
</span><span class="s">    &#34;hosts&#34;: [
</span><span class="s">      &#34;127.0.0.1&#34;,
</span><span class="s">      &#34;172.16.1.73&#34;,
</span><span class="s">      &#34;172.16.1.74&#34;,
</span><span class="s">      &#34;172.16.1.75&#34;,
</span><span class="s">      &#34;172.16.1.76&#34;,
</span><span class="s">      &#34;172.16.1.77&#34;,
</span><span class="s">      &#34;172.16.1.78&#34;,
</span><span class="s">      &#34;172.16.1.79&#34;,
</span><span class="s">      &#34;172.16.1.82&#34;,
</span><span class="s">      &#34;172.16.1.83&#34;,
</span><span class="s">      &#34;10.254.0.1&#34;,
</span><span class="s">      &#34;kubernetes&#34;,
</span><span class="s">      &#34;kubernetes.default&#34;,
</span><span class="s">      &#34;kubernetes.default.svc&#34;,
</span><span class="s">      &#34;kubernetes.default.svc.cluster&#34;,
</span><span class="s">      &#34;kubernetes.default.svc.cluster.local&#34;
</span><span class="s">    ],
</span><span class="s">    &#34;key&#34;: {
</span><span class="s">        &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">        &#34;size&#34;: 2048
</span><span class="s">    },
</span><span class="s">    &#34;names&#34;: [
</span><span class="s">        {
</span><span class="s">            &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">            &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">            &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">            &#34;O&#34;: &#34;k8s&#34;,
</span><span class="s">            &#34;OU&#34;: &#34;System&#34;
</span><span class="s">        }
</span><span class="s">    ]
</span><span class="s">}
</span><span class="s">EOF</span>
</pre>
<blockquote>
<p><a href="https://kubernetes.io/docs/concepts/cluster-administration/certificates/">注</a><br />
以上物理节点的IP也可以更换为主机名。</p>
</blockquote>

<p>生成 kubernetes 证书和私钥</p>
<pre class="chroma">cfssl gencert -ca<span class="o">=</span>k8s-root-ca.pem -ca-key<span class="o">=</span>k8s-root-ca-key.pem -config<span class="o">=</span>ca-config.json -profile<span class="o">=</span>kubernetes kubernetes-csr.json <span class="p">|</span> cfssljson -bare kubernetes

ls kubernetes*
kubernetes-csr.json  kubernetes-key.pem  kubernetes.csr  kubernetes.pem
</pre>
<p>创建 admin 证书</p>
<pre class="chroma">cat &gt; admin-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">{
</span><span class="s">  &#34;CN&#34;: &#34;admin&#34;,
</span><span class="s">  &#34;hosts&#34;: [],
</span><span class="s">  &#34;key&#34;: {
</span><span class="s">    &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">    &#34;size&#34;: 2048
</span><span class="s">  },
</span><span class="s">  &#34;names&#34;: [
</span><span class="s">    {
</span><span class="s">      &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;O&#34;: &#34;system:masters&#34;,
</span><span class="s">      &#34;OU&#34;: &#34;System&#34;
</span><span class="s">    }
</span><span class="s">  ]
</span><span class="s">}
</span><span class="s">EOF</span>
</pre>
<p>生成 admin 证书和私钥：</p>
<pre class="chroma">cfssl gencert -ca<span class="o">=</span>k8s-root-ca.pem -ca-key<span class="o">=</span>k8s-root-ca-key.pem -config<span class="o">=</span>ca-config.json -profile<span class="o">=</span>kubernetes admin-csr.json <span class="p">|</span> cfssljson -bare admin

ls admin*
admin-csr.json  admin-key.pem  admin.csr  admin.pem
</pre>
<p>创建 kube-proxy 证书</p>
<pre class="chroma">cat &gt; kube-proxy-csr.json <span class="s">&lt;&lt; EOF
</span><span class="s">{
</span><span class="s">  &#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span><span class="s">  &#34;hosts&#34;: [],
</span><span class="s">  &#34;key&#34;: {
</span><span class="s">    &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">    &#34;size&#34;: 2048
</span><span class="s">  },
</span><span class="s">  &#34;names&#34;: [
</span><span class="s">    {
</span><span class="s">      &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;O&#34;: &#34;k8s&#34;,
</span><span class="s">      &#34;OU&#34;: &#34;System&#34;
</span><span class="s">    }
</span><span class="s">  ]
</span><span class="s">}
</span><span class="s">EOF</span>
</pre>
<p>生成 kube-proxy 客户端证书和私钥</p>
<pre class="chroma">cfssl gencert -ca<span class="o">=</span>k8s-root-ca.pem -ca-key<span class="o">=</span>k8s-root-ca-key.pem -config<span class="o">=</span>ca-config.json -profile<span class="o">=</span>kubernetes  kube-proxy-csr.json <span class="p">|</span> cfssljson -bare kube-proxy

ls kube-proxy*
kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.csr  kube-proxy.pem
</pre>
<p>校验证书</p>
<pre class="chroma">cfssl-certinfo -cert kubernetes.pem
</pre>
<h3>3) 分发证书</h3>
<pre class="chroma"><span class="nb">cd</span> /root/k8s-ssl
<span class="c1"># 下发证书到master</span>
mkdir -p /etc/kubernetes/ssl
cp <span class="o">{</span>k8s-root-ca.pem,k8s-root-ca-key.pem,admin.pem,admin-key.pem,kubernetes.pem,kubernetes-key.pem<span class="o">}</span> /etc/kubernetes/ssl
<span class="k">for</span> master in <span class="o">{</span>master2,master3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="nv">$master</span> <span class="s2">&#34;mkdir -p /etc/kubernetes/ssl&#34;</span>
  scp <span class="o">{</span>k8s-root-ca.pem,k8s-root-ca-key.pem,admin.pem,admin-key.pem,kubernetes.pem,kubernetes-key.pem<span class="o">}</span> root@<span class="nv">$master</span>:/etc/kubernetes/ssl
<span class="k">done</span>

<span class="c1"># 下发证书到node</span>
<span class="k">for</span> node in <span class="o">{</span>node01,node02,node03<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="nv">$node</span> <span class="s2">&#34;mkdir -p /etc/kubernetes/ssl&#34;</span>
  scp <span class="o">{</span>k8s-root-ca.pem,kube-proxy.pem,kube-proxy-key.pem,kubernetes.pem,kubernetes-key.pem<span class="o">}</span> root@<span class="nv">$node</span>:/etc/kubernetes/ssl
<span class="k">done</span>

<span class="c1"># 下发证书到etcd</span>
<span class="k">for</span> etcd in <span class="o">{</span>etcd1,etcd2,etcd3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="nv">$etcd</span> <span class="s2">&#34;mkdir -p /etc/kubernetes/ssl&#34;</span>
  scp <span class="o">{</span>k8s-root-ca.pem,kubernetes.pem,kubernetes-key.pem<span class="o">}</span> root@<span class="nv">$etcd</span>:/etc/kubernetes/ssl
<span class="k">done</span>
</pre>
<h2>5. 生成kubeconfig</h2>

<h3>1) 创建 TLS Bootstrapping Token**</h3>

<p>创建k8s-config目录</p>
<pre class="chroma">mkdir -p /root/k8s-config
<span class="nb">cd</span> /root/k8s-config
</pre>
<p>Token可以是任意的包涵128 bit的字符串，可以使用安全的随机数发生器生成。</p>
<pre class="chroma"><span class="nb">export</span> <span class="nv">BOOTSTRAP_TOKEN</span><span class="o">=</span><span class="k">$(</span>head -c <span class="m">16</span> /dev/urandom <span class="p">|</span> od -An -t x <span class="p">|</span> tr -d <span class="s1">&#39; &#39;</span><span class="k">)</span>
cat &gt; token.csv <span class="s">&lt;&lt;EOF
</span><span class="s">${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,&#34;system:kubelet-bootstrap&#34;
</span><span class="s">EOF</span>
</pre>
<blockquote>
<p>注意：在进行后续操作前请检查 token.csv 文件，确认其中的 ${BOOTSTRAP_TOKEN} 环境变量已经被真实的值替换。</p>
</blockquote>

<p><strong>创建 kubelet bootstrapping kubeconfig 文件</strong></p>
<pre class="chroma"><span class="nb">export</span> <span class="nv">KUBE_APISERVER</span><span class="o">=</span><span class="s2">&#34;https://172.16.1.73:6443&#34;</span>

<span class="c1"># 设置集群参数</span>
kubectl config set-cluster kubernetes <span class="se">\
</span><span class="se"></span>  --certificate-authority<span class="o">=</span>/etc/kubernetes/ssl/k8s-root-ca.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --server<span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>bootstrap.kubeconfig

<span class="c1"># 设置客户端认证参数</span>
kubectl config set-credentials kubelet-bootstrap <span class="se">\
</span><span class="se"></span>  --token<span class="o">=</span><span class="si">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>bootstrap.kubeconfig

<span class="c1"># 设置上下文参数</span>
kubectl config set-context default <span class="se">\
</span><span class="se"></span>  --cluster<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>  --user<span class="o">=</span>kubelet-bootstrap <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>bootstrap.kubeconfig

<span class="c1"># 设置默认上下文</span>
kubectl config use-context default --kubeconfig<span class="o">=</span>bootstrap.kubeconfig
</pre>
<p><strong>创建 kube-proxy kubeconfig 文件</strong></p>
<pre class="chroma"><span class="nb">export</span> <span class="nv">KUBE_APISERVER</span><span class="o">=</span><span class="s2">&#34;https://172.16.1.73:6443&#34;</span>

<span class="c1"># 设置集群参数</span>
kubectl config set-cluster kubernetes <span class="se">\
</span><span class="se"></span>  --certificate-authority<span class="o">=</span>/etc/kubernetes/ssl/k8s-root-ca.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --server<span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig

<span class="c1"># 设置客户端认证参数</span>
kubectl config set-credentials kube-proxy <span class="se">\
</span><span class="se"></span>  --client-certificate<span class="o">=</span>/root/k8s-ssl/kube-proxy.pem <span class="se">\
</span><span class="se"></span>  --client-key<span class="o">=</span>/root/k8s-ssl/kube-proxy-key.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig

<span class="c1"># 设置上下文参数</span>
kubectl config set-context default <span class="se">\
</span><span class="se"></span>  --cluster<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>  --user<span class="o">=</span>kube-proxy <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig

<span class="c1"># 设置默认上下文</span>
kubectl config use-context default --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig
</pre>
<p><strong>配置kubectl admin kubeconfig文件</strong></p>
<pre class="chroma"><span class="nb">export</span> <span class="nv">KUBE_APISERVER</span><span class="o">=</span><span class="s2">&#34;https://172.16.1.73:6443&#34;</span>

<span class="c1"># 设置集群参数</span>
kubectl config set-cluster kubernetes <span class="se">\
</span><span class="se"></span>  --certificate-authority<span class="o">=</span>/etc/kubernetes/ssl/k8s-root-ca.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --server<span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span>

<span class="c1"># 设置客户端认证参数</span>
kubectl config set-credentials admin <span class="se">\
</span><span class="se"></span>  --client-certificate<span class="o">=</span>/etc/kubernetes/ssl/admin.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --client-key<span class="o">=</span>/etc/kubernetes/ssl/admin-key.pem

<span class="c1"># 设置上下文参数</span>
kubectl config set-context kubernetes <span class="se">\
</span><span class="se"></span>  --cluster<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>  --user<span class="o">=</span>admin

<span class="c1"># 设置默认上下文</span>
kubectl config use-context kubernetes
</pre>
<p><strong>分发 kubeconfig 文件</strong></p>
<pre class="chroma"><span class="nb">cd</span> /root/k8s-config/
<span class="c1"># 将bootstrap.kubeconfig和kube-proxy.kubeconfig分发到node节点</span>
<span class="k">for</span> node in <span class="o">{</span>node01,node02,node03<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  scp /root/k8s-config/<span class="o">{</span>bootstrap.kubeconfig,kube-proxy.kubeconfig<span class="o">}</span> root@<span class="nv">$node</span>:/etc/kubernetes/ssl
<span class="k">done</span>

<span class="c1"># 将master1节点上的admin配置分发到其他master上</span>
cp /root/k8s-config/token.csv /etc/kubernetes/ssl
<span class="k">for</span> master in <span class="o">{</span>master2,master3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="nv">$master</span> <span class="s2">&#34;mkdir -p /root/.kube&#34;</span>
  scp /root/.kube/config root@<span class="nv">$master</span>:/root/.kube/
  scp /root/k8s-config/token.csv root@<span class="nv">$master</span>:/etc/kubernetes/ssl
<span class="k">done</span>
</pre>
<h2>6. 启动服务</h2>

<h3>1) etcd节点</h3>

<p><strong>!!! 启动服务之前，务必检查systemd unit文件是否根据各节点自身情况进行修改 !!!</strong></p>
<pre class="chroma"><span class="k">for</span> etcd in <span class="o">{</span>etcd1,etcd2,etcd3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="nv">$etcd</span> <span class="s2">&#34;mkdir -p /var/lib/etcd&#34;</span>
  ssh root@<span class="nv">$etcd</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl start etcd&#34;</span>
<span class="k">done</span>

etcdctl <span class="se">\
</span><span class="se"></span>  --endpoints https://172.16.1.76:2379,https://172.16.1.77:2379,https://172.16.1.78:2379 <span class="se">\
</span><span class="se"></span>  --ca-file<span class="o">=</span>/etc/kubernetes/ssl/k8s-root-ca.pem <span class="se">\
</span><span class="se"></span>  --cert-file<span class="o">=</span>/etc/kubernetes/ssl/kubernetes.pem <span class="se">\
</span><span class="se"></span>  --key-file<span class="o">=</span>/etc/kubernetes/ssl/kubernetes-key.pem <span class="se">\
</span><span class="se"></span>  cluster-health

etcdctl <span class="se">\
</span><span class="se"></span>  --endpoints https://172.16.1.76:2379,https://172.16.1.77:2379,https://172.16.1.78:2379 <span class="se">\
</span><span class="se"></span>  --ca-file<span class="o">=</span>/etc/kubernetes/ssl/k8s-root-ca.pem <span class="se">\
</span><span class="se"></span>  --cert-file<span class="o">=</span>/etc/kubernetes/ssl/kubernetes.pem <span class="se">\
</span><span class="se"></span>  --key-file<span class="o">=</span>/etc/kubernetes/ssl/kubernetes-key.pem <span class="se">\
</span><span class="se"></span>  <span class="nb">set</span> /kubernetes/network/config <span class="s1">&#39;{ &#34;Network&#34;: &#34;10.5.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;vxlan&#34;}}&#39;</span>
</pre>
<h3>2) master节点</h3>

<p><strong>!!! 启动服务之前，务必检查systemd unit文件是否根据各节点自身情况进行修改 !!!</strong></p>
<pre class="chroma">systemctl daemon-reload
systemctl start flanneld docker kube-apiserver kube-controller-manager kube-scheduler
systemctl <span class="nb">enable</span> flanneld docker kube-apiserver kube-controller-manager kube-scheduler
<span class="k">for</span> master in <span class="o">{</span>master2,master3<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="nv">$master</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl start flanneld docker kube-apiserver kube-controller-manager kube-scheduler &amp;&amp; systemctl enable flanneld docker kube-apiserver kube-controller-manager kube-scheduler&#34;</span>
<span class="k">done</span>
</pre>
<h3>3) node节点</h3>

<p>kubelet 启动时向 kube-apiserver 发送 TLS bootstrapping 请求，需要先将 bootstrap token 文件中的 kubelet-bootstrap 用户赋予 system:node-bootstrapper cluster 角色(role)， 然后 kubelet 才能有权限创建认证请求(certificate signing requests)：</p>
<pre class="chroma"><span class="c1"># master节点执行</span>
kubectl create clusterrolebinding kubelet-bootstrap <span class="se">\
</span><span class="se"></span>  --clusterrole<span class="o">=</span>system:node-bootstrapper <span class="se">\
</span><span class="se"></span>  --user<span class="o">=</span>kubelet-bootstrap
</pre>
<blockquote>
<p>&ndash;user=kubelet-bootstrap 是在 /etc/kubernetes/token.csv 文件中指定的用户名，同时也写入了 /etc/kubernetes/bootstrap.kubeconfig 文件；</p>
</blockquote>

<p><strong>!!! 启动服务之前，务必检查systemd unit文件是否根据各节点自身情况进行修改 !!!</strong></p>
<pre class="chroma"><span class="k">for</span> node in <span class="o">{</span>node01,node02,node03<span class="o">}</span><span class="p">;</span><span class="k">do</span>
  ssh root@<span class="si">${</span><span class="nv">node</span><span class="si">}</span> <span class="s2">&#34;mkdir -p /var/lib/kubelet&#34;</span>
  ssh root@<span class="si">${</span><span class="nv">node</span><span class="si">}</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl start flanneld docker kubelet kube-proxy &amp;&amp; systemctl enable flanneld docker kubelet kube-proxy&#34;</span>
<span class="k">done</span>
</pre>
<h3>4) 通过node节点的tls认证请求</h3>
<pre class="chroma"><span class="c1"># 查看csr请求</span>
kubectl get csr <span class="p">|</span> awk <span class="s1">&#39;/Pending/ {print $1}&#39;</span>

<span class="c1"># approve csr请求</span>
kubectl get csr <span class="p">|</span> awk <span class="s1">&#39;/Pending/ {print $1}&#39;</span> <span class="p">|</span> xargs kubectl certificate approve

<span class="c1"># 查看集群状态</span>
kubectl get nodes
NAME      STATUS    ROLES     AGE       VERSION
node01    Ready     &lt;none&gt;    40m       v1.9.1
node02    Ready     &lt;none&gt;    3m        v1.9.1
node03    Ready     &lt;none&gt;    3m        v1.9.1
</pre>
    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>