<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/service/nginx/nginx_2.1.9.03_configuration_log.html">nginx: 配置 - 日志</a>
            </li>
            <li>
              <a href="/linux/advance/network_tunnel-ipip.html">网络: 隧道 - IPIP</a>
            </li>
            <li>
              <a href="/linux/advance/network_ip-address.html">网络: IP - IP地址简介</a>
            </li>
            <li>
              <a href="/linux/advance/bash_02_00_login_shell_vs_non_login_shell.html">bash: login shell vs non-login shell</a>
            </li>
            <li>
              <a href="/linux/advance/rlimit_fd_02_commands_to_check_current_status.html">rlimit fd: 状态查看命令</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                  <ul>
                    <li><a href="/service/apache/1.0.0_apache_installation.html">apache: 安装 - 脚本示例</a></li>
                    <li><a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式 prefork和worker</a></li>
                    <li><a href="/service/apache/1.1.0_apache_config_basic.html">apache: 配置 - 基本配置</a></li>
                    <li><a href="/service/apache/1.1.0_b_apache_config_rewrite.html">apache: 配置 - rewrite</a></li>
                    <li><a href="/service/apache/1.1.0_c_apache_config_access_limit.html">apache: 配置 - htpasswd</a></li>
                    <li><a href="/service/apache/1.1.0_d_apache_config_anti_leech_file_gate.html">apache: 配置 - 防盗链</a></li>
                    <li><a href="/service/apache/1.1.0_e_apache_config_old_2.2_directory_access_limit.html">apache: 配置 - 目录文件限制（2.2旧版本）</a></li>
                    <li><a href="/service/apache/1.1.0_f_apache_config_log_and_cache.html">apache: 配置 - 日志/缓存</a></li>
                    <li><a href="/service/apache/1.1.1_apache_config_parse_php.html">apache: 配置 - PHP解析</a></li>
                    <li><a href="/service/apache/1.1.2_apache_config_security.html">apache: 配置 - 安全</a></li>
                    <li><a href="/service/apache/1.1.3_apache_config_make_servername_and_serveralias_an_ip.html">apache: 配置 - 可以把ServerName和ServerAlias配置为IP吗？</a></li>
                    <li><a href="/service/apache/1.2.0_apache_status_check.html">apache: 管理 - 状态查看</a></li>
                    <li><a href="/service/apache/1.3.0_apache_iptables_selinux.html">apache: 管理 - iptables和selinux</a></li>
                    <li><a href="/service/apache/1.4.0_apache_practice_discuz.html">apache: 实践 - discuz</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/haproxy/index.html">haproxy</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                </li>
                <li>
                  <a href="/service/product_issues/index.html">product_issues</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>apache: 理论 - 工作模式 prefork和worker</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>31 May 2015</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<p>本文给大家讲述linux下apache的工作模式：prefork和worker
apache作为现今web服务器用的最广泛也是最稳定的开源服务器软件，其工作模式有许多中，目前主要有两种模式：prefork模式和worker模式
一、两种模式
prefork模式：
prefork是Unix平台上的默认（缺省）MPM，使用多个子进程，每个子进程只有一个线程。每个进程在某个确定的时间只能维持一个连接，效率高，但内存占用量比较大。
这个多路处理模块(MPM)实现了一个非线程型的、预派生的web服务器，它的工作方式类似于Apache 1.3。它适合于没有线程安全库，需要避免线程兼容性问题的系统。它是要求将每个请求相互独立的情况下最好的MPM，这样若一个请求出现问题就不会影响到其他请求。
worker模式：
worker使用多个子进程，每个子进程有多个线程，每个线程在某个确定的时间只能维持一个连接，内存占用量比较小，适合高流量的http服务器。缺点是假如一个线程崩溃，整个进程就会连同其任何线程一起&rdquo;死掉&rdquo;，所以要保证一个程式在运行时必须被系统识别为&rdquo;每个线程都是安全的&rdquo;。
此多路处理模块(MPM)使网络服务器支持混合的多线程多进程。由于使用线程来处理请求，所以可以处理海量请求，而系统资源的开销小于基于进程的MPM。但是它也使用了多进程，每个进程又有多个线程，以获得基于进程的MPM的稳定性。
二、apache模式的查看和安装
1、常看当前模式
如果apache已经安装，我们可以用&rdquo;httpd -l&rdquo;命令查看当前模式。若找到 prefork.c 则表示当前工作在prefork模式，同理出现 worker.c 则工作在worker模式。
如果apache还未安装，我们在编译的时候可以加入 &ndash;with-pem=(prefork|worker) 选项决定启用什么模式。
2、切换模式
a. 将当前的prefork模式启动文件改名
mv httpd httpd.prefork
b. 将worker模式的启动文件改名
mv httpd.worker httpd
c. 修改Apache配置文件
vi /usr/local/apache2/conf/extra/httpd-mpm.conf
找到里边的如下一段，可适当修改负载等参数：
<IfModule mpm_worker_module>
StartServers
MaxClients
MinSpareThreads
MaxSpareThreads
ThreadsPerChild
MaxRequestsPerChild
</IfModule>
d. 重新启动服务
/usr/local/apache2/bin/apachectl restart
处于稳定性和安全性考虑，不建议更换apache2的运行方式，使用系统默认prefork即可。另外很多php模块不能工作在worker模式下，例如redhat linux自带的php也不能支持线程安全。所以最好不要切换工作模式。
三、prefork和worker模式的比较
prefork模式使用多个子进程，每个子进程只有一个线程。每个进程在某个确定的时间只能维持一个连接。在大多数平台上，Prefork MPM在效率上要比Worker MPM要高，但是内存使用大得多。prefork的无线程设计在某些情况下将比worker更有优势：它可以使用那些没有处理好线程安全的第三方模块，并且对于那些线程调试困难的平台而言，它也更容易调试一些。
worker模式使用多个子进程，每个子进程有多个线程。每个线程在某个确定的时间只能维持一个连接。通常来说，在一个高流量的HTTP服务器上，Worker MPM是个比较好的选择，因为Worker MPM的内存使用比Prefork MPM要低得多。但worker MPM也由不完善的地方，如果一个线程崩溃，整个进程就会连同其所有线程一起&rdquo;死掉&rdquo;。由于线程共享内存空间，所以一个程序在运行时必须被系统识别为&rdquo;每个线程都是安全的&rdquo;。
总的来说，prefork方式速度要稍高于worker，然而它需要的cpu和memory资源也稍多于woker。
四、prefork模式配置详解
<IfModule mpm_prefork_module>
ServerLimit
StartServers
MinSpareServers
MaxSpareServers
MaxClients
MaxRequestsPerChild
</IfModule>
ServerLimit
默认的MaxClient最大是256个线程，如果想设置更大的值，就的加上ServerLimit这个参数。20000是ServerLimit这个参数的最大值。如果需要更大，则必须编译apache，此前都是不需要重新编译Apache。
生效前提：必须放在其他指令的前面
StartServers
指定服务器启动时建立的子进程数量，prefork默认为5。
MinSpareServers
指定空闲子进程的最小数量，默认为5。如果当前空闲子进程数少于MinSpareServers ，那么Apache将以最大每秒一个的速度产生新的子进程。此参数不要设的太大。
MaxSpareServers
设置空闲子进程的最大数量，默认为10。如果当前有超过MaxSpareServers数量的空闲子进程，那么父进程将杀死多余的子进程。此参数不要设的太大。如果你将该指令的值设置为比MinSpareServers小，Apache将会自动将其修改成&rdquo;MinSpareServers+1&rdquo;。
MaxClients
限定同一时间客户端最大接入请求的数量(单个进程并发线程数)，默认为256。任何超过MaxClients限制的请求都将进入等候队列，一旦一个链接被释放，队列中的请求将得到服务。要增大这个值，你必须同时增大ServerLimit。
MaxRequestsPerChild
每个子进程在其生存期内允许伺服的最大请求数量，默认为10000.到达MaxRequestsPerChild的限制后，子进程将会结束。如果 MaxRequestsPerChild为&rdquo;0&rdquo;，子进程将永远不会结束。将MaxRequestsPerChild设置成非零值有两个好处：</p>

<ol>
<li>可以防止(偶然的)内存泄漏无限进行，从而耗尽内存。</li>
<li>给进程一个有限寿命，从而有助于当服务器负载减轻的时候减少活动进程的数量。
五、worker模式配置详解
<IfModule mpm_worker_module>
StartServers
MaxClients
MinSpareThreads
MaxSpareThreads
ThreadsPerChild
MaxRequestsPerChild
</IfModule>
StartServers
服务器启动时建立的子进程数，默认值是&rdquo;3&rdquo;。
MaxClients
允许同时伺服的最大接入请求数量(最大线程数量)。任何超过MaxClients限制的请求都将进入等候队列。默认值 是&rdquo;400&rdquo;，16(ServerLimit)乘以25(ThreadsPerChild)的结果。因此要增加MaxClients的时候，你必须同时增加ServerLimit的值。
MinSpareThreads
最小空闲线程数，默认值是&rdquo;75&rdquo;。这个MPM将基于整个服务器监视空闲线程数。如果服务器中总的空闲线程数太少，子进程将产生新的空闲线程。
MaxSpareThreads
设置最大空闲线程数。默认值是&rdquo;250&rdquo;。这个MPM将基于整个服务器监视空闲线程数。如果服务器中总的空闲线程数太多，子进程将杀死多余的空闲线程。 MaxSpareThreads的取值范围是有限制的。Apache将按照如下限制自动修正你设置的值：worker要求其大于等于 MinSpareThreads加上ThreadsPerChild的和。
ThreadsPerChild
每个子进程建立的常驻的执行线程数。默认值是25。子进程在启动时建立这些线程后就不再建立新的线程了。
MaxRequestsPerChild
设置每个子进程在其生存期内允许伺服的最大请求数量。到达MaxRequestsPerChild的限制后，子进程将会结束。如果MaxRequestsPerChild为&rdquo;0&rdquo;，子进程将永远不会结束。将MaxRequestsPerChild设置成非零值有两个好处：</li>
<li>可以防止(偶然的)内存泄漏无限进行，从而耗尽内存。</li>
<li>给进程一个有限寿命，从而有助于当服务器负载减轻的时候减少活动进程的数量。
注意对于KeepAlive链接，只有第一个请求会被计数。事实上，它改变了每个子进程限制最大链接数量的行为。
六、总结
以前apache主流模式为prefork，现在worker模式也开始多了起来，区别来说，worker模式可以应对高流量，但是安全性不太好；prefork模式安全性比较好，但是性能会差一点，各位可以根据自己服务器的类别选取不同的模式，更好的使用apache。</li>
</ol>

<p>来自 <a href="http://www.itjsxx.com/linux/apache_prefork_worker,.html">http://www.itjsxx.com/linux/apache_prefork_worker,.html</a></p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>