<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/service/tomcat/tomcat_1.0.0_what_is_jakarta_ee_and_tomcat.html">tomcat 1.0.0 Jakarta EE 和 Tomcat</a>
            </li>
            <li>
              <a href="/linux/shell/shell_1.2_read.html">SHELL: 1.2 read</a>
            </li>
            <li>
              <a href="/cryptography/basic/openssl_1.3.1_usage.html">openssl 1.3.1 SSL DEBUG: s_client</a>
            </li>
            <li>
              <a href="/linux/advance/network_theory-TCP-IP-note.html">网络: 理论 - TCP/IP详解读书笔记</a>
            </li>
            <li>
              <a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                  <ul>
                    <li><a href="/service/apache/1.0.0_apache_installation.html">apache: 安装 - 脚本示例</a></li>
                    <li><a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式</a></li>
                    <li><a href="/service/apache/1.1.0_apache_config_basic.html">apache: 配置 - 基本配置</a></li>
                    <li><a href="/service/apache/1.1.0_b_apache_config_rewrite.html">apache: 配置 - rewrite</a></li>
                    <li><a href="/service/apache/1.1.0_c_apache_config_access_limit.html">apache: 配置 - htpasswd</a></li>
                    <li><a href="/service/apache/1.1.0_d_apache_config_anti_leech_file_gate.html">apache: 配置 - 防盗链</a></li>
                    <li><a href="/service/apache/1.1.0_e_apache_config_old_2.2_directory_access_limit.html">apache: 配置 - 目录文件限制（2.2旧版本）</a></li>
                    <li><a href="/service/apache/1.1.0_f_apache_config_log_and_cache.html">apache: 配置 - 日志/缓存</a></li>
                    <li><a href="/service/apache/1.1.1_apache_config_parse_php.html">apache: 配置 - PHP解析</a></li>
                    <li><a href="/service/apache/1.1.2_apache_config_security.html">apache: 配置 - 安全</a></li>
                    <li><a href="/service/apache/1.1.3_apache_config_make_servername_and_serveralias_an_ip.html">apache: 配置 - 可以把ServerName和ServerAlias配置为IP吗？</a></li>
                    <li><a href="/service/apache/1.2.0_apache_status_check.html">apache: 管理 - 状态查看</a></li>
                    <li><a href="/service/apache/1.3.0_apache_iptables_selinux.html">apache: 管理 - iptables和selinux</a></li>
                    <li><a href="/service/apache/1.4.0_apache_practice_discuz.html">apache: 实践 - discuz</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/haproxy/index.html">haproxy</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>apache: 配置 - rewrite</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>09 Jan 2015</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>0. 环境介绍</h2>
<pre class="chroma"><span class="c1"># 虚机配置</span>
&lt;VirtualHost *:80&gt;
        ServerName www.example.com
        DocumentRoot <span class="s2">&#34;/var/www/html&#34;</span>
        CustomLog <span class="s2">&#34;logs/server0_vhost_log&#34;</span> combined
        &lt;Directory <span class="s2">&#34;/var/www/html&#34;</span>&gt;
                &lt;RequireAll&gt;
                        Require all granted
                &lt;/RequireAll&gt;
        &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</pre>
<h2>1. 加载重定向模块</h2>
<pre class="chroma"><span class="c1"># 编辑主配文件，加载rewrite模块</span>
LoadModule rewrite_module modules/mod_rewrite.so

<span class="c1"># 重载服务配置，检查模块加载情况</span>
apachectl graceful
apachectl -M <span class="p">|</span>grep rewrite
 rewrite_module <span class="o">(</span>shared<span class="o">)</span>
</pre>
<h2>2. 重定向配置</h2>
<pre class="chroma"><span class="c1"># 虚拟主机中重定向配置</span>
&lt;IfModule mod_rewrite.c&gt;
        RewriteEngine on
        RewriteCond %<span class="o">{</span>HTTP_HOST<span class="o">}</span> ^bbs.example.com$
        RewriteRule ^/<span class="o">(</span>.*<span class="o">)</span>$ http://www.example.com/<span class="nv">$1</span> <span class="o">[</span><span class="nv">R</span><span class="o">=</span>301,L<span class="o">]</span>
&lt;/IfModule&gt;

<span class="c1"># 重载服务配置，检查重定向结果</span>
apachectl graceful
curl -x localhost:80 bbs.example.com -I
HTTP/1.1 <span class="m">301</span> Moved Permanently
Date: Wed, <span class="m">25</span> May <span class="m">2016</span> 14:26:12 GMT
Server: Apache/2.4.20 <span class="o">(</span>Unix<span class="o">)</span> PHP/5.6.21
Location: http://www.example.com/
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</pre>
<h2>3. 理论知识漫谈</h2>

<p><strong>RewriteRule的正则知识</strong><br />
官网链接: <a href="http://httpd.apache.org/docs/2.4/rewrite/intro.html">http://httpd.apache.org/docs/2.4/rewrite/intro.html</a></p>

<h3>1) 什么是$1,$2和%1&hellip;?</h3>

<p><img src="/static/images/docs/linux/basiclinux-basic-22.3-01.png" alt="" /></p>

<ul>
<li>&rdquo;()&rdquo; - 在RewriteCond中代表%1&hellip;&hellip;</li>
<li>&rdquo;()&rdquo; - 在RewriteRule中代表$1&hellip;&hellip;</li>
</ul>

<h3>2) RewriteRule语法</h3>

<p><img src="/static/images/docs/linux/basiclinux-basic-22.3-02.png" alt="" /></p>

<ol>
<li>Pattern - 请求的URL(<a href="http://hostname:port之后的部分)匹配的规则">http://hostname:port之后的部分)匹配的规则</a></li>
<li>substitution - 匹配到的URL部分发送到此处重置位置

<ul>
<li>文件系统绝对路径<br />
RewriteRule &ldquo;^/games&rdquo; &ldquo;/usr/local/games/web&rdquo;</li>
<li>web路径<br />
RewriteRule &ldquo;^/foo$&rdquo; &ldquo;/bar&rdquo;<br />
相当于$DocumentRoot/bar</li>
<li>URL绝对路径<br />
RewriteRule &ldquo;^/product/view$&rdquo; &ldquo;<a href="http://site2.example.com/seeproduct.html&quot;">http://site2.example.com/seeproduct.html&rdquo;</a> [R]</li>
</ul></li>
<li>[flags] - 影响rewrite请求的选项</li>
</ol>

<h3>3) RewriteRule的执行逻辑</h3>
<pre class="chroma"><span class="c1">## 访问bbs.example.com时，根据后面是纯数字或纯字母做出反应</span>
<span class="c1"># RewriteEngine on</span>
<span class="c1"># RewriteCond %{HTTP_HOST} ^(http://)?bbs.example.com</span>
<span class="c1"># RewriteRule ^/([0-9]+)$ http://www.example.com/first$1</span>
<span class="c1"># RewriteRule ^/([0-9]+)$ http://www.example.com/second$1</span>
<span class="c1"># RewriteRule ^/([a-z]+)$ http://www.example.com/third$1</span>
<span class="c1"># RewriteRule ^/(.*)$ http://www.example.com/fourth$1</span>

<span class="c1">## 通过下面的三次测试可以得出以下结论</span>
<span class="c1">## 当RewriteCond条件匹配到的情况下</span>
<span class="c1"># 匹配到的位置最上面的rule生效</span>
<span class="c1">## 当RewriteCond条件不匹配的情况下</span>
<span class="c1"># 跳过第一条rule，匹配到的最上面的rule生效</span>

<span class="c1"># RewriteCond匹配，三条rule匹配，上面的生效</span>
curl -x localhost:80 bbs.example.com/11 -I
HTTP/1.1 <span class="m">302</span> Found
Date: Thu, <span class="m">26</span> May <span class="m">2016</span> 14:25:29 GMT
Server: Apache/2.4.20 <span class="o">(</span>Unix<span class="o">)</span> PHP/5.6.21
Location: http://www.example.com/first11
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1

<span class="c1"># RewriteCond匹配，若只有一条rule匹配，该rule生效</span>
curl -x localhost:80 bbs.example.com/aa1 -I
HTTP/1.1 <span class="m">302</span> Found
Date: Thu, <span class="m">26</span> May <span class="m">2016</span> 15:33:50 GMT
Server: Apache/2.4.20 <span class="o">(</span>Unix<span class="o">)</span> PHP/5.6.21
Location: http://www.example.com/fourthaa1
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1


<span class="c1"># RewriteCond不匹配时，因为第4条rule匹配到，该rule生效</span>
<span class="c1"># 但当我测试将第4条rule换去第一条，未生效</span>
curl -x localhost:80 www.baidu.com -I
HTTP/1.1 <span class="m">302</span> Found
Date: Thu, <span class="m">26</span> May <span class="m">2016</span> 15:26:00 GMT
Server: Apache/2.4.20 <span class="o">(</span>Unix<span class="o">)</span> PHP/5.6.21
Location: http://www.example.com/fourth
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</pre>
<h3>RewriteCond语法</h3>

<p><img src="/static/images/docs/linux/basiclinux-basic-22.3-03.png" alt="" /></p>

<ol>
<li>teststring - request的相关变量</li>
<li>dondition - 正则匹配字符串</li>
<li>[flags] - NC(忽略大小写), OR(或), NV(No Vary)</li>
<li>可有1个或多个RewriteCond</li>
<li>当有多个RewriteCond时，需要满足所有条件</li>
</ol>

<h2>4. 实践扩展</h2>

<h3>扩展1 - 用rewrite来匹配特定文件类型，并禁止访问</h3>
<pre class="chroma">&lt;IfModule mod_rewrite.c&gt;
RewriteEngine on
RewriteCond %<span class="o">{</span>REQUEST_URI<span class="o">}</span> ^.*/tmp/* <span class="o">[</span>NC<span class="o">]</span>
RewriteRule .* - <span class="o">[</span>F<span class="o">]</span>
&lt;/IfModule&gt;
<span class="c1">## 条件: 当request请求的url中包含/tmp/时</span>
<span class="c1">## NC: 判断条件不区分大小写</span>
<span class="c1">## RewriteRule中的&#34;-&#34;代表什么都不做</span>
<span class="c1">## F: 拒绝访问</span>
</pre>
<h3>扩展2 - 用rewrite匹配特定useragent，并禁止访问</h3>

<p><strong>user_agent是什么？</strong><br />
user_agent就是访问网络的工具（浏览器），因为user是通过浏览器和server沟通的，所以浏览器就是user的agent<br />
目前，一方面浏览器基本都通过给server发送一条user agent字符串，来告诉server自己的访问信息；另外一方面，搜索引擎（google、baidu）在放出网络爬虫来收集网站link时，网络爬虫也会发送user agent字符串来表明自己的身份。</p>

<p><strong>user_agent string</strong><br />
此图来自网络<a href="http://whatsmyuseragent.com/WhatsAUserAgent">http://whatsmyuseragent.com/WhatsAUserAgent</a><br />
<img src="/static/images/docs/linux/basiclinux-basic-22.3-04.png" alt="" /></p>
<pre class="chroma"><span class="c1"># rewrite写法</span>
&lt;IfModule mod_rewrite.c&gt;
    RewriteEngine on
    RewriteCond %<span class="o">{</span>HTTP_USER_AGENT<span class="o">}</span>  ^*Firefox/4.0* <span class="o">[</span>NC,OR<span class="o">]</span>
    RewriteCond %<span class="o">{</span>HTTP_USER_AGENT<span class="o">}</span>  ^*Tomato Bot/1.0* <span class="o">[</span>NC<span class="o">]</span>
    RewriteRule  .*  -  <span class="o">[</span>F<span class="o">]</span>
&lt;/IfModule&gt;
<span class="c1"># 不推荐用rewrite到404，会产生死循环</span>
</pre>
<h3>扩展3 - 死循环相关知识</h3>
<pre class="chroma"><span class="c1"># 原意是把所有访问请求rewrite到/111/$1</span>
RewriteRule ^<span class="o">(</span>.*<span class="o">)</span> /111/<span class="nv">$1</span> <span class="o">[</span>R,L<span class="o">]</span>
<span class="c1"># 但当访问类似于www.111.com/111，它就会无限循环在网址后面增加111</span>

<span class="c1"># 为了避免死循环产生，可以按如下方法处理</span>
RewriteCond   %<span class="o">{</span>REQUEST_URI<span class="o">}</span> !^/111
RewriteRule ^<span class="o">(</span>.*<span class="o">)</span> /111/<span class="nv">$1</span> <span class="o">[</span>R,L<span class="o">]</span>
</pre>
<h3>扩展4 - 多RewriteRule对应RewriteCond</h3>
<pre class="chroma"><span class="c1"># 使用rewrite flags - [E=var:varvalue]</span>
RewriteCond %<span class="o">{</span>HTTP_HOST<span class="o">}</span> ^<span class="o">(</span>www<span class="se">\.</span><span class="o">)</span>?<span class="o">(</span><span class="o">[</span>a-z0-9-<span class="o">]</span>+<span class="o">)</span><span class="se">\.</span>example<span class="se">\.</span>com <span class="o">[</span>NC<span class="o">]</span>
RewriteRule .? - <span class="o">[</span><span class="nv">E</span><span class="o">=</span>Wa:%1,E<span class="o">=</span>Wb:%2<span class="o">]</span>
RewriteRule ^<span class="o">(</span>.*?<span class="o">)</span>-<span class="o">(</span><span class="o">[</span>a-z<span class="o">]</span>+<span class="o">)</span> %<span class="o">{</span>ENV:Wb<span class="o">}</span>/<span class="nv">$1</span>.%<span class="o">{</span>ENV:Wb<span class="o">}</span> <span class="o">[</span>L<span class="o">]</span>
RewriteRule ^<span class="o">(</span>.*?<span class="o">)</span>-<span class="o">(</span><span class="o">[</span>0-9<span class="o">]</span>+<span class="o">)</span><span class="o">(</span><span class="o">[</span>a-z<span class="o">]</span><span class="o">)</span> %<span class="o">{</span>ENV:Wb<span class="o">}</span>/<span class="nv">$1</span><span class="nv">$3</span>.<span class="nv">$2</span> <span class="o">[</span>L<span class="o">]</span>
<span class="c1"># 将RewriteCond的%1和%2赋值给变量</span>
<span class="c1"># rewrite flag [L]含义是last，代表此规则是最后一条规则；</span>
</pre>
<h3>扩展5 - 用rewrite flag [S]来改变扩展5中的逻辑处理方式</h3>
<pre class="chroma"><span class="c1"># 当访问非bbs.example.com时，跳过3行Rule</span>
<span class="c1"># 当访问bbs.example.com时，因为不匹配条件，跳至第二行rule</span>
<span class="c1"># 根据第二行rule规则，跳过第三行，执行第四行规则</span>
RewriteEngine on
RewriteCond %<span class="o">{</span>HTTP_HOST<span class="o">}</span> !bbs.example.com
RewriteRule .? - <span class="o">[</span><span class="nv">S</span><span class="o">=</span>3<span class="o">]</span>
RewriteRule .? - <span class="o">[</span><span class="nv">S</span><span class="o">=</span>1<span class="o">]</span>
RewriteRule ^/<span class="o">(</span>.*<span class="o">)</span>$ http://bbs.example.com/<span class="nv">$1</span>s
RewriteRule ^/<span class="o">(</span>.*<span class="o">)</span>$ http://bbs.example.com/<span class="nv">$1</span>f

<span class="c1"># 验证结果</span>
curl -x localhost:80 bbs.example.com -I
HTTP/1.1 <span class="m">302</span> Found
Date: Thu, <span class="m">26</span> May <span class="m">2016</span> 11:03:51 GMT
Server: Apache/2.4.20 <span class="o">(</span>Unix<span class="o">)</span> PHP/5.6.21
Location: http://bbs.example.com/f
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</pre>
    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>