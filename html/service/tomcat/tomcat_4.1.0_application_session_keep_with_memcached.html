<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/fd_01_file_descriptor_brief_introduction.html">fd: 文件描述符简明介绍</a>
            </li>
            <li>
              <a href="/service/haproxy/haproxy_01_config_log.html">haproxy: 配置和日志</a>
            </li>
            <li>
              <a href="/service/haproxy/haproxy_00_start_up_with_docker_compose.html">haproxy: 使用docker-compose启动haproxy</a>
            </li>
            <li>
              <a href="/service/apache/1.1.3_apache_config_make_servername_and_serveralias_an_ip.html">apache 配置: 可以把ServerName和ServerAlias配置为IP吗？</a>
            </li>
            <li>
              <a href="/linux/advance/performance_01_io_limit.html">performance: 限制进程的IO消耗</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/haproxy/index.html">haproxy</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                </li>
                <li>
                  <a href="/service/product_issues/index.html">product_issues</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                  <ul>
                    <li><a href="/service/tomcat/tomcat_1.1.0_config_args_sessionCookieName.html">tomcat 1.1.0 配置-sessionCookieName</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.1_config_ssl_tomcat7.html">tomcat 1.1.1 配置-SSL</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.2_config_server_xml.html">tomcat 1.1.2 server.xml 配置</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.3_config_context.html">tomcat 1.1.3 配置-context</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.0_log_cronolog_logrotate.html">tomcat 1.2.0 日志-cronolog日志切割</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.1_log_log4j.html">tomcat 1.2.1 日志-log4j配置相对路径</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.2_log_juli_loglevel.html">tomcat 1.2.2 日志-JULI日志级别</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.0_optimize_apr_mode.html">tomcat 1.3.0 优化-apr模式</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.1_optimize_server_xml.html">tomcat 1.3.1 优化-server.xml</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.2_optimize_test_concurrent_more_than_10000.html">tomcat 1.3.2 优化-如何承载上万并发</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.0_problem_startup_slow_tomcat7.html">tomcat 2.1.0 问题-tomcat7启动速度慢</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.1_entropy_source.html">tomcat 2.1.1 问题-tomcat7启动安全-熵池</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.2_error_shutdown_connection_refuse.html">tomcat 2.1.2 问题-tomcat7 shutdown 提示 connection refused</a></li>
                    <li><a href="/service/tomcat/tomcat_2.2.0_java.lang.ClassCastException.html">tomcat 2.2.0 问题-java.lang.ClassCastException</a></li>
                    <li><a href="/service/tomcat/tomcat_2.2.1_tomcat7_classloader_howto_translate.html">tomcat 2.2.1 tomcat7类加载器HOWTO-中文翻译</a></li>
                    <li><a href="/service/tomcat/tomcat_3.1.0_manage_check_version.html">tomcat 3.1.0 管理-查看tomcat版本</a></li>
                    <li><a href="/service/tomcat/tomcat_3.2.0_tomcat_manager.html">tomcat 3.2.0 tomcat manager</a></li>
                    <li><a href="/service/tomcat/tomcat_4.1.0_application_session_keep_with_memcached.html">tomcat 4.1.0 应用-memcached会话保持</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.0_redis_session_gradle_compile_jar.html">tomcat 5.1.0 gradle编译tomcat-redis-session-manager</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.1_redis_session_gradle_compile_jar_tomcat8.5_and_jdk8.html">tomcat 5.1.0 gradle编译tomcat-redis-session-manager - tomcat8.5</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.2_session_sharing_by_using_redis.html">tomcat: 5.1.2 tomcat-session sharing</a></li>
                    <li><a href="/service/tomcat/tomcat_6.1.0_tomcat6_vs_tomcat7.html">tomcat 6.1.0 tomcat6 和 tomcat7的简要区别</a></li>
                    <li><a href="/service/tomcat/tomcat_7.1.0_running_as_daemon_by_nonroot_jsvc.html">tomcat 7.1.0 使用非root用户用daemon运行tomcat - (jsvc)</a></li>
                    <li><a href="/service/tomcat/tomcat_7.1.1_running_as_daemon_by_nonroot_systemd.html">tomcat 7.1.1 使用非root用户用daemon运行tomcat - (systemd) - 推荐</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>tomcat 4.1.0 应用-memcached会话保持</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>23 Sep 2016</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>0. 环境准备</h2>

<p>三台主机</p>

<ul>
<li>nginx：192.168.110.4 nginx-proxy</li>
<li>tomcat+memcached：192.168.110.5 ss01</li>
<li>tomcat+memcached：192.168.110.6 ss02</li>
</ul>

<p>软件版本
linux: centos6.5
nginx: 1.10.1
JDK: 1.6
tomcat: 6
memcached: 1.4.4
MSM: 1.8.2</p>

<hr />

<h2>1. 环境搭建</h2>

<h3>1. nginx环境</h3>

<p>在nginx-proxy上安装nginx</p>

<h4>1) 安装nginx</h4>
<pre class="chroma">yum install epel-release -y
yum install nginx -y
chkconfig nginx on
</pre>
<p>为了测试方便，直接yum安装，生产环境尽量编译安装</p>

<h4>2) 配置nginx</h4>
<pre class="chroma"><span class="c1"># 新建nginx虚拟机配置文件</span>
vim /etc/nginx/conf.d/sstest.conf
******************************
upstream ss <span class="o">{</span>
    server 192.168.110.5:8080<span class="p">;</span>
    server 192.168.110.6:8080<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name 192.168.110.4 default_server<span class="p">;</span>
    location / <span class="o">{</span>
        proxy_pass http://ss<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
******************************
service nginx restart
</pre>
<h3>2. tomcat环境</h3>

<p>在nginx-proxy上作为跳板机安装ansible，并做ss01和ss02的key信任（此步骤省略），也就是说，下面的操作都是在nginx-proxy上执行的</p>

<h4>1) 安装tomcat</h4>
<pre class="chroma"><span class="c1"># 下载并安装jdk1.6</span>
<span class="c1"># 需要注册oracle帐号才能在下面下载</span>
http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase6-419409.html
chmod u+x jre-6u45-linux-x64.bin
sh jre-6u45-linux-x64.bin
mv jre1.6.0_45 /usr/local/
ln -s /usr/local/jre1.6.0_45/ /usr/local/jdk
vi /etc/profile.d/java-env.sh
*******************************
<span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/local/jdk
<span class="nv">JRE_HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/jre
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/bin:<span class="si">${</span><span class="nv">JRE_HOME</span><span class="si">}</span>/bin
<span class="nv">CLASSPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/lib:<span class="si">${</span><span class="nv">JRE_HOME</span><span class="si">}</span>/lib
*******************************
<span class="nb">source</span> /etc/profile.d/java-env.sh


<span class="c1"># 安装tomcat</span>
wget http://mirror.rise.ph/apache/tomcat/tomcat-6/v6.0.45/bin/apache-tomcat-6.0.45.tar.gz
tar zxf apache-tomcat-6.0.45.tar.gz
mv apache-tomcat-6.0.45 /usr/local/tomcat
</pre>
<p>注意，以下操作转到ss01和ss02上执行</p>

<h4>2) 启动并配置tomcat</h4>
<pre class="chroma"><span class="c1"># 启动tomcat</span>
<span class="nb">cd</span> /usr/local/tomcat
./bin/catalina.sh start

<span class="c1"># 配置tomcat虚拟主机</span>
vim /usr/local/tomcat/conf/server.xml
************************
&lt;Host <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span>  <span class="nv">appBase</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
      <span class="nv">unpackWARs</span><span class="o">=</span><span class="s2">&#34;true&#34;</span> <span class="nv">autoDeploy</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>&gt;
  &lt;Context <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nv">docBase</span><span class="o">=</span><span class="s2">&#34;/data/webapps&#34;</span> <span class="nv">reloadable</span><span class="o">=</span><span class="s2">&#34;true&#34;</span> /&gt;
  ......
&lt;/Host&gt;
************************

/usr/local/tomcat/bin/catalina.sh stop
/usr/local/tomcat/bin/catalina.sh start
</pre>
<h4>3) 编写测试程序</h4>
<pre class="chroma"><span class="c1"># 创建web程序目录</span>
mkdir -p /data/webapps/<span class="o">{</span>WEB-INF,META-INF,classes,lib<span class="o">}</span>
<span class="nb">cd</span> /data/webapps

<span class="c1"># 编写首页程序</span>
<span class="c1"># ss02上把Tomcat01更换成Tomcat02</span>
vim index.jsp
***********************
&lt;%@ page <span class="nv">language</span><span class="o">=</span><span class="s2">&#34;java&#34;</span> %&gt;
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;Tomcat01&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;&lt;font <span class="nv">color</span><span class="o">=</span><span class="s2">&#34;red&#34;</span>&gt;Tomcat01.magedu.com&lt;/font&gt;&lt;/h1&gt;
    &lt;table <span class="nv">align</span><span class="o">=</span><span class="s2">&#34;centre&#34;</span> <span class="nv">border</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>&gt;
      &lt;tr&gt;
        &lt;td&gt;Session ID&lt;/td&gt;
    &lt;% session.setAttribute<span class="o">(</span><span class="s2">&#34;magedu.com&#34;</span>,<span class="s2">&#34;magedu.com&#34;</span><span class="o">)</span><span class="p">;</span> %&gt;
        &lt;td&gt;&lt;%<span class="o">=</span> session.getId<span class="o">(</span><span class="o">)</span> %&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Created on&lt;/td&gt;
        &lt;td&gt;&lt;%<span class="o">=</span> session.getCreationTime<span class="o">(</span><span class="o">)</span> %&gt;&lt;/td&gt;
     &lt;/tr&gt;
    &lt;/table&gt;
  &lt;/body&gt;
&lt;/html&gt;
***********************
</pre>
<h4>4) 访问测试</h4>
<pre class="chroma">curl -I 192.168.110.5:8080
HTTP/1.1 <span class="m">200</span> OK
Server: Apache-Coyote/1.1
Set-Cookie: <span class="nv">JSESSIONID</span><span class="o">=</span>678BAF3DD0E30285B6FC9475ED97800F-n1<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
Content-Type: text/html
Content-Length: <span class="m">373</span>
Date: Tue, <span class="m">27</span> Sep <span class="m">2016</span> 03:55:33 GMT

curl -I 192.168.110.6:8080
HTTP/1.1 <span class="m">200</span> OK
Server: Apache-Coyote/1.1
Set-Cookie: <span class="nv">JSESSIONID</span><span class="o">=</span>2C83509E8F94E944D16ABFDE46C4E22F-n1<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
Content-Type: text/html
Content-Length: <span class="m">373</span>
Date: Tue, <span class="m">27</span> Sep <span class="m">2016</span> 03:56:01 GMT
</pre>
<p>通过负载均衡查看时为上面两个结果交替出现</p>

<h2>2. memcached做session共享</h2>

<p>以下操作在ss01和ss02执行</p>

<h3>1. 安装memcached</h3>
<pre class="chroma">yum install memcached
</pre>
<h3>2. 安装MSM（memcached session manager）</h3>

<h4>1) 准备库文件</h4>
<pre class="chroma"><span class="c1"># 下载MSM类库文件，[MSM类库文件下载地址](https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration)</span>

mv javolution-5.5.1.jar memcached-session-manager-tc6-1.8.2.jar memcached-session-manager-1.8.2.jar spymemcached-2.11.1.jar msm-javolution-serializer-1.8.2.jar /usr/local/tomcat/lib/
</pre>
<h4>2) 在tomcat里配置MSM</h4>
<pre class="chroma">vim /usr/local/tomcat/conf/server.xml
************************
&lt;Context <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nv">docBase</span><span class="o">=</span><span class="s2">&#34;/data/webapps&#34;</span> <span class="nv">reloadable</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>&gt;
    &lt;Manager <span class="nv">className</span><span class="o">=</span><span class="s2">&#34;de.javakaffee.web.msm.MemcachedBackupSessionManager&#34;</span>
    <span class="nv">memcachedNodes</span><span class="o">=</span><span class="s2">&#34;n1:192.168.110.4:11211,n2:192.168.110.5:11211&#34;</span>
    <span class="nv">failoverNodes</span><span class="o">=</span><span class="s2">&#34;n2&#34;</span>
    <span class="nv">requestUriIgnorePattern</span><span class="o">=</span><span class="s2">&#34;</span><span class="s2">.*\.(ico|png|gif|jpg|css|js)</span>$<span class="s2">&#34;</span>
    <span class="nv">transcoderFactoryClass</span><span class="o">=</span><span class="s2">&#34;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&#34;</span>
    /&gt;
&lt;/Context&gt;
************************
/usr/local/tomcat/bin/catalina.sh stop
/usr/local/tomcat/bin/catalina.sh start
</pre>
<hr />

<h2>3. 效果测试</h2>
<pre class="chroma">curl -I localhost
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.10.1
Date: Tue, <span class="m">27</span> Sep <span class="m">2016</span> 04:03:02 GMT
Content-Type: text/html
Content-Length: <span class="m">373</span>
Connection: keep-alive
Set-Cookie: <span class="nv">JSESSIONID</span><span class="o">=</span>60692852333F53A272F406AFD1120B57-n1<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
</pre>
<p>多次测试皆为一样结果</p>

<hr />

<h2>4. session过期时间设置</h2>

<p>配置完成后，发现session会在短时间内(3mins)过期，可用以下配置设定解决</p>
<pre class="chroma">vim /usr/local/tomcat/conf/web.xml
************************
    &lt;session-config&gt;
        &lt;session-timeout&gt;600&lt;/session-timeout&gt;
    &lt;/session-config&gt;
************************
</pre>
<p>修改timeout数值即可</p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>