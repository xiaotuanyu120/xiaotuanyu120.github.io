<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/dns_01_dns_problem_analysis.html">DNS解析问题排查实践</a>
            </li>
            <li>
              <a href="/linux/advance/dns_00_how_dns_work_in_linux.html">Linux中的DNS解析是如何工作的</a>
            </li>
            <li>
              <a href="/service/dnsmasq/dnsmasq_01.01_introduction_and_basic.html">dnsmasq基础知识</a>
            </li>
            <li>
              <a href="/linux/advance/memory_01_how_memory_work_in_linux.html">linux中的内存是如何工作的？</a>
            </li>
            <li>
              <a href="/database/mysql/mysql_4.0.1_problem_caused_by_auto_increment.html">mysql 4.0.1：auto_increment引起的问题</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                </li>
                <li>
                  <a href="/service/product_issues/index.html">product_issues</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                  <ul>
                    <li><a href="/service/tomcat/tomcat_1.1.0_config_args_sessionCookieName.html">tomcat 1.1.0 配置-sessionCookieName</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.1_config_ssl_tomcat7.html">tomcat 1.1.1 配置-SSL</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.2_config_server_xml.html">tomcat 1.1.2 server.xml 配置</a></li>
                    <li><a href="/service/tomcat/tomcat_1.1.3_config_context.html">tomcat 1.1.3 配置-context</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.0_log_cronolog_logrotate.html">tomcat 1.2.0 日志-cronolog日志切割</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.1_log_log4j.html">tomcat 1.2.1 日志-log4j配置相对路径</a></li>
                    <li><a href="/service/tomcat/tomcat_1.2.2_log_juli_loglevel.html">tomcat 1.2.2 日志-JULI日志级别</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.0_optimize_apr_mode.html">tomcat 1.3.0 优化-apr模式</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.1_optimize_server_xml.html">tomcat 1.3.1 优化-server.xml</a></li>
                    <li><a href="/service/tomcat/tomcat_1.3.2_optimize_test_concurrent_more_than_10000.html">tomcat 1.3.2 优化-如何承载上万并发</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.0_problem_startup_slow_tomcat7.html">tomcat 2.1.0 问题-tomcat7启动速度慢</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.1_entropy_source.html">tomcat 2.1.1 问题-tomcat7启动安全-熵池</a></li>
                    <li><a href="/service/tomcat/tomcat_2.1.2_error_shutdown_connection_refuse.html">tomcat 2.1.2 问题-tomcat7 shutdown 提示 connection refused</a></li>
                    <li><a href="/service/tomcat/tomcat_2.2.0_java.lang.ClassCastException.html">tomcat 2.2.0 问题-java.lang.ClassCastException</a></li>
                    <li><a href="/service/tomcat/tomcat_2.2.1_tomcat7_classloader_howto_translate.html">tomcat 2.2.1 tomcat7类加载器HOWTO-中文翻译</a></li>
                    <li><a href="/service/tomcat/tomcat_3.1.0_manage_check_version.html">tomcat 3.1.0 管理-查看tomcat版本</a></li>
                    <li><a href="/service/tomcat/tomcat_3.2.0_tomcat_manager.html">tomcat 3.2.0 tomcat manager</a></li>
                    <li><a href="/service/tomcat/tomcat_4.1.0_application_session_keep_with_memcached.html">tomcat 4.1.0 应用-memcached会话保持</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.0_redis_session_gradle_compile_jar.html">tomcat 5.1.0 gradle编译tomcat-redis-session-manager</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.1_redis_session_gradle_compile_jar_tomcat8.5_and_jdk8.html">tomcat 5.1.0 gradle编译tomcat-redis-session-manager - tomcat8.5</a></li>
                    <li><a href="/service/tomcat/tomcat_5.1.2_session_sharing_by_using_redis.html">tomcat: 5.1.2 tomcat-session sharing</a></li>
                    <li><a href="/service/tomcat/tomcat_6.1.0_tomcat6_vs_tomcat7.html">tomcat 6.1.0 tomcat6 和 tomcat7的简要区别</a></li>
                    <li><a href="/service/tomcat/tomcat_7.1.0_running_as_daemon_by_nonroot_jsvc.html">tomcat 7.1.0 使用非root用户用daemon运行tomcat - (jsvc)</a></li>
                    <li><a href="/service/tomcat/tomcat_7.1.1_running_as_daemon_by_nonroot_systemd.html">tomcat 7.1.1 使用非root用户用daemon运行tomcat - (systemd) - 推荐</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>tomcat 1.3.2 优化-如何承载上万并发</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>15 Feb 2017</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>0. 前言</h3>

<p>最近在研究如何搭建一套高并发的java web架构，关于这方面的优化和配置牵扯到系统、代理、tcp、tomcat一系列的优化，很是复杂，在研究tomcat的优化过oigvs，搜索到了这一篇<a href="https://blog.krecan.net/2010/05/02/cool-tomcat-is-able-to-handle-more-than-13000-concurrent-connections/comment-page-1/#comment-9636">tomcat并发13000</a>的文章，感觉可以拿出来分享一下，原文是英文，有兴趣的可以去参考并自己实践。</p>

<hr />

<h3>1. 环境</h3>

<p>OS: Centos6.7 无内核优化
tomcat: version 7.0.75 原生无任何配置修改
jdk: 1.7.0_79</p>

<hr />

<h3>2. 准备测试代码</h3>
<pre class="chroma"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadsServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">7770323867448369047L</span><span class="o">;</span>  

    <span class="nd">@Override</span>  
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>  
        <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;number&#34;</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>  
        <span class="k">try</span> <span class="o">{</span>  
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Servlet no. &#34;</span><span class="o">+</span><span class="n">number</span><span class="o">+</span><span class="s">&#34; called.&#34;</span><span class="o">)</span><span class="o">;</span>  
            <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getScheme</span><span class="o">(</span><span class="o">)</span><span class="o">+</span><span class="s">&#34;://&#34;</span><span class="o">+</span><span class="n">req</span><span class="o">.</span><span class="na">getServerName</span><span class="o">(</span><span class="o">)</span><span class="o">+</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="n">req</span><span class="o">.</span><span class="na">getServerPort</span><span class="o">(</span><span class="o">)</span><span class="o">+</span><span class="n">req</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">(</span><span class="o">)</span><span class="o">+</span><span class="s">&#34;?number=&#34;</span><span class="o">+</span><span class="o">(</span><span class="n">number</span><span class="o">+</span><span class="n">1</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>  
            <span class="n">Object</span> <span class="n">content</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getContent</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>  
            <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;plain/text&#34;</span><span class="o">)</span><span class="o">;</span>  
            <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&#34;OK: &#34;</span><span class="o">+</span><span class="n">content</span><span class="o">)</span><span class="o">;</span>  
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Reached &#34;</span><span class="o">+</span><span class="n">number</span><span class="o">+</span><span class="s">&#34; of connections&#34;</span><span class="o">;</span>  
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">message</span><span class="o">)</span><span class="o">;</span>  
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">)</span><span class="o">;</span>  
            <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">message</span><span class="o">)</span><span class="o">;</span>  
        <span class="o">}</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</pre>
<p>代码的处理是找的公司的同事帮忙封装成war包的，访问url为&rdquo;<a href="http://localhost:8080/threads/something?number=1&quot;">http://localhost:8080/threads/something?number=1&rdquo;</a></p>

<hr />

<h3>3. 默认配置测试结果</h3>
<pre class="chroma">Servlet no. <span class="m">193</span> called.
Servlet no. <span class="m">194</span> called.
Servlet no. <span class="m">195</span> called.
Servlet no. <span class="m">196</span> called.
Servlet no. <span class="m">197</span> called.
Servlet no. <span class="m">198</span> called.
Servlet no. <span class="m">199</span> called.
Servlet no. <span class="m">200</span> called.
</pre>
<hr />

<h3>4. 修改Connector配置</h3>

<p>打开<code>$CATALINA_BASE/conf/server.xml</code></p>
<pre class="chroma"><span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">&#34;8080&#34;</span> <span class="na">protocol=</span><span class="s">&#34;HTTP/1.1&#34;</span>
           <span class="na">connectionTimeout=</span><span class="s">&#34;20000&#34;</span>
           <span class="na">maxThreads=</span><span class="s">&#34;32000&#34;</span>
           <span class="na">redirectPort=</span><span class="s">&#34;8443&#34;</span> <span class="nt">/&gt;</span>
</pre>
<p>测试结果</p>
<pre class="chroma">Servlet no. 1135 called.
Servlet no. 1136 called.
Servlet no. 1137 called.
Servlet no. 1138 called.
Servlet no. 1139 called.
Servlet no. 1140 called.
Exception in thread &#34;http-apr-8080-exec-1141&#34; java.lang.OutOfMemoryError: Java heap space
        at org.apache.coyote.http11.InternalAprInputBuffer.&lt;init&gt;(InternalAprInputBuffer.java:59)
        at org.apache.coyote.http11.Http11AprProcessor.&lt;init&gt;(Http11AprProcessor.java:67)
        at org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.createProcessor(Http11AprProtocol.java:301)
        at org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.createProcessor(Http11AprProtocol.java:208)
        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)
        at org.apache.tomcat.util.net.AprEndpoint$SocketWithOptionsProcessor.run(AprEndpoint.java:2473)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
        at java.lang.Thread.run(Thread.java:745)
</pre>
<hr />

<h3>5. 增大heap space</h3>

<p>编辑<code>$CATALINA_BASE/bin/catalina.sh</code></p>
<pre class="chroma"><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&#34;-Xmx2G&#34;</span>
</pre>
<p>测试结果</p>
<pre class="chroma">Servlet no. 2013 called.
Servlet no. 2014 called.
Servlet no. 2015 called.
Servlet no. 2016 called.
Servlet no. 2017 called.
Servlet no. 2018 called.
Servlet no. 2019 called.
Reached 2019 of connections
java.net.SocketException: Too many open files
Feb 15, 2017 8:12:14 AM org.apache.tomcat.util.net.AprEndpoint$Acceptor run
SEVERE: Socket accept failed
org.apache.tomcat.jni.Error: 24: Too many open files
        at org.apache.tomcat.jni.Socket.accept(Native Method)
        at org.apache.tomcat.util.net.AprEndpoint$Acceptor.run(AprEndpoint.java:1086)
        at java.lang.Thread.run(Thread.java:745)
</pre>
<hr />

<h3>6. 查看并增加文件打开数</h3>
<pre class="chroma"><span class="c1"># 修改系统文件数上限</span>
vim /etc/sysctl.conf
********************************
fs.file-max <span class="o">=</span> <span class="m">65535</span>
********************************
sysctl -p

<span class="c1"># 修改用户文件数上限</span>
vim /etc/security/limits.conf
*********************************
root soft nofile <span class="m">65535</span>
root hard nofile <span class="m">65535</span>
*********************************
<span class="c1"># logout 重新login</span>
</pre>
<p>测试结果</p>
<pre class="chroma">Servlet no. 8181 called.
Servlet no. 8182 called.
Servlet no. 8183 called.
Servlet no. 8184 called.
Servlet no. 8185 called.
Servlet no. 8186 called.
Servlet no. 8187 called.
Servlet no. 8188 called.
Servlet no. 8189 called.
Servlet no. 8190 called.
Servlet no. 8191 called.
Servlet no. 8192 called.
</pre>
<p>卡住在这里，查看了下内存，并尝试增大了堆内存，但是依然没有改善</p>

<hr />

<h3>7. 缩小socket的buffersize，来节省内存</h3>

<p>打开<code>$CATALINA_BASE/conf/server.xml</code></p>
<pre class="chroma"><span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">&#34;8080&#34;</span> <span class="na">protocol=</span><span class="s">&#34;HTTP/1.1&#34;</span>
           <span class="na">connectionTimeout=</span><span class="s">&#34;20000&#34;</span>
           <span class="na">maxThreads=</span><span class="s">&#34;32000&#34;</span>
           <span class="na">socket.appReadBufSize=</span><span class="s">&#34;1024&#34;</span>
           <span class="na">socket.appWriteBufSize=</span><span class="s">&#34;1024&#34;</span>
           <span class="na">bufferSize=</span><span class="s">&#34;1024&#34;</span>
           <span class="na">redirectPort=</span><span class="s">&#34;8443&#34;</span> <span class="nt">/&gt;</span>
</pre>
<p>默认值是8192，为了提高并发，可以降低此值，或者增大堆内存</p>

<p>测试结果</p>
<pre class="chroma">Servlet no. 8177 called.
Servlet no. 8178 called.
Servlet no. 8179 called.
Servlet no. 8180 called.
Servlet no. 8181 called.
Servlet no. 8182 called.
Servlet no. 8183 called.
Servlet no. 8184 called.
Servlet no. 8185 called.
Servlet no. 8186 called.
Servlet no. 8187 called.
Servlet no. 8188 called.
Servlet no. 8189 called.
Servlet no. 8190 called.
Servlet no. 8191 called.
Servlet no. 8192 called.
</pre>
<p>并没有得到更大的提升。</p>

<hr />

<h3>8. 总结</h3>

<p>提升tomcat7的并发性能，可以通过增加堆内存和提升线程数的方法，另外系统方面需要增加文件打开数。但是这仅仅是在tomcat应用的角度来看。<br />
其实tomcat也是一个web服务器，web服务器的提升核心是代码，其次才是http/tcp的优化，系统的优化，和servlet的优化。<br />
而且，正确的架构也能提升web架构的并发性，追求单台tomcat的性能极致只是为了技术研究，我们完全可以使用nginx+tomcat集群的方式，在并发和扩展性上得到兼顾。</p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>