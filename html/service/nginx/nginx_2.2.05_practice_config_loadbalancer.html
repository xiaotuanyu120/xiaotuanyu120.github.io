<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/shell/shell_1.2_read.html">SHELL: 1.2 read</a>
            </li>
            <li>
              <a href="/cryptography/basic/openssl_1.3.1_usage.html">openssl 1.3.1 SSL DEBUG: s_client</a>
            </li>
            <li>
              <a href="/linux/advance/network_theory-TCP-IP-note.html">网络: 理论 - TCP/IP详解读书笔记</a>
            </li>
            <li>
              <a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式</a>
            </li>
            <li>
              <a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
              <ul>
                <li>
                  <a href="/service/apache/index.html">apache</a>
                </li>
                <li>
                  <a href="/service/dnsmasq/index.html">dnsmasq</a>
                </li>
                <li>
                  <a href="/service/fluentd/index.html">fluentd</a>
                </li>
                <li>
                  <a href="/service/ftp/index.html">ftp</a>
                </li>
                <li>
                  <a href="/service/haproxy/index.html">haproxy</a>
                </li>
                <li>
                  <a href="/service/jira/index.html">jira</a>
                </li>
                <li>
                  <a href="/service/jitsi-meet/index.html">jitsi-meet</a>
                </li>
                <li>
                  <a href="/service/jumpserver/index.html">jumpserver</a>
                </li>
                <li>
                  <a href="/service/kafka/index.html">kafka</a>
                </li>
                <li>
                  <a href="/service/keepalived/index.html">keepalived</a>
                </li>
                <li>
                  <a href="/service/nginx/index.html">nginx</a>
                  <ul>
                    <li><a href="/service/nginx/nginx_000_error_config_easy_to_ignore.html">nginx: 错误 - 易错配置重点</a></li>
                    <li><a href="/service/nginx/nginx_1.0.1_how_nginx_response_a_request.html">nginx: 理论 - how nginx response a request</a></li>
                    <li><a href="/service/nginx/nginx_1.0.2_timeout_in_nginx.html">nginx: 理论 - nginx中的timeout</a></li>
                    <li><a href="/service/nginx/nginx_2.1.0_configuration_multi_port_listen.html">nginx: 配置 - 同时监听http和https</a></li>
                    <li><a href="/service/nginx/nginx_2.1.1_configuration_https_optimize.html">nginx: 配置 - https optimization</a></li>
                    <li><a href="/service/nginx/nginx_2.1.2_configuration_catch_all.html">nginx: 配置 - catch_all</a></li>
                    <li><a href="/service/nginx/nginx_2.1.3_configuration_gzip_optimize.html">nginx: 配置 - gzip optimization</a></li>
                    <li><a href="/service/nginx/nginx_2.1.4_configuration_security_CRLF_demo_on_nginx.html">nginx: 配置 - CRLF注入漏洞（nginx）Demo</a></li>
                    <li><a href="/service/nginx/nginx_2.1.4_configuration_security_base.html">nginx: 配置 - 基础安全</a></li>
                    <li><a href="/service/nginx/nginx_2.1.4_configuration_security_config.html">nginx: 配置 - 业务配置安全</a></li>
                    <li><a href="/service/nginx/nginx_2.1.5_configuration_proxy_pass_with_URI.html">nginx: 配置 - proxy_pass with URI</a></li>
                    <li><a href="/service/nginx/nginx_2.1.6_configuration_proxy_pass_for_xmpp.html">nginx: 配置 - proxy_pass for xmpp</a></li>
                    <li><a href="/service/nginx/nginx_2.1.7_configuration_access.html">nginx: 配置 - access limit</a></li>
                    <li><a href="/service/nginx/nginx_2.1.8_configuration_proxy_pass_customize_header.html">nginx: 配置 - nginx proxy的时候会撒谎吗？</a></li>
                    <li><a href="/service/nginx/nginx_2.1.9.01_configration_cache.html">nginx: 配置 - cache server</a></li>
                    <li><a href="/service/nginx/nginx_2.1.9.03_configuration_log.html">nginx: 配置 - 日志</a></li>
                    <li><a href="/service/nginx/nginx_2.2.00_practice_config_reverse_tomcat_use_other_port_1.html">nginx: 配置 - (实践) nginx使用非80端口反向代理tomcat</a></li>
                    <li><a href="/service/nginx/nginx_2.2.01_practice_config_reverse_tomcat_use_other_port_2.html">nginx: 配置 - (实践) 监听https和http，然后使用http反向代理tomcat</a></li>
                    <li><a href="/service/nginx/nginx_2.2.03_practice_config_proxy_get_real_ip.html">nginx: 配置 - (实践) 获取客户端ip</a></li>
                    <li><a href="/service/nginx/nginx_2.2.04_practice_config_cross_origin_request.html">nginx: 配置 - (实践) CORS 跨源资源分享</a></li>
                    <li><a href="/service/nginx/nginx_2.2.05_practice_config_loadbalancer.html">nginx: 配置 - (实践)HTTP负载均衡</a></li>
                    <li><a href="/service/nginx/nginx_3.1.0_module_nginx-sticky-module.html">nginx: 模块 - nginx-sticky-module</a></li>
                    <li><a href="/service/nginx/nginx_7.1.0_if_statement_with_variables.html">nginx: 7.1.0 if语句、参数变量、自定义header变量</a></li>
                    <li><a href="/service/nginx/nginx_7.2.0_geo_if_filter.html">nginx: 7.2.0 if语句、参数变量、geoip</a></li>
                    <li><a href="/service/nginx/nginx_7.3.0_match_parameter_in_location.html">nginx: 7.3.0 在location里面匹配parameters</a></li>
                    <li><a href="/service/nginx/openresty_1.1.0_installation.html">openresty: 1.1.0 在location里面匹配parameters</a></li>
                    <li><a href="/service/nginx/practice_1.1.0_nginx_movie.html">实践: 1.1.0 使用nginx提供mp4串流服务</a></li>
                    <li><a href="/service/nginx/practice_1.1.1_nginx_zhibo_flv.html">实践: 1.1.1 使用nginx提供直播服务</a></li>
                    <li><a href="/service/nginx/practice_1.1.2_nginx_frameset.html">实践 1.1.2 使用frameset实现URL原地跳转</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/service/php/index.html">php</a>
                </li>
                <li>
                  <a href="/service/proxy/index.html">proxy</a>
                </li>
                <li>
                  <a href="/service/squid/index.html">squid</a>
                </li>
                <li>
                  <a href="/service/svn/index.html">svn</a>
                </li>
                <li>
                  <a href="/service/tomcat/index.html">tomcat</a>
                </li>
                <li>
                  <a href="/service/vpn/index.html">vpn</a>
                </li>
                <li>
                  <a href="/service/zabbix/index.html">zabbix</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>nginx: 配置 - (实践)HTTP负载均衡</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>14 Dec 2015</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>0. 环境介绍</h2>

<ul>
<li>proxy-172.16.2.243（前端负载均衡）</li>
<li>web01-172.16.2.244</li>
<li>web02-172.16.2.245</li>
<li>windows7-172.16.2.28</li>
</ul>

<h2>1. 负载均衡配置</h2>

<h3><strong>proxy前端</strong></h3>
<pre class="chroma">upstream websrv01 {
    server 172.16.2.244;
    server 172.16.2.245;
}
 
server {
    listen 80;
    server_name www.loadB.com;
    access_log /data/log/weblog/www.loadB.com.log main;
 
    location / {
        proxy_pass http://websrv01;
    }
</pre>
<h3><strong>web01</strong></h3>
<pre class="chroma">server {
    listen 80;
    server_name localhost;
    root /data/server/nginx/html;
    access_log /data/log/weblog/access.log main;
 
    location / {
        index index.html index.php;
    }
</pre>
<h3>web02</h3>
<pre class="chroma">server {
    listen 80;
    server_name localhost;
    root /data/server/nginx/html;
    access_log /data/log/weblog/access.log main;
 
    location / {
        index index.html index.php;
    }
</pre>
<h2>2. 访问效果</h2>

<p>先修改web01和web02的index.html内容</p>
<pre class="chroma"><span class="c1"># web01</span>
<span class="nb">echo</span> <span class="s2">&#34;FROM: 172.16.2.244&#34;</span> &gt; /data/server/nginx/html/index.html

<span class="c1"># web02</span>
<span class="nb">echo</span> <span class="s2">&#34;FROM: 172.16.2.245&#34;</span> &gt; /data/server/nginx/html/index.html
</pre>
<p><strong>proxy上访问</strong></p>
<pre class="chroma">curl -xlocalhost:80 www.loadB.com
FROM: 172.16.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.16.2.245

curl -xlocalhost:80 www.loadB.com
FROM: 172.16.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.16.2.245
</pre>
<p>244和255交替出现</p>

<h2>3. 日志查看</h2>
<pre class="chroma"><span class="c1"># proxy</span>
tail /data/log/weblog/www.loadB.com.log
172.16.2.28 - - <span class="o">[</span>15/Dec/2015:18:58:33 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36&#34;</span> <span class="s2">&#34;-&#34;</span>
 
<span class="c1"># web01</span>
tail /data/log/weblog/access.log
172.16.2.243 - - <span class="o">[</span>15/Dec/2015:19:01:12 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.0&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36&#34;</span> <span class="s2">&#34;-&#34;</span>
 
<span class="c1"># web02</span>
tail /data/log/weblog/access.log
172.16.2.243 - - <span class="o">[</span>15/Dec/2015:18:58:22 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.0&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36&#34;</span> <span class="s2">&#34;-&#34;</span>
</pre>
<p>看到上面日志，发现两个问题
1、看proxy端的日志，无法分辨是哪一个web服务器处理的请求
2、看web端的日志，源ip不是客户端ip，而是proxy的ip
下面我们来解决它们</p>

<h2>4. 解决上面的配置问题</h2>

<h3>4.1 proxy端的日志配置</h3>

<p><strong>upstream 模块的变量</strong></p>

<ul>
<li>$upstream_addr:             处理请求的upstream 服务器地址</li>
<li>$upstream_status:           upstream 服务器的应答状态</li>
<li>$upstream_response_time:    upstream 服务器的响应时间</li>
<li>$upstream<em>http</em>$HEADER:     任意的协议头信息例如：$upstream_http_host</li>
</ul>

<p><strong>日志配置</strong></p>
<pre class="chroma"><span class="c1"># vim nginx.conf</span>
**********************************************************
<span class="c1">## 增加log_format</span>
log_format upstream <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
                      <span class="s1">&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
                      <span class="s1">&#39;$upstream_addr &#34;$upstream_status&#34; &#34;$upstream_response_time&#34;&#39;</span><span class="p">;</span>
 
<span class="c1"># 修改www.loadB.com的日志格式配置</span>
access_log /data/log/weblog/www.loadB.com.log upstream<span class="p">;</span>
**********************************************************

<span class="c1"># 重启nginx</span>
nginx -t
nginx -s reload
</pre>
<p>用172.16.2.28访问数次后，重新查看日志记录</p>
<pre class="chroma">tail /data/log/weblog/www.loadB.com.log
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:00:24:08 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> 172.16.2.245:80 <span class="s2">&#34;200&#34;</span> <span class="s2">&#34;0.001&#34;</span>
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:00:24:08 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> 172.16.2.244:80 <span class="s2">&#34;200&#34;</span> <span class="s2">&#34;0.001&#34;</span>
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:00:24:08 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> 172.16.2.245:80 <span class="s2">&#34;200&#34;</span> <span class="s2">&#34;0.001&#34;</span>
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:00:24:08 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> 172.16.2.244:80 <span class="s2">&#34;200&#34;</span> <span class="s2">&#34;0.001&#34;</span>
<span class="c1"># 这里就可以看到哪一台web服务器处理的请求，处理的状态码，处理的时间了</span>
</pre>
<h3>4.2 获取客户端真实IP</h3>

<p><strong>语法介绍</strong></p>
<pre class="chroma">Syntax:        set_real_ip_from address | CIDR | unix:;
Default:        -
Context:        http, server, location
Defines trusted addresses that are known to send correct replacement addresses. If the special value unix: is specified, all UNIX-domain sockets will be trusted.
 
IPv6 addresses are supported starting from versions 1.3.0 and 1.2.1.
</pre>
<p>设置了此项的ip都会被认为是信任的ip，因此它们都拥有了可以提交client源ip的资格</p>
<pre class="chroma">Syntax:        real_ip_header field | X-Real-IP | X-Forwarded-For | proxy_protocol;
Default:        
real_ip_header X-Real-IP;
Context:        http, server, location
Defines the request header field whose value will be used to replace the client address.
 
The proxy_protocol parameter (1.5.12) changes the client address to the one from the PROXY protocol header. The PROXY protocol must be previously enabled by setting the proxy_protocol parameter in the listen directive.
</pre>
<p>X-Forwarded-For是将最后一个转发ip作为访问ip写入日志中</p>

<h4>4.2.1 使用X-Real-IP</h4>
<pre class="chroma"><span class="c1"># proxy端配置</span>
vim nginx.conf
**********************************************************
server <span class="o">{</span>
    listen <span class="m">80</span> <span class="p">;</span>
    server_name www.loadB.com<span class="p">;</span>
    access_log /data/log/weblog/www.loadB.com.log upstream<span class="p">;</span>
 
    location / <span class="o">{</span>
        proxy_pass http://websrv01<span class="p">;</span>
        proxy_set_header X-Real-IP       <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header Host            <span class="nv">$host</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>

 
<span class="c1"># web端配置</span>
vim nginx.conf
**********************************************************
<span class="c1">## 放在http块中</span>
set_real_ip_from 172.16.2.243<span class="p">;</span>
real_ip_header   X-Real-IP<span class="p">;</span>
**********************************************************
</pre>
<p>查看效果</p>
<pre class="chroma"><span class="c1">## proxy端日志查看</span>
<span class="c1"># tail -1 /data/log/weblog/www.loadB.com.log</span>
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:01:46:32 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> 172.16.2.245:80 <span class="s2">&#34;200&#34;</span> <span class="s2">&#34;0.001&#34;</span>
 
<span class="c1">## web端日志查看</span>
<span class="c1"># tail -1 /data/log/weblog/access.log</span>
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:01:46:32 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.0&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36&#34;</span> <span class="s2">&#34;-&#34;</span>
</pre>
<h4>4.2.2 使用X-Forwarded-For</h4>
<pre class="chroma"><span class="c1"># proxy端配置</span>
vim nginx.conf
**********************************************************
server <span class="o">{</span>
    listen <span class="m">80</span> <span class="p">;</span>
    server_name www.loadB.com<span class="p">;</span>
    access_log /data/log/weblog/www.loadB.com.log upstream<span class="p">;</span>
 
    location / <span class="o">{</span>
        proxy_pass http://websrv01<span class="p">;</span>
<span class="c1">#        proxy_set_header X-Real-IP       $remote_addr;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header Host            <span class="nv">$host</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
**********************************************************
 
<span class="c1"># web端配置</span>
vim nginx.conf
**********************************************************
<span class="c1">## 放在http块中</span>
set_real_ip_from 172.16.2.243<span class="p">;</span>
real_ip_header   X-Forwarded-For<span class="p">;</span>
**********************************************************
</pre>
<p>查看效果</p>
<pre class="chroma"><span class="c1"># proxy端日志查看</span>
tail -1 /data/log/weblog/www.loadB.com.log
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:03:19:59 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> 172.16.2.244:80 <span class="s2">&#34;200&#34;</span> <span class="s2">&#34;0.000&#34;</span>
 
<span class="c1"># web端日志查看</span>
tail -1 /data/log/weblog/access.log
172.16.2.28 - - <span class="o">[</span>16/Dec/2015:03:20:00 +0800<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.0&#34;</span> <span class="m">200</span> <span class="m">19</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36&#34;</span> <span class="s2">&#34;172.16.2.28&#34;</span>
</pre>
<h2>5. 错误汇总</h2>

<h3>5.1 错误1</h3>

<h4><strong>无法配置&rdquo;set_real_ip_from&rdquo;</strong></h4>
<pre class="chroma">nginx -t
nginx: <span class="o">[</span>emerg<span class="o">]</span> unknown directive <span class="s2">&#34;set_real_ip_from&#34;</span> in /data/server/nginx/conf/nginx.conf:26
nginx: configuration file /data/server/nginx/conf/nginx.conf <span class="nb">test</span> failed
</pre>
<h4><strong>解决方案</strong></h4>
<pre class="chroma"><span class="c1"># recompile nginx</span> 
/etc/init.d/nginxd stop
cp nginx.conf /root/
rm -rf /data/server/nginx/*
<span class="nb">cd</span> /usr/local/src/nginx-1.8.0
make clean
./configure --user<span class="o">=</span>nginx --group<span class="o">=</span>nginx --prefix<span class="o">=</span>/data/server/nginx --with-http_stub_status_module --with-http_ssl_module --with-pcre  --with-http_realip_module
make
make install
cp /root/nginx.conf /data/server/nginx/conf/
</pre>
<h2>6. 其他负载方式</h2>

<h3>6.1 Least connected load balancing</h3>

<h4><strong>原配置</strong></h4>
<pre class="chroma">****************************************************
upstream websrv01 {
#    least_conn;
    server 172.16.2.244;
    server 172.16.2.245;
}
 
server {
    listen 80 ;
    server_name www.loadB.com;
    access_log /data/log/weblog/www.loadB.com.log upstream;
 
    location / {
        proxy_pass http://websrv01;
#        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host            $host;
    }
}
****************************************************
</pre>
<h4><strong>ab(Apache HTTP server benchmarking tool)测试</strong></h4>
<pre class="chroma"><span class="c1"># 备份日志文件</span>
mv www.loadB.com.log 20151023/
<span class="nb">kill</span> -HUP <span class="sb">`</span>cat /data/server/nginx/logs/nginx.pid<span class="sb">`</span>
 
<span class="c1"># 对proxy做20000次访问测试，同时，在此期间对web01做2000次访问测试</span>

<span class="c1"># 在proxy上</span>
ab -n <span class="m">20000</span> -c <span class="m">100</span> -X localhost:80 http://www.loadB.com:80/        <span class="c1"># 必须要加最后的&#34;/&#34;</span>

<span class="c1"># 在web01上</span>
ab -n <span class="m">2000</span> -c <span class="m">100</span> localhost/
 
<span class="c1"># 结果是两台机器次数基本一致</span>
cat /data/log/weblog/www.loadB.com.log <span class="p">|</span>cut -d <span class="s1">&#39; &#39;</span> -f <span class="m">12</span> <span class="p">|</span>sort<span class="p">|</span>uniq -c
  <span class="m">10021</span> 172.16.2.244:80
  <span class="m">10019</span> 172.16.2.245:80
</pre>
<h4><strong>修改配置，采用least_conn负载均衡</strong></h4>
<pre class="chroma">****************************************************
upstream websrv01 <span class="o">{</span>
    least_conn<span class="p">;</span>
    server 172.16.2.244<span class="p">;</span>
    server 172.16.2.245<span class="p">;</span>
<span class="o">}</span>
 
server <span class="o">{</span>
    listen <span class="m">80</span> <span class="p">;</span>
    server_name www.loadB.com<span class="p">;</span>
    access_log /data/log/weblog/www.loadB.com.log upstream<span class="p">;</span>
 
    location / <span class="o">{</span>
        proxy_pass http://websrv01<span class="p">;</span>
<span class="c1">#        proxy_set_header X-Real-IP       $remote_addr;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header Host            <span class="nv">$host</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
****************************************************
nginx -t
nginx -s reload
 
<span class="c1"># 每次测试前必须先重新生成空的日志文件</span>
rm -rf www.loadB.com.log  
<span class="nb">kill</span> -HUP <span class="sb">`</span>cat /data/server/nginx/logs/nginx.pid<span class="sb">`</span> 
</pre>
<h4><strong>ab测试1</strong></h4>
<pre class="chroma"><span class="c1"># 对proxy做100000次访问测试，同时，在此期间对web01做20000次访问测试</span>

<span class="c1"># 在proxy上</span>
ab -n <span class="m">100000</span> -c <span class="m">100</span> -X localhost:80 http://www.loadB.com:80/    

<span class="c1"># 在web01上</span>
ab -n <span class="m">20000</span> -c <span class="m">100</span> localhost/
 
<span class="c1"># proxy日志统计</span>
cat /data/log/weblog/www.loadB.com.log <span class="p">|</span>cut -d <span class="s1">&#39; &#39;</span> -f <span class="m">12</span> <span class="p">|</span>sort<span class="p">|</span>uniq -c
  <span class="m">49794</span> 172.16.2.244:80
  <span class="m">50259</span> 172.16.2.245:80
<span class="c1">## 后来又进行了次数不一的测试，发现在web01也有大量访问的时候，proxy确实会把放在web01上的访问减少一些</span>
</pre>
<h3>6.2 Session persistence</h3>

<h2>修改配置，采用least_conn负载均衡</h2>
<pre class="chroma">****************************************************
upstream websrv01 <span class="o">{</span>
    ip_hash<span class="p">;</span>
    server 172.16.2.244<span class="p">;</span>
    server 172.16.2.245<span class="p">;</span>
<span class="o">}</span>
 
server <span class="o">{</span>
    listen <span class="m">80</span> <span class="p">;</span>
    server_name www.loadB.com<span class="p">;</span>
    access_log /data/log/weblog/www.loadB.com.log upstream<span class="p">;</span>
 
    location / <span class="o">{</span>
        proxy_pass http://websrv01<span class="p">;</span>
<span class="c1">#        proxy_set_header X-Real-IP       $remote_addr;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header Host            <span class="nv">$host</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
****************************************************

<span class="c1"># proxy访问</span>
curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244
</pre>
<p>使用浏览器访问，会一直显示一个ip返回</p>

<p><strong>特别需要注意的两点</strong></p>

<ul>
<li>需要解决的一个问题是，如果页面有跳转，web01的主页你登录了以后，跳转到了web02上，而session会话是保存在web01，这样就有一个session在不同主机间如何共享的问题</li>
<li>因为是ip做了hash的key，绑定了我们的某一个web_server,这样的情况下，就不能随意的删除主机，而是在要临时停止一台主机的情况下，在该主机后面添加&rdquo; down&rdquo;，这样就会把绑定该down掉的主机的请求ip转交给别的web_server去解析</li>
</ul>

<h3>6.3 Weighted load balancing</h3>

<h4><strong>修改配置，采用least_conn负载均衡</strong></h4>
<pre class="chroma">****************************************************
upstream websrv01 <span class="o">{</span>
    server 172.16.2.244 <span class="nv">weight</span><span class="o">=</span>3<span class="p">;</span>
    server 172.16.2.245<span class="p">;</span>
<span class="o">}</span>
 
server <span class="o">{</span>
    listen <span class="m">80</span> <span class="p">;</span>
    server_name www.loadB.com<span class="p">;</span>
    access_log /data/log/weblog/www.loadB.com.log upstream<span class="p">;</span>
 
    location / <span class="o">{</span>
        proxy_pass http://websrv01<span class="p">;</span>
<span class="c1">#        proxy_set_header X-Real-IP       $remote_addr;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header Host            <span class="nv">$host</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
****************************************************

<span class="c1"># proxy访问</span>
curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.245

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.244

curl -xlocalhost:80 www.loadB.com
FROM: 172.26.2.245
</pre>
<p>权重指定了某个服务器访问次数的占比，这个要根据每个服务器具体的运行状态来调整</p>

<h3>6.4 更多的选项</h3>

<ul>
<li><p><code>proxy_next_upstream</code>，指定在什么条件下，转到下个upstream服务器，使用时必须存在upstream和proxy_pass</p>
<pre class="chroma">upstream backends {
......
}
server {
......
  location / {
    proxy_pass http://backends;
    proxy_next_upstream error timeout http_404;
}
}
</pre></li>

<li><p><code>backup</code>, 在主要的web server都不可访问的情况下启用加上此标识的服务器</p></li>

<li><p><code>down</code>, 暂时使增加该标识的服务器不可访问，而且会将ip_hash负载下的，对应此server的ip key转交给其他正常服务器</p></li>

<li><p><code>keepalive</code>, 正常的http连接，会在传输完成后关闭，而此标识能让连接不关闭一段指定的时长，来增快加载速度</p></li>
</ul>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>