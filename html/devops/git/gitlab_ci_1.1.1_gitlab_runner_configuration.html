<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式</a>
            </li>
            <li>
              <a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a>
            </li>
            <li>
              <a href="/service/nginx/nginx_2.1.9.03_configuration_log.html">nginx: 配置 - 日志</a>
            </li>
            <li>
              <a href="/linux/advance/network_tunnel-ipip.html">网络: 隧道 - IPIP</a>
            </li>
            <li>
              <a href="/linux/advance/network_ip-address.html">网络: IP - IP地址简介</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
              <ul>
                <li>
                  <a href="/devops/ansible/index.html">ansible</a>
                </li>
                <li>
                  <a href="/devops/arthas/index.html">arthas</a>
                </li>
                <li>
                  <a href="/devops/git/index.html">git</a>
                  <ul>
                    <li><a href="/devops/git/git_1.1.0_install.html">git: 1.1.0 安装</a></li>
                    <li><a href="/devops/git/git_1.2.0_branch.html">git: 1.2.0 分支</a></li>
                    <li><a href="/devops/git/git_1.2.1_branch_pr.html">git: 1.2.1 分支-Pull Request</a></li>
                    <li><a href="/devops/git/git_1.2.2_tag.html">git: 1.2.2 git tag</a></li>
                    <li><a href="/devops/git/git_1.3.0_gitignore.html">git: 1.3.0 忽略文件-“.gitignore”</a></li>
                    <li><a href="/devops/git/git_1.4.0_delete_file.html">git: 1.4.0 删除文件</a></li>
                    <li><a href="/devops/git/git_1.5.0_mv.html">git: 1.5.0 mv error(case sensitive of linux)</a></li>
                    <li><a href="/devops/git/git_1.6.0_commit_reverse.html">git: 1.6.0 撤销操作</a></li>
                    <li><a href="/devops/git/git_1.7.0_push_403.html">git: 1.7.0 push返回403</a></li>
                    <li><a href="/devops/git/git_1.8.0_add_link_file.html">git: 1.8.0 添加链接文件</a></li>
                    <li><a href="/devops/git/git_1.9.0_combine_commits_using_rebase.html">git: 1.9.0 使用rebase合并多个commit</a></li>
                    <li><a href="/devops/git/giterror_1.1.0_curl_18.html">git error: 1.1.0 curl 18 error</a></li>
                    <li><a href="/devops/git/github_tutorial.html">github: 入门引导</a></li>
                    <li><a href="/devops/git/gitlab_1.1.0_install.html">gitlab: 1.1.0 安装(centos6)</a></li>
                    <li><a href="/devops/git/gitlab_1.2.0_config_external_port.html">gitlab: 1.2.0 配置gitlab访问端口</a></li>
                    <li><a href="/devops/git/gitlab_1.3.0_backup_restore_update.html">gitlab: 1.3.0 gitlab备份,恢复及升级</a></li>
                    <li><a href="/devops/git/gitlab_ci_1.1.0_gitlab_runner_installation.html">gitlab-ci: 1.1.0 gitlab-runner安装(docker)</a></li>
                    <li><a href="/devops/git/gitlab_ci_1.1.1_gitlab_runner_configuration.html">gitlab-ci: 1.1.1 gitlab-runner(docker)配置</a></li>
                    <li><a href="/devops/git/gitlab_ci_1.2.0_gitlab_ci_yml_basic.html">gitlab-ci: 1.2.0 .gitlab-ci.yml 基础</a></li>
                    <li><a href="/devops/git/gitlab_ci_1.2.1_gitlab_ci_yml_cache_artifact.html">gitlab-ci: 1.2.1 .gitlab-ci.yml - cache and artifact</a></li>
                    <li><a href="/devops/git/gitlab_ci_1.2.2_gitlab_ci_yml_example.html">gitlab-ci: 1.2.2 .gitlab-ci.yml 复杂示例 - 包含get gitlab tag message</a></li>
                    <li><a href="/devops/git/gitlab_ci_1.3.0_build_docker_image.html">gitlab-ci: 1.3.0 编译docker镜像</a></li>
                    <li><a href="/devops/git/gitrepo_1.1.0_create_local_repo.html">git仓库: 1.1.0 centos6搭建git本地服务器</a></li>
                    <li><a href="/devops/git/gitrepo_1.2.0_anonymous_access.html">git仓库: 1.2.0 本地服务器开启匿名访问</a></li>
                    <li><a href="/devops/git/gitrepo_1.3.0_web.html">git仓库: 1.3.0 本地服务器web界面</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/devops/jenkins/index.html">jenkins</a>
                </li>
                <li>
                  <a href="/devops/mattermost/index.html">mattermost</a>
                </li>
                <li>
                  <a href="/devops/sonarqube/index.html">sonarqube</a>
                </li>
                <li>
                  <a href="/devops/vagrant/index.html">vagrant</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>gitlab-ci: 1.1.1 gitlab-runner(docker)配置</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>01 May 2020</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>0. gitlab-runner示例配置</h3>

<p><code>config.toml</code></p>
<pre class="chroma">concurrent = 1
check_interval = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = &#34;runner-01&#34;
  url = &#34;http://git.example.net&#34;
  token = &#34;your token here&#34;
  executor = &#34;docker&#34;
  [runners.custom_build_dir]
  [runners.cache]
    [runners.cache.s3]
    [runners.cache.gcs]
  [runners.docker]
    tls_verify = false
    image = &#34;alpine:latest&#34;
    privileged = false
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    cache_dir = &#34;/data/docker/data/gitlab-runner/cache&#34;
    volumes = [&#34;/data/docker/data/gitlab-runner/cache&#34;, &#34;/var/run/docker.sock:/var/run/docker.sock&#34;]
    shm_size = 0
    extra_hosts = [&#34;reg.example.net:172.28.1.50&#34;]
    host = &#34;&#34;
    hostname = &#34;&#34;
    memory = &#34;128m&#34;
    memory_swap = &#34;256m&#34;
    memory_reservation = &#34;64m&#34;
    oom_kill_disable = false
    cpuset_cpus = &#34;0,1&#34;
    cpus = &#34;2&#34;
    dns = [&#34;8.8.8.8&#34;]
    dns_search = [&#34;&#34;]
    userns_mode = &#34;host&#34;
    cap_add = [&#34;NET_ADMIN&#34;]
    cap_drop = [&#34;DAC_OVERRIDE&#34;]
    devices = [&#34;/dev/net/tun&#34;]
    wait_for_services_timeout = 30
    shm_size = 300000
    volumes_from = [&#34;storage_container:ro&#34;]
    links = [&#34;mysql_container:mysql&#34;]
    [runners.docker.sysctls]
      &#34;net.ipv4.ip_forward&#34; = &#34;1&#34;
</pre>
<h3>1. 配置cache目录</h3>
<pre class="chroma">[[runners]]
  cache_dir = &#34;/mycache&#34;
  [runners.docker]
    disable_cache = false
    cache_dir = &#34;/data/docker/data/gitlab-runner/builds&#34;
    volumes = [&#34;/data/docker/data/gitlab-runner/cache:/mycache&#34;]
</pre>
<ul>
<li>cache_dir([[runners]])：
指定的是执行job的容器中，缓存目录位置</li>
<li>cache_dir([runners.docker]):
指定的是缓存容器中/builds的本地目录</li>
<li>volumes如上面的配置，是手动挂载本地目录到cache目录，如果只是写&rdquo;/mycache&rdquo;，docker会自动创建一个volume，然后挂载过去</li>
</ul>
<pre class="chroma"><span class="c1"># 按照上面的配置，查看某个job的容器信息可以看到</span>
docker inspect containerid
...
<span class="s2">&#34;Binds&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;/data/docker/data/gitlab-runner/cache:/mycache&#34;</span>,
                <span class="s2">&#34;/data/docker/data/gitlab-runner/builds/runner-f6drxvp-project-150-concurrent-0/c33bcaa1fd2c77edfc3893b41966cea8:/builds&#34;</span>
            <span class="o">]</span>
...
<span class="c1"># 其中挂载了两个目录</span>
<span class="c1"># 一个是我们显示指定的/mycache目录</span>
<span class="c1"># 另外一个是[runners.docker]中cache_dir的配置作为根目录，挂载了子目录到容器的/builds目录</span>
</pre>
<blockquote>
<p>参考链接</p>

<ul>
<li><a href="https://forum.gitlab.com/t/what-is-the-cache-dir-of-the-docker-executor/4697">whats the cache_dir of the docker executor</a></li>
<li><a href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnersdocker-section">gitlab-runner advance configuration - runner-docker</a></li>
</ul>

<p>关于<code>[[runners]] - cache_dir</code>和<code>[runners.docker] - cache_dir</code>，官方文档的说明如下
<strong><code>[[runners]] - cache_dir</code></strong></p>
<pre class="chroma">Absolute path to a directory where build caches will be stored in context of selected executor (locally, Docker, SSH). If the docker executor is used, this directory needs to be included in its volumes parameter.
</pre>
<p><strong><code>[runners.docker] - cache_dir</code></strong></p>
<pre class="chroma">Specify where Docker caches should be stored (this can be absolute or relative to current working directory). See disable_cache for more information.
</pre>
<p><strong>误区</strong>
区别就在于前者是build cache，后者是docker cache，build cache是job的cache，docker cache是docker运行中使用的cache，其实就是job运行时的workdir(默认是/builds)，自己没仔细看人家文档，还以为人家瞎写文档乱配置，汗颜。不过这两个配置不明确是认真的。</p>
</blockquote>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>