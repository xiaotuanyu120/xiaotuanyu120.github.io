<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/network_tcp-reset.html">网络: TCP - RST简介</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.4_start_init.html">GO 1.1.4 入口函数和包初始化</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.3_build.html">GO 1.1.3 构建应用</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.2_proj_struct.html">GO 1.1.2 目录结构</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.1_code_struct.html">GO 1.1.1 程序结构和编译</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
              <ul>
                <li>
                  <a href="/go/go/index.html">go</a>
                  <ul>
                    <li><a href="/go/go/go_1.0.0_introduction.html">GO 1.0.0 go语言</a></li>
                    <li><a href="/go/go/go_1.1.0_install.html">GO 1.1.0 安装</a></li>
                    <li><a href="/go/go/go_1.1.1_code_struct.html">GO 1.1.1 程序结构和编译</a></li>
                    <li><a href="/go/go/go_1.1.2_proj_struct.html">GO 1.1.2 目录结构</a></li>
                    <li><a href="/go/go/go_1.1.3_build.html">GO 1.1.3 构建应用</a></li>
                    <li><a href="/go/go/go_1.1.4_start_init.html">GO 1.1.4 入口函数和包初始化</a></li>
                    <li><a href="/go/go/go_1.2.0_gb.html">GO 1.2.0 build tools-gb</a></li>
                    <li><a href="/go/go/go_1.3.0_tools.html">GO 1.3.0 原生工具</a></li>
                    <li><a href="/go/go/go_1.4.0_error_Scan_for_time.Time.html">GO 1.4.0 error Scan() 支持time.Time</a></li>
                    <li><a href="/go/go/go_1.4.1_error_ld_cannot_find_lstdc++.html">GO 1.4.1 error 编译错误 - ld: cannot find -lstdc++</a></li>
                    <li><a href="/go/go/go_1.5.0_iterate_field_of_struct.html">GO 1.5.0 遍历struct的fields</a></li>
                    <li><a href="/go/go/go_1.6.0_reflect_get_struct_tag_name.html">GO 1.6.0 reflect获取struct的tag值</a></li>
                    <li><a href="/go/go/go_1.7.0_string_to_byte.html">GO 1.7.0 string转换成byte</a></li>
                    <li><a href="/go/go/go_2.1.0_slice_append_extend.html">GO 2.1.0 slice append元素和extend新slice</a></li>
                    <li><a href="/go/go/go_2.2.0_typeof_object.html">GO 2.2.0 查看object的type的三种方法</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>GO 1.1.4 入口函数和包初始化</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>27 Oct 2022</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>1. 背景</h2>

<p>一个 Go 项目中有多个包，一个包有多个文件，同时每个包中又有多个常量、变量、各种函数和方法，那 Go 代码是使用什么顺序加载它们，又是从哪里开始执行的呢？</p>

<h2>2. <code>main.main</code> 函数：Go 应用的入口函数</h2>

<p>Go 语言中有一个特殊的函数 <code>main.main</code>，它是所有 Go 可执行应用的用户层执行逻辑的入口函数。</p>

<p><code>main.main</code> 函数没有参数，也没有返回值</p>
<pre class="chroma"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>
</pre>
<p>Go 语言要求，可执行程序的main包，必须要包含main函数，否则 Go 编译器会报错</p>
<pre class="chroma">go build main.go 
<span class="c1"># command-line-arguments</span>
runtime.main_main·f: <span class="k">function</span> main is undeclared in the main package
</pre>
<p>另外值得注意的是，其他的包也可以拥有自己的main函数，但是不同包中的main函数只能在自己的包内部使用。</p>
<pre class="chroma"><span class="c1">// main.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;github.com/fakeuser/mod/pkg1&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello world&#34;</span><span class="p">)</span>
	<span class="nx">pkg1</span><span class="p">.</span><span class="nf">Main</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</pre><pre class="chroma"><span class="c1">// pkg1/pkg1.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">pkg1</span>

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>

<span class="kd">func</span> <span class="nf">Main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">main</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;main from pkg1&#34;</span><span class="p">)</span>
<span class="p">}</span>
</pre>
<p><code>pkg1</code> 包中的 <code>main</code> 函数，只能在 <code>pkg1</code> 包内部使用，这个例子就是在 <code>pkg1.Main</code> 这个函数中执行了它</p>
<pre class="chroma"><span class="c1"># What is the output?</span>
go run main.go
Hello world
main from pkg1
</pre>
<h2>3.  <code>init()</code> 函数：包初始化函数</h2>

<p><code>main.main</code> 虽然是用户层执行逻辑的入口函数，但是它并不是用户层被执行的第一个函数，<code>init</code> 函数才是。如果 <code>main</code> 包依赖的包中有 <code>init</code> 函数，或者 <code>main</code> 包自身有包含 <code>init</code> 函数，那么 Go 在这个程序初始化的时候，会自动调用它的 <code>init</code> 函数，因此，这些 <code>init</code> 函数的执行会在 <code>main.main</code> 函数之前。</p>

<p><code>init</code> 函数也是一个无参数无返回值的函数</p>
<pre class="chroma"><span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;print from init&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>
</pre>
<p>用户无法显式的调用 <code>init</code> 函数</p>
<pre class="chroma"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">init</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</pre>
<p>执行后会发生编译错误</p>
<pre class="chroma">go run main.go  
<span class="c1"># command-line-arguments</span>
./main.go:14:2: undefined: init
</pre>
<p>实际上，每一个 Go 包，或者每一个 Go 包中的源文件，都可以声明多个 <code>init</code> 函数。Go 编译器会特别对待 <code>init</code> 函数，因此不会发生函数名称重复的报错。</p>

<p>在初始化时，Go 会按照一定的次序，顺序并逐一的执行每个 <code>init</code> 函数。一般情况下，先传递给 Go 编译器的源文件中的 <code>init</code> 函数会被先执行；同一个源文件中的不同 <code>init</code> 函数，会根据声明的先后顺序依次执行。</p>

<h2>4. Go 包的初始化次序</h2>

<p>从程序逻辑结构角度来看，Go 包是程序逻辑封装的基本单元，每个包都可以理解为一个“自治”的、封装良好的、对外暴露有限接口的基本单元。一个 Go 程序就是一组包组成的，程序的初始化就是这些包的初始化。每个 Go 包还会有自己的依赖包、常量、变量、init函数等。</p>

<p>Go 包的初始化次序流程图
<img src="/static/images/docs/go/go_1.1.4_01.jpg" alt="" /></p>

<p>初始化次序注意点：</p>

<ul>
<li>每一个 Go 包的初始化内容都遵循 “常量 -&gt; 变量 -&gt; init 函数”的顺序</li>
<li>Go 包的初始化会采用“深度优先”原则</li>
<li>包内多个 <code>init()</code> 函数按照声明顺序初始化</li>
</ul>

<h3>4.1 Go 包初始化次序示例</h3>

<p>包之间的依赖关系如下</p>
<pre class="chroma"><span class="c1"># 依赖关系</span>
main &gt; pkg1 &gt; pkg3
     &gt; pkg2 &gt; pkg3
</pre>
<p><code>main.go</code></p>
<pre class="chroma"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/fakeuser/mod/pkg1&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/fakeuser/mod/pkg2&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">c</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">1</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span>        <span class="p">=</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span> <span class="kt">string</span> <span class="p">=</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;main init()&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;main var init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;main const init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>
</pre>
<p><code>pkg1/pkg1.go</code></p>
<pre class="chroma"><span class="kn">package</span> <span class="nx">pkg1</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/fakeuser/mod/pkg3&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">c</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">1</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span>        <span class="p">=</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span> <span class="kt">string</span> <span class="p">=</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg1 init()&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg1 var init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg1 const init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>
</pre>
<p><code>pkg2/pkg2.go</code></p>
<pre class="chroma"><span class="kn">package</span> <span class="nx">pkg2</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/fakeuser/mod/pkg3&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">c</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">1</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span>        <span class="p">=</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span> <span class="kt">string</span> <span class="p">=</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg2 init()&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg2 var init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg2 const init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>
</pre>
<p><code>pkg3/pkg3.go</code></p>
<pre class="chroma"><span class="kn">package</span> <span class="nx">pkg3</span>

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>

<span class="kd">const</span> <span class="nx">c</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">1</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span>        <span class="p">=</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span> <span class="kt">string</span> <span class="p">=</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg3 init()&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">varInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg3 var init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">constInit</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg3 const init&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>
</pre>
<p>执行查看各个包的初始化顺序</p>
<pre class="chroma">go run main.go
pkg3 const init
pkg3 var init
pkg3 init<span class="o">(</span><span class="o">)</span>
pkg1 const init
pkg1 var init
pkg1 init<span class="o">(</span><span class="o">)</span>
pkg2 const init
pkg2 var init
pkg2 init<span class="o">(</span><span class="o">)</span>
main const init
main var init
main init<span class="o">(</span><span class="o">)</span>
Hello world
</pre>
<h2>5. init() 函数的用途</h2>

<h3>5.1 重置包级变量值</h3>

<h3>5.2 实现对包级变量的复杂初始化</h3>

<h3>5.3 在 init() 函数中实现注册模式</h3>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>