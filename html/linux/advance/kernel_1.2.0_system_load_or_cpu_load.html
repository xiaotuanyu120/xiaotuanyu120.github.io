<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/cryptography/basic/openssl_1.3.1_usage.html">openssl 1.3.1 SSL DEBUG: s_client</a>
            </li>
            <li>
              <a href="/linux/advance/network_theory-TCP-IP-note.html">网络: 理论 - TCP/IP详解读书笔记</a>
            </li>
            <li>
              <a href="/service/apache/1.0.1_apache_work_mode.html">apache: 理论 - 工作模式</a>
            </li>
            <li>
              <a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a>
            </li>
            <li>
              <a href="/service/nginx/nginx_2.1.9.03_configuration_log.html">nginx: 配置 - 日志</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
              <ul>
                <li>
                  <a href="/linux/advance/index.html">advance</a>
                  <ul>
                    <li><a href="/linux/advance/auditd_1.0.0_basic.html">auditd: linux 审计</a></li>
                    <li><a href="/linux/advance/bash_02_00_login_shell_vs_non_login_shell.html">bash: login shell vs non-login shell</a></li>
                    <li><a href="/linux/advance/bash_1.1.0_.bashrc_vs_.bash_profile.html">bash 1.1.0 .bashrc vs .bash_profile</a></li>
                    <li><a href="/linux/advance/centos6_booted_services_optimize.html">centos6 开机服务优化</a></li>
                    <li><a href="/linux/advance/disk_1.0.1_xfs_undelete_recovery.html">disk: 1.0.1 xfs 硬盘数据恢复</a></li>
                    <li><a href="/linux/advance/dns_00_how_dns_work_in_linux.html">DNS: Linux中的DNS解析是如何工作的</a></li>
                    <li><a href="/linux/advance/dns_01_dns_problem_analysis.html">DNS: DNS解析问题排查实践</a></li>
                    <li><a href="/linux/advance/ffmpeg_1.1.0_convert_h265_to_h264.html">ffmpeg: 1.1.0 转换h265为h264</a></li>
                    <li><a href="/linux/advance/firewall_ipset_basic.html">firewall: ipset使用教程</a></li>
                    <li><a href="/linux/advance/firewall_ipset_bitmap_ip_mac.html">firewall: ipset-bitmap:ip,mac</a></li>
                    <li><a href="/linux/advance/firewall_iptables_filter_by_country.html">firewall: iptables防国家或地区流量</a></li>
                    <li><a href="/linux/advance/firewall_iptables_install_centos7.html">firewall: Centos7安装iptables</a></li>
                    <li><a href="/linux/advance/glibc_1.1.0_centos6.5_upgrade_2.14.html">glibc 1.1.0 centos6升级到2.14</a></li>
                    <li><a href="/linux/advance/kernel_1.1.0_tcp_time_wait.html">linux内核: TCP - TIME_WAIT</a></li>
                    <li><a href="/linux/advance/kernel_1.1.1_nf_conntrack_table.html">linux内核: TCP - nf_conntrack table</a></li>
                    <li><a href="/linux/advance/kernel_1.1.2_tcp_time_wait_len_vs_fin_timeout.html">linux内核: TCP - TIMEWAIT销毁时间是否可以通过tcp_fin_timeout优化？</a></li>
                    <li><a href="/linux/advance/kernel_1.1.3_listen_backlog.html">linux内核: listen()中的backlog</a></li>
                    <li><a href="/linux/advance/kernel_1.1.4_cgroup.html">linux内核: cgroup</a></li>
                    <li><a href="/linux/advance/kernel_1.1.5_enable_module.html">linux内核: 模块 - 启用模块</a></li>
                    <li><a href="/linux/advance/kernel_1.2.0_system_load_or_cpu_load.html">linux内核: 理论 - system load or cpu load</a></li>
                    <li><a href="/linux/advance/linux登录后显示_bash-4.1.html">linux登录后显示_bash-4.1</a></li>
                    <li><a href="/linux/advance/memory_01_how_memory_work_in_linux.html">内存: linux中的内存是如何工作的？</a></li>
                    <li><a href="/linux/advance/memory_02_what_is_inside_meminfo.html">内存: /proc/meminfo里面有什么？</a></li>
                    <li><a href="/linux/advance/memory_03_general_memory_layout.html">内存: 进程内存布局 - 堆栈</a></li>
                    <li><a href="/linux/advance/network_ip-address.html">网络: IP - IP地址简介</a></li>
                    <li><a href="/linux/advance/network_tcp-alive-time-check.html">网络: TCP - tcp连接存活时间查询方法</a></li>
                    <li><a href="/linux/advance/network_tcp-handshake-and-close.html">网络: TCP - 理解TCP三次握手和四次挥手</a></li>
                    <li><a href="/linux/advance/network_tcp-keepalive.html">网络: TCP - tcp keepalive and http keepalive</a></li>
                    <li><a href="/linux/advance/network_tcp-queue.html">网络: TCP - tcp queue(转载)</a></li>
                    <li><a href="/linux/advance/network_theory-TCP-IP-note.html">网络: 理论 - TCP/IP详解读书笔记</a></li>
                    <li><a href="/linux/advance/network_tools-nmcli.html">网络: 工具 - nmcli</a></li>
                    <li><a href="/linux/advance/network_tunnel-ipip.html">网络: 隧道 - IPIP</a></li>
                    <li><a href="/linux/advance/network_usage-Centos7-no-nic-device.html">网络: 应用 - 没有可用的网络设备(Centos7)</a></li>
                    <li><a href="/linux/advance/network_usage-centos7-dual-interface-card-dual-gateway.html">网络: 应用 - 多网卡+多网关配置</a></li>
                    <li><a href="/linux/advance/network_usage-centos7-network-error.html">网络: 应用 - 网络服务错误(Centos7)</a></li>
                    <li><a href="/linux/advance/network_usage-vmware-clone-Centos6.html">网络: 应用 - vmware克隆VM后的网络设置(Centos6)</a></li>
                    <li><a href="/linux/advance/openssh_1.0.1_sshd_key_auth_error.html">openssh 1.0.1 sshd 密钥认证错误原因排查</a></li>
                    <li><a href="/linux/advance/optimize_1.2.0_web.html">调优: 1.2.0 web服务器优化</a></li>
                    <li><a href="/linux/advance/performance_01_io_limit.html">performance: 限制进程的IO消耗</a></li>
                    <li><a href="/linux/advance/rlimit_fd_00_file_handler_vs_file_descriptor.html">rlimit: fd - 扩展文件句柄vs文件描述符</a></li>
                    <li><a href="/linux/advance/rlimit_fd_01_file_descriptor_brief_introduction.html">rlimit: fd - 简明介绍</a></li>
                    <li><a href="/linux/advance/rlimit_fd_02_commands_to_check_current_status.html">rlimit fd: 状态查看命令</a></li>
                    <li><a href="/linux/advance/rlimit_fd_03_how_linux_limit_fd.html">rlimit fd: linux中如何管理fd</a></li>
                    <li><a href="/linux/advance/rlimit_ulimit_01_introduce.html">rlimit ulimit: 简明介绍</a></li>
                    <li><a href="/linux/advance/rlimit_ulimit_02_permission_error.html">rlimit ulimit: 普通用户无法修改ulimit</a></li>
                    <li><a href="/linux/advance/rsync_1.1.0_max_connections.html">rsync 1.1.0 error: max connections reached</a></li>
                    <li><a href="/linux/advance/rsync_1.2.0_chmod_chown.html">rsync 1.2.0 chown chmod</a></li>
                    <li><a href="/linux/advance/selinux_1.0.0_basic.html">selinux 1.0.0 basic</a></li>
                    <li><a href="/linux/advance/selinux_1.0.1_enable_selinux_from_disabled.html">selinux 1.0.1 enable selinux from disabled status</a></li>
                    <li><a href="/linux/advance/selinux_1.0.2_sshd_public_key_lable.html">selinux 1.0.2 lable sshd public key file</a></li>
                    <li><a href="/linux/advance/server_time_NTP-install-and-config.html">SERVER TIME: NTP - 服务安装及配置</a></li>
                    <li><a href="/linux/advance/ssl_generate_key_cfssl.html">ssl: generate key by cfssl</a></li>
                    <li><a href="/linux/advance/sudo_1.1.0_SETENV_NOPASSWD.html">sudo 1.1.0 执行sudo时保持env变量</a></li>
                    <li><a href="/linux/advance/sys_mng_000_centos7-ntp-chrony.html">系统管理: 时间同步 - centos7-ntp-chrony</a></li>
                    <li><a href="/linux/advance/sys_mng_001_file_and_user_process.html">系统管理: 排查 - 查看文件与用户和进程的关联</a></li>
                    <li><a href="/linux/advance/systemd_00_00_rlimit_settings.html">systemd: 系统资源限制</a></li>
                    <li><a href="/linux/advance/systemd_1.0.0_hook_start_and_stop.html">systemd 1.0.0 同时启动关停多个服务</a></li>
                    <li><a href="/linux/advance/systemd_1.1.0_debug_cmd.html">systemd 1.1.0 排查错误使用的命令</a></li>
                    <li><a href="/linux/advance/systemd_1.2.0_unit_file_load_sequence_and_manual.html">systemd 1.2.0 unit file load sequence and manual</a></li>
                    <li><a href="/linux/advance/systemd_1.3.0_start_pre_and_post.html">systemd 1.3.0 exec pre and post</a></li>
                    <li><a href="/linux/advance/systemd_2.1.0_watchdog_for_tomcat.html">systemd 2.1.0 watchdog of systemd for tomcat</a></li>
                    <li><a href="/linux/advance/systemd_2.1.1_watchdog_for_tomcat_error_of_nonroot_user.html">systemd 2.1.1 watchdog of systemd for tomcat continue: nonroot user problem</a></li>
                    <li><a href="/linux/advance/systeminfo_1.1.0_cpuinfo.html">系统信息：1.1.0 cpuinfo 超线程引起的争吵</a></li>
                  </ul>
                </li>
                <li>
                  <a href="/linux/basic/index.html">basic</a>
                </li>
                <li>
                  <a href="/linux/desktop/index.html">desktop</a>
                </li>
                <li>
                  <a href="/linux/monitoring/index.html">monitoring</a>
                </li>
                <li>
                  <a href="/linux/other/index.html">other</a>
                </li>
                <li>
                  <a href="/linux/service/index.html">service</a>
                </li>
                <li>
                  <a href="/linux/shell/index.html">shell</a>
                </li>
                <li>
                  <a href="/linux/tools/index.html">tools</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>linux内核: 理论 - system load or cpu load</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>18 Oct 2021</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>1. linux中的<code>cpu load</code>还是<code>system load</code>？</h3>

<p>一般情况下，稍微有经验的linux管理员都会熟练知道，查看系统负载，使用<code>top</code>、<code>uptime</code>或<code>w</code>命令都会输出load average的信息，分别是1、5、15分钟内的“cpu load”（并不是cpu load）信息。相信今天之前的我也会这样说，但是最近在重温系统负载相关知识的时候，竟然发现在一篇文章里面有如下表述:</p>
<pre class="chroma">On Linux, the system load includes threads both in Runnable (R) and in Uninterruptible sleep (D) states (typically disk I/O, but not always)
</pre>
<blockquote>
<p>出处：<a href="https://tanelpoder.com/posts/high-system-load-low-cpu-utilization-on-linux/">High System Load with Low CPU Utilization on Linux?</a></p>
</blockquote>

<p>大意是，linux的系统负载计算时，不仅包括处于可运行状态的进程，还包含了处于睡眠状态的“不可中断睡眠进程”。这个就太出乎我意料了，因为我一直以为这个<code>load average</code>是说的<code>cpu load</code>，如果事实真的是包含后者，那么这里就应该是<code>system load</code>（因为处于&rdquo;D&rdquo;状态的进程并不消耗cpu资源）了。</p>

<h3>2. linux中<code>load average</code>确实包含了<code>Uninteruptible sleep process</code>吗？</h3>

<p>先说结果，是的，和unix系统不同，linux系统上的<code>load average</code>是包含<code>Uninteruptible sleep process</code>的。</p>

<p>首先，在load的wiki上可以看到如下表述：</p>
<pre class="chroma">Most UNIX systems count only processes in the running (on CPU) or runnable (waiting for CPU) states. However, Linux also includes processes in uninterruptible sleep states (usually waiting for disk activity), which can lead to markedly different results if many processes remain blocked in I/O due to a busy or stalled I/O system.
</pre>
<p>明确的说明了unix和linux的不同，unix更符合我们的直觉，即为<code>cpu load</code>，而linux却是属实的<code>system load</code>。</p>

<h3>3. 为什么linux要这样设计呢？</h3>

<p>为了探寻linux这样设计的原因，我搜索到了一篇文章，果然并不是我一个人对这个感到好奇。</p>

<blockquote>
<p>主要参考：<a href="https://brendangregg.com/blog/2017-08-08/linux-load-averages.html">Linux Load Averages: Solving the Mystery</a>
作者：Brendan Gregg
下面的叙述主要参考了这篇文章中的内容。</p>
</blockquote>

<p>首先，linux在最开始的版本中，和unix的行为保持一致，<code>load average</code>表示的是<code>cpu load</code>。后面在某个版本中修改为了包含<code>Uninteruptible sleep process</code>，也就是说linux中的<code>load average</code>表达的不仅仅是cpu的负载，还包含了I/O的负载（硬盘或NFS等）。</p>

<p>那么，为什么呢？</p>

<p>于是文章的作者开始搜索linux内核的提交历史记录，终于在远古时期的邮件列表中，他找到了1993年的一个更动</p>
<pre class="chroma">From: Matthias Urlichs &lt;urlichs@smurf.sub.org&gt;
Subject: Load average broken ?
Date: Fri, 29 Oct 1993 11:37:23 +0200


The kernel only counts &#34;runnable&#34; processes when computing the load average.
I don&#39;t like that; the problem is that processes which are swapping or
waiting on &#34;fast&#34;, i.e. noninterruptible, I/O, also consume resources.

It seems somewhat nonintuitive that the load average goes down when you
replace your fast swap disk with a slow swap disk...

Anyway, the following patch seems to make the load average much more
consistent WRT the subjective speed of the system. And, most important, the
load is still zero when nobody is doing anything. ;-)

--- kernel/sched.c.orig Fri Oct 29 10:31:11 1993
+++ kernel/sched.c  Fri Oct 29 10:32:51 1993
@@ -414,7 +414,9 @@
    unsigned long nr = 0;

    for(p = &amp;LAST_TASK; p &gt; &amp;FIRST_TASK; --p)
-       if (*p &amp;&amp; (*p)-&gt;state == TASK_RUNNING)
+       if (*p &amp;&amp; ((*p)-&gt;state == TASK_RUNNING) ||
+                  (*p)-&gt;state == TASK_UNINTERRUPTIBLE) ||
+                  (*p)-&gt;state == TASK_SWAPPING))
            nr += FIXED_1;
    return nr;
 }
--
Matthias Urlichs        \ XLink-POP N|rnberg   | EMail: urlichs@smurf.sub.org
Schleiermacherstra_e 12  \  Unix+Linux+Mac     | Phone: ...please use email.
90491 N|rnberg (Germany)  \   Consulting+Networking+Programming+etc&#39;ing      42
</pre>
<p>提交这个更动的作者说，当用慢速的swap磁盘替换快速的swap磁盘时，负载竟然下降了，这样反映系统负载非常不直观。</p>

<p>中间关于这个问题，大方向没变，但是有关细节多次变动。</p>

<p>然后文章作者又探讨了如今（2017年）4.12版本的这个机制，而且Matthias在twitter回复了文章作者的邮件说：</p>
<pre class="chroma">&#34;The point of &#34;load average&#34; is to arrive at a number relating how busy the system is from a human point of view. TASK_UNINTERRUPTIBLE means (meant?) that the process is waiting for something like a disk read which contributes to system load. A heavily disk-bound system might be extremely sluggish but only have a TASK_RUNNING average of 0.1, which doesn&#39;t help anybody.&#34;
</pre>
<p>大意就是Matthias认为1993年的那个更动的思路在现在（2017）依然是对的。</p>

<p>然后作者认为，<code>Uninteruptible sleep process</code>现在已经不仅仅是代表了disk的负载，它包含了更多的东西，我们是否需要找寻另外一种方法，仅仅让<code>load average</code>包含<code>cpu load</code>和<code>disk load</code>。调度器的维护人员Peter Zijstra回应了他，Peter Zijstra表示可以用<code>task_struct-&gt;in_iowait</code>（进程的iowait）来替代<code>Uninteruptible sleep process</code>，这样更接近反映<code>cpu load</code>和<code>disk load</code>的真实情况（只是讨论，并未改动）。</p>

<h3>4. 总结</h3>

<p>linux为了反映<code>cpu load</code>和<code>disk load</code>的真实情况，所以将<code>load average</code>的计算包含了<code>Runable</code>和<code>Uninteruptible sleep</code>两种状态的进程。所以，之后如果看到linux系统的负载高，对于那些高I/O消耗的服务，有了另外一个排查的思路。</p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>