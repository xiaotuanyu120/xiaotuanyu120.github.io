<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/go/go/go_1.1.3_build.html">GO 1.1.3 构建应用</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.2_proj_struct.html">GO 1.1.2 目录结构</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.1_code_struct.html">GO 1.1.1 程序结构和编译</a>
            </li>
            <li>
              <a href="/go/go/go_1.0.0_introduction.html">GO 1.0.0 go语言</a>
            </li>
            <li>
              <a href="/service/tomcat/tomcat_1.0.0_what_is_jakarta_ee_and_tomcat.html">tomcat 1.0.0 Jakarta EE 和 Tomcat</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
              <ul>
                <li>
                  <a href="/blockchain/ethereum/index.html">ethereum</a>
                </li>
                <li>
                  <a href="/blockchain/hyperledger/index.html">hyperledger</a>
                  <ul>
                    <li><a href="/blockchain/hyperledger/fabric_1.0.0_install_prerequisites.html">hyperledger fabric: 1.0.0 Install Prerequisites</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_1.1.0_install_binarys_and_docker_images.html">hyperledger fabric: 1.1.0 Install Binaries and Docker Images</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.0.0_hyperledger_fabric_samples.html">hyperledger fabric tutorial: 1.0.0 hyperledger fabric samples</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.1.0_building_your_first_network.html">hyperledger fabric tutorial: 1.1.0 Building Your First Network</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.1.1_cryptogen_ca.html">hyperledger fabric tutorial: 1.1.1 BYFN-cryptogen</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.1.2_configtxgen_tool.html">hyperledger fabric tutorial: 1.1.2 BYFN-configtxgen</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.1.3_start_network.html">hyperledger fabric tutorial: 1.1.3 BYFN-start network</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.1.4_create___join_channel.html">hyperledger fabric tutorial: 1.1.4 BYFN-create & join channel</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.1.5_update_the_anchor_peers.html">hyperledger fabric tutorial: 1.1.5 BYFN-Update the anchor peers</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_1.1.6_install___instantiate_chaincode.html">hyperledger fabric tutorial: 1.1.6 BYFN-Install & Instantiate Chaincode</a></li>
                    <li><a href="/blockchain/hyperledger/fabric_tutorial_2.0.0_writing_your_first_application.html">hyperledger fabric tutorial: 2.0.0 WYFA-环境准备</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_0_introduce.html">hyperledger: 0. 课程介绍及hyperledger介绍</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.0.0_introduce.html">hyperledger: 1.0.0. 探索区块链技术</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.1.0_background.html">hyperledger: 1.1.0 背景-持续增加的对区块链技术的兴趣</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.10.0_types_of_blockchains.html">hyperledger: 1.10.0 区块链类型</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.11.0_p2p_network.html">hyperledger: 1.11.0 P2P网络架构</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.12.0_immutablity_of_data.html">hyperledger: 1.12.0 数据的不可变性</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.13.0_blockchain_application.html">hyperledger: 1.13.0 区块链应用</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.14.0_smart_contract.html">hyperledger: 1.14.0 智能合约</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.2.0_distributed_ledger_technology.html">hyperledger: 1.2.0 分布式账本-DLT</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.3.0_blockchain_technology.html">hyperledger: 1.3.0 区块链技术</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.4.0_blockchain_vs_distributed_ledger.html">hyperledger: 1.4.0 区块链技术 vs 分布式账本</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.5.0_blockchain_continue.html">hyperledger: 1.5.0 区块链技术（续）</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.6.0_merkle_tree.html">hyperledger: 1.6.0 Merkle Tree</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.8.0_transaction.html">hyperledger: 1.8.0 transaction</a></li>
                    <li><a href="/blockchain/hyperledger/hyperledger_1.9.0_blockchain_vs_database.html">hyperledger: 1.9.0 区块链与数据库的区别</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>hyperledger fabric tutorial: 2.0.0 WYFA-环境准备</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>29 Dec 2017</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h3>0. 说明</h3>

<p>在本节中，我们将查看一些示例程序，以了解Fabric应用程序的工作原理。 这些应用程序（以及他们使用的智能合约） - 统称为fabcar - 提供了Fabric功能的广泛演示。 值得注意的是，我们将显示与证书颁发机构进行交互并生成注册证书的过程，之后我们将利用这些生成的身份（用户对象）来查询和更新分类账。</p>

<p>我们将经历三个主要步骤：</p>

<ol>
<li><p>建立一个开发环境。<br />
我们的应用程序需要一个网络进行交互，所以我们将下载一个简单的注册/注册，查询和更新所需的组件：</p></li>

<li><p>学习我们的应用程序将使用的示例智能合约的参数。<br />
我们的智能合约包含各种功能，使我们能够以不同的方式与分类帐进行交互。我们将进入并检查这个智能合约，以了解我们的应用程序将使用的功能。</p></li>

<li><p>开发应用程序以查询和更新分类帐上的资产。<br />
我们将进入应用程序代码本身（我们的应用程序已经用Javascript编写），并手动操作变量来运行不同类型的查询和更新。</p></li>
</ol>

<p>完成本教程后，您应该对应用程序如何与智能合约一起编程，以便与Fabric网络上的账本（即peer）进行交互有基本的了解。</p>

<blockquote>
<p>这里使用的nodejs v6.12.2</p>
</blockquote>

<h3>1. 设置开发环境</h3>

<p>首先完成以下几个步骤：</p>

<ul>
<li><a href="https://hyperledger-fabric.readthedocs.io/en/latest/prereqs.html">prerequisites</a></li>
<li><a href="https://hyperledger-fabric.readthedocs.io/en/latest/samples.html">Hyperledger Fabric Samples</a></li>
</ul>
<pre class="chroma"><span class="c1"># 进入sample给我们的js写的application</span>
<span class="nb">cd</span> fabric-samples/fabcar  <span class="o">&amp;&amp;</span> ls
enrollAdmin.js  invoke.js  package.json  query.js  registerUser.js  startFabric.sh

<span class="c1"># 删除之前的docker运行的镜像，删掉docker简历的byfn网络</span>
docker rm -f <span class="k">$(</span>docker ps -aq<span class="k">)</span>
docker network prune
</pre>
<blockquote>
<p>如果是第二次进行此实验的话，需要删除之前创建的fabcar的镜像</p>
</blockquote>

<h3>2. 安装客户端并启动网络</h3>

<blockquote>
<p>以下过程需要你在<code>fabric-samples/fabcar</code>目录下执行</p>
</blockquote>

<p>这里我们将根据<code>package.json</code>来安装nodejs需要的依赖</p>
<pre class="chroma"><span class="p">{</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;fabcar&#34;</span><span class="p">,</span>
    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">,</span>
    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Hyperledger Fabric Car Sample Application&#34;</span><span class="p">,</span>
    <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;fabcar.js&#34;</span><span class="p">,</span>
    <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;test&#34;</span><span class="p">:</span> <span class="s2">&#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;</span>
    <span class="p">}</span><span class="p">,</span>
    <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;fabric-ca-client&#34;</span><span class="p">:</span> <span class="s2">&#34;unstable&#34;</span><span class="p">,</span>
        <span class="nt">&#34;fabric-client&#34;</span><span class="p">:</span> <span class="s2">&#34;unstable&#34;</span><span class="p">,</span>
        <span class="nt">&#34;grpc&#34;</span><span class="p">:</span> <span class="s2">&#34;^1.6.0&#34;</span>
    <span class="p">}</span><span class="p">,</span>
    <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="s2">&#34;Anthony O&#39;Dowd&#34;</span><span class="p">,</span>
    <span class="nt">&#34;license&#34;</span><span class="p">:</span> <span class="s2">&#34;Apache-2.0&#34;</span><span class="p">,</span>
    <span class="nt">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;Hyperledger&#34;</span><span class="p">,</span>
        <span class="s2">&#34;Fabric&#34;</span><span class="p">,</span>
        <span class="s2">&#34;Car&#34;</span><span class="p">,</span>
        <span class="s2">&#34;Sample&#34;</span><span class="p">,</span>
        <span class="s2">&#34;Application&#34;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre>
<blockquote>
<p>其中重点关注：</p>

<ul>
<li>fabric-ca-client，帮助我们的app和ca服务器通讯，并获取身份认证资料。</li>
<li>fabric-client，帮助我们加载身份认证资料，并和peer通信。</li>
</ul>
</blockquote>
<pre class="chroma"><span class="c1"># 安装nodejs依赖</span>
npm install
</pre>
<p>使用startFabric.sh shell脚本启动您的网络。这个命令会启动我们的各种Fabric实体，并启动一个用Golang编写的链式代码的智能合约容器：</p>
<pre class="chroma">./startFabric.sh

docker ps
CONTAINER ID        IMAGE                                                                                                    COMMAND                  CREATED             STATUS              PORTS                                            NAMES
4f5217221dd9        dev-peer0.org1.example.com-fabcar-1.0-5c906e402ed29f20260ae42283216aa75549c571e2e380f3615826365d8269ba   <span class="s2">&#34;chaincode -peer.a...&#34;</span>   <span class="m">13</span> minutes ago      Up <span class="m">13</span> minutes                                                        dev-peer0.org1.example.com-fabcar-1.0
620941d125ba        hyperledger/fabric-tools                                                                                 <span class="s2">&#34;/bin/bash&#34;</span>              <span class="m">13</span> minutes ago      Up <span class="m">13</span> minutes                                                        cli
fb329e284af4        hyperledger/fabric-peer                                                                                  <span class="s2">&#34;peer node start&#34;</span>        <span class="m">14</span> minutes ago      Up <span class="m">14</span> minutes       0.0.0.0:7051-&gt;7051/tcp, 0.0.0.0:7053-&gt;7053/tcp   peer0.org1.example.com
d6b7bc3da088        hyperledger/fabric-ca                                                                                    <span class="s2">&#34;sh -c &#39;fabric-ca-...&#34;</span>   <span class="m">14</span> minutes ago      Up <span class="m">14</span> minutes       0.0.0.0:7054-&gt;7054/tcp                           ca.example.com
86ac72ebcd40        hyperledger/fabric-orderer                                                                               <span class="s2">&#34;orderer&#34;</span>                <span class="m">14</span> minutes ago      Up <span class="m">14</span> minutes       0.0.0.0:7050-&gt;7050/tcp                           orderer.example.com
8dd2888ebc32        hyperledger/fabric-couchdb                                                                               <span class="s2">&#34;tini -- /docker-e...&#34;</span>   <span class="m">14</span> minutes ago      Up <span class="m">14</span> minutes       4369/tcp, 9100/tcp, 0.0.0.0:5984-&gt;5984/tcp       couchdb

</pre>
<blockquote>
<p>脚本首先执行了../basic-network/start.sh这个脚本，大意是关闭当前的docker-compose，启动一个网络，包含：ca.example.com orderer.example.com peer0.org1.example.com couchdb。<br />
然后在peer0.org1.example.com容器中进行了以下操作，创建了mychannel，把peer0加入了这个channel中来。</p>

<p>接着启动了cli容器，并在cli容器中执行了以下操作，安装了fabcar这个chaincode，实例化fabcar到mychannel中，并初始化它。</p>
</blockquote>

<h3>3. 应用程序如何与网络互动</h3>

<p>应用程序使用软件开发工具包（SDK）访问允许查询和更新账本的API。</p>

<blockquote>
<p>以下两节涉及与证书颁发机构的通信，查看其日志会很有用:<code>docker logs -f ca.example.com</code></p>
</blockquote>

<h4>1) 注册管理员用户</h4>

<p>当我们启动我们的网络时，一个管理员用户 - <code>admin</code> - 已经在我们的认证中心注册了。现在我们需要向CA服务器发送一个注册呼叫，取回admin的注册证书（eCert）。SDK和扩展我们的应用程序需要此证书，以形成管理员的用户对象。</p>
<pre class="chroma">node enrollAdmin.js
 Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully enrolled admin user <span class="s2">&#34;admin&#34;</span>
Assigned the admin user to the fabric client ::<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;admin&#34;</span>,<span class="s2">&#34;mspid&#34;</span>:<span class="s2">&#34;Org1MSP&#34;</span>,<span class="s2">&#34;roles&#34;</span>:null,<span class="s2">&#34;affiliation&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;enrollmentSecret&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;enrollment&#34;</span>:<span class="o">{</span><span class="s2">&#34;signingIdentity&#34;</span>:<span class="s2">&#34;19fbea5f91c0e305dfa4dca1718dc4e3cf2b949b7767106ac5956af1971b4a63&#34;</span>,<span class="s2">&#34;identity&#34;</span>:<span class="o">{</span><span class="s2">&#34;certificate&#34;</span>:<span class="s2">&#34;-----BEGIN CERTIFICATE-----\nMIIB8DCCAZegAwIBAgIUChHEKKwkU+JwSvdDDi8BVwtvrr4wCgYIKoZIzj0EAwIw\nczELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNh\nbiBGcmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMT\nE2NhLm9yZzEuZXhhbXBsZS5jb20wHhcNMTcxMjI5MDMxNjAwWhcNMTgxMjI5MDMx\nNjAwWjAQMQ4wDAYDVQQDEwVhZG1pbjBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IA\nBJISPwSX5Dqtpc/YcNqgVqaan7Su9+csCcN1G/wymmm7Ji1BOccqWnvHFQUhW6sF\nxU60VOLTFM9cHV9xtuk0/2GjbDBqMA4GA1UdDwEB/wQEAwIHgDAMBgNVHRMBAf8E\nAjAAMB0GA1UdDgQWBBTKXGfcilHxulLvHGVo86cStTW3yDArBgNVHSMEJDAigCBC\nOaoNzXba7ri6DNpwGFHRRQTTGq0bLd3brGpXNl5JfDAKBggqhkjOPQQDAgNHADBE\nAiA2BGOq1YFIB9B4j4MTDGm8WDxJSFflQxpyPFFo8wFynAIgc1MxxEKxJhtje+NW\nebeKPgCF8BxtN+c4gHAbRnufdlg=\n-----END CERTIFICATE-----\n&#34;</span><span class="o">}</span><span class="o">}</span><span class="o">}</span>
<span class="c1"># 文件内容储存在hfc-key-store/admin中</span>

<span class="c1"># 查看hfc-key-store目录</span>
ls hfc-key-store/
19fbea5f91c0e305dfa4dca1718dc4e3cf2b949b7767106ac5956af1971b4a63-priv  admin
19fbea5f91c0e305dfa4dca1718dc4e3cf2b949b7767106ac5956af1971b4a63-pub
</pre>
<p>该程序将调用证书签名请求（CSR），并最终将eCert和密钥材料输出到新创建的文件夹- <code>hfc-key-store</code> -中。当我们的应用程序需要为我们的不同用户创建或加载身份对象时，我们的应用程序将查找此位置。</p>

<p>同时在ca服务器的日志中我们发现</p>
<pre class="chroma">2017/12/29 03:21:03 [DEBUG] Received request for /api/v1/enroll
2017/12/29 03:21:03 [DEBUG] ca.Config: &amp;{CA:{Name:ca.example.com Keyfile:/etc/hyperledger/fabric-ca-server-config/4239aa0dcd76daeeb8ba0cda701851d14504d31aad1b2ddddbac6a57365e497c_sk Certfile:/etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem Chainfile:/etc/hyperledger/fabric-ca-server/ca-chain.pem} Signing:0xc42028df00 CSR:{CN:ca.org1.example.com Names:[{C:US ST:North Carolina L: O:Hyperledger OU:Fabric SerialNumber:}] Hosts:[d6b7bc3da088 localhost] KeyRequest:&lt;nil&gt; CA:0xc420291620 SerialNumber:} Registry:{MaxEnrollments:-1 Identities:[{ Name:**** Pass:**** Type:client Affiliation: MaxEnrollments:-1 Attrs:map[hf.Revoker:1 hf.IntermediateCA:1 hf.GenCRL:1 hf.Registrar.Attributes:* hf.Registrar.Roles:client,user,peer,validator,auditor hf.Registrar.DelegateRoles:client,user,validator,auditor]  }]} Affiliations:map[org1:[department1 department2] org2:[department1]] LDAP:{ Enabled:false URL:ldap://****:****@&lt;host&gt;:&lt;port&gt;/&lt;base&gt; UserFilter:(uid=%s) GroupFilter:(memberUid=%s) TLS:{false [/etc/hyperledger/fabric-ca-server/ldap-server-cert.pem] {/etc/hyperledger/fabric-ca-server/ldap-client-key.pem /etc/hyperledger/fabric-ca-server/ldap-client-cert.pem}}  } DB:{ Type:sqlite3 Datasource:/etc/hyperledger/fabric-ca-server/fabric-ca-server.db TLS:{false [/etc/hyperledger/fabric-ca-server/db-server-cert.pem] {/etc/hyperledger/fabric-ca-server/db-client-key.pem /etc/hyperledger/fabric-ca-server/db-client-cert.pem}}  } CSP:0xc4202918a0 Client:&lt;nil&gt; Intermediate:{ParentServer:{ URL: CAName:  } TLS:{Enabled:false CertFiles:[] Client:{KeyFile: CertFile:}} Enrollment:{ Name: Secret:**** Profile: Label: CSR:&lt;nil&gt; CAName: AttrReqs:[]  }} CRL:{Expiry:24h0m0s}}
2017/12/29 03:21:03 [DEBUG] DB: Getting identity admin
2017/12/29 03:21:03 [DEBUG] DB: Login user admin with max enrollments of -1 and state of 0
2017/12/29 03:21:03 [DEBUG] DB: identity admin successfully logged in
2017/12/29 03:21:03 [DEBUG] csrAuthCheck: id=admin, CommonName=admin, Subject=&lt;nil&gt;
2017/12/29 03:21:03 [DEBUG] CSR authorization check passed
2017/12/29 03:21:03 [DEBUG] Checking CSR fields to make sure that they do not exceed maximum character limits
2017/12/29 03:21:03 [DEBUG] DB: Getting information for identity admin
2017/12/29 03:21:03 [INFO] signed certificate with serial number 57486108224766557023846387326486306383092231870
2017/12/29 03:21:03 [DEBUG] DB: Insert Certificate
2017/12/29 03:21:03 [DEBUG] Saved serial number as hex a11c428ac2453e2704af7430e2f01570b6faebe
2017/12/29 03:21:03 [DEBUG] saved certificate with serial number 57486108224766557023846387326486306383092231870
2017/12/29 03:21:03 [DEBUG] Successfully incremented state for identity admin to 1
2017/12/29 03:21:03 [INFO] 172.18.0.1:47454 POST /api/v1/enroll 200 0 &#34;OK&#34;
</pre>
<h4>2) Register and Enroll user1</h4>

<p>使用我们新生成的admin eCert，我们现在将再次与CA服务器进行通信，以注册新用户。我们将使用新用户user1来查询和更新账本。需要注意的是，我们使用的是admin身份来注册的新用户。</p>
<pre class="chroma">node registerUser.js
 Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully loaded admin from persistence
Successfully registered user1 - secret:FmderpEJjOEZ
Successfully enrolled member user <span class="s2">&#34;user1&#34;</span>
User1 was successfully registered and enrolled and is ready to intreact with the fabric network

ls hfc-key-store/
19fbea5f91c0e305dfa4dca1718dc4e3cf2b949b7767106ac5956af1971b4a63-priv
19fbea5f91c0e305dfa4dca1718dc4e3cf2b949b7767106ac5956af1971b4a63-pub
admin
ae4555175023ca3f31d94941603b220fb9e702b12760c836b0f1adeb67bc7d36-priv
ae4555175023ca3f31d94941603b220fb9e702b12760c836b0f1adeb67bc7d36-pub
user1
</pre>
<p>ca容器的日志</p>
<pre class="chroma">2017/12/29 03:30:22 [DEBUG] Received request for /api/v1/register
2017/12/29 03:30:22 [DEBUG] Checking for revocation/expiration of certificate owned by &#39;admin&#39;
2017/12/29 03:30:22 [DEBUG] DB: Get certificate by serial (a11c428ac2453e2704af7430e2f01570b6faebe) and aki (4239aa0dcd76daeeb8ba0cda701851d14504d31aad1b2ddddbac6a57365e497c)
2017/12/29 03:30:22 [DEBUG] Successful token authentication of &#39;admin&#39;
2017/12/29 03:30:22 [DEBUG] Received registration request from admin: { Name:user1 Type: Secret:**** MaxEnrollments:1 Affiliation:org1.department1 Attributes:[] CAName:  }
2017/12/29 03:30:22 [DEBUG] DB: Getting identity admin
2017/12/29 03:30:22 [DEBUG] canRegister - Check to see if user admin can register
2017/12/29 03:30:22 [DEBUG] Validate Affiliation
2017/12/29 03:30:22 [DEBUG] Affiliation of &#39;org1.department1&#39; specified in registration request
2017/12/29 03:30:22 [DEBUG] Validate ID
2017/12/29 03:30:22 [DEBUG] An affiliation is required for identity type user
2017/12/29 03:30:22 [DEBUG] Validating affiliation: org1.department1
2017/12/29 03:30:22 [DEBUG] DB: Get affiliation org1.department1
2017/12/29 03:30:22 [DEBUG] Validating that registrar &#39;admin&#39; with the following value for hf.Registrar.Attributes &#39;*&#39; is authorized to register the requested attributes &#39;[]&#39;
2017/12/29 03:30:22 [DEBUG] Registering user id: user1
2017/12/29 03:30:22 [DEBUG] Max enrollment value verification - User specified max enrollment: 1, CA max enrollment: -1
2017/12/29 03:30:22 [DEBUG] DB: Getting identity user1
2017/12/29 03:30:22 [DEBUG] DB: Add identity user1
2017/12/29 03:30:22 [DEBUG] Successfully added identity user1 to the database
2017/12/29 03:30:22 [INFO] 172.18.0.1:47458 POST /api/v1/register 200 0 &#34;OK&#34;
2017/12/29 03:30:23 [DEBUG] Received request for /api/v1/enroll
2017/12/29 03:30:23 [DEBUG] ca.Config: &amp;{CA:{Name:ca.example.com Keyfile:/etc/hyperledger/fabric-ca-server-config/4239aa0dcd76daeeb8ba0cda701851d14504d31aad1b2ddddbac6a57365e497c_sk Certfile:/etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem Chainfile:/etc/hyperledger/fabric-ca-server/ca-chain.pem} Signing:0xc42028df00 CSR:{CN:ca.org1.example.com Names:[{C:US ST:North Carolina L: O:Hyperledger OU:Fabric SerialNumber:}] Hosts:[d6b7bc3da088 localhost] KeyRequest:&lt;nil&gt; CA:0xc420291620 SerialNumber:} Registry:{MaxEnrollments:-1 Identities:[{ Name:**** Pass:**** Type:client Affiliation: MaxEnrollments:-1 Attrs:map[hf.Registrar.Attributes:* hf.Registrar.Roles:client,user,peer,validator,auditor hf.Registrar.DelegateRoles:client,user,validator,auditor hf.Revoker:1 hf.IntermediateCA:1 hf.GenCRL:1]  }]} Affiliations:map[org2:[department1] org1:[department1 department2]] LDAP:{ Enabled:false URL:ldap://****:****@&lt;host&gt;:&lt;port&gt;/&lt;base&gt; UserFilter:(uid=%s) GroupFilter:(memberUid=%s) TLS:{false [/etc/hyperledger/fabric-ca-server/ldap-server-cert.pem] {/etc/hyperledger/fabric-ca-server/ldap-client-key.pem /etc/hyperledger/fabric-ca-server/ldap-client-cert.pem}}  } DB:{ Type:sqlite3 Datasource:/etc/hyperledger/fabric-ca-server/fabric-ca-server.db TLS:{false [/etc/hyperledger/fabric-ca-server/db-server-cert.pem] {/etc/hyperledger/fabric-ca-server/db-client-key.pem /etc/hyperledger/fabric-ca-server/db-client-cert.pem}}  } CSP:0xc4202918a0 Client:&lt;nil&gt; Intermediate:{ParentServer:{ URL: CAName:  } TLS:{Enabled:false CertFiles:[] Client:{KeyFile: CertFile:}} Enrollment:{ Name: Secret:**** Profile: Label: CSR:&lt;nil&gt; CAName: AttrReqs:[]  }} CRL:{Expiry:24h0m0s}}
2017/12/29 03:30:23 [DEBUG] DB: Getting identity user1
2017/12/29 03:30:23 [DEBUG] DB: Login user user1 with max enrollments of 1 and state of 0
2017/12/29 03:30:23 [DEBUG] Max enrollment value (1) of identity is greater than allowed by CA, using CA max enrollment value of -1
2017/12/29 03:30:23 [DEBUG] DB: identity user1 successfully logged in
2017/12/29 03:30:23 [DEBUG] csrAuthCheck: id=user1, CommonName=user1, Subject=&lt;nil&gt;
2017/12/29 03:30:23 [DEBUG] CSR authorization check passed
2017/12/29 03:30:23 [DEBUG] Checking CSR fields to make sure that they do not exceed maximum character limits
2017/12/29 03:30:23 [DEBUG] DB: Getting information for identity user1
2017/12/29 03:30:23 [INFO] signed certificate with serial number 185255935578020512862318647850015851996183155613
2017/12/29 03:30:23 [DEBUG] DB: Insert Certificate
2017/12/29 03:30:23 [DEBUG] Saved serial number as hex 207329d852163d4aba3ec5ec86e23a1117e2539d
2017/12/29 03:30:23 [DEBUG] saved certificate with serial number 185255935578020512862318647850015851996183155613
2017/12/29 03:30:23 [DEBUG] Successfully incremented state for identity user1 to 1
2017/12/29 03:30:23 [INFO] 172.18.0.1:47462 POST /api/v1/enroll 200 0 &#34;OK&#34;
</pre>
<h4>3) 查询账本</h4>

<p>查询是如何从分类帐中读取数据的。 这些数据以一系列键/值对的形式存储，您可以查询单个键，多个键的值，或者 - 如果分类帐以像JSON这样的丰富数据存储格式写入，则对其进行复杂的搜索 查找包含特定关键字的所有资产）。</p>
<pre class="chroma"><span class="c1"># 首先，运行我们的query.js程序返回账本上所有汽车的清单</span>
<span class="c1"># 核心语句是fabric_client.getUserContext(&#39;user1&#39;, true)</span>
node query.js
Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully loaded user1 from persistence
Query has completed, checking results
Response is  <span class="o">[</span><span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR0&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;blue&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Toyota&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Prius&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Tomoko&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR1&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;red&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Ford&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Mustang&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Brad&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR2&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;green&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Hyundai&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Tucson&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Jin Soo&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR3&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;yellow&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Volkswagen&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Passat&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Max&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR4&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;black&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Tesla&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;S&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Adriana&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR5&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;purple&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Peugeot&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;205&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Michel&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR6&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;white&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Chery&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;S22L&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Aarav&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR7&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;violet&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Fiat&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Punto&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Pari&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR8&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;indigo&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Tata&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Nano&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Valeria&#34;</span><span class="o">}</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;Key&#34;</span>:<span class="s2">&#34;CAR9&#34;</span>, <span class="s2">&#34;Record&#34;</span>:<span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;brown&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Holden&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Barina&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Shotaro&#34;</span><span class="o">}</span><span class="o">}</span><span class="o">]</span>
</pre>
<blockquote>
<p>传入的参数是user1，使用这个账户去查询。<br />
账本是基于key/value的，在我们的实例中，key是CAR0到CAR9</p>
</blockquote>

<p><strong>让我们详细深入分析一下<code>query.js</code></strong><br />
初始化部分，定义了一些变量，例如channel名称，cert储存位置和peer的网络地址。此例中，我们把变量及内容都写死了，实际app中，需要进行部分调整。</p>
<pre class="chroma"><span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">fabric_client</span><span class="p">.</span><span class="nx">newChannel</span><span class="p">(</span><span class="s1">&#39;mychannel&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">peer</span> <span class="o">=</span> <span class="nx">fabric_client</span><span class="p">.</span><span class="nx">newPeer</span><span class="p">(</span><span class="s1">&#39;grpc://localhost:7051&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="nx">channel</span><span class="p">.</span><span class="nx">addPeer</span><span class="p">(</span><span class="nx">peer</span><span class="p">)</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">member_user</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">store_path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;hfc-key-store&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Store path:&#39;</span><span class="o">+</span><span class="nx">store_path</span><span class="p">)</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">tx_id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</pre>
<p>接下来的一部分是构建查询部分的语句</p>
<pre class="chroma"><span class="c1">// queryCar chaincode function - requires 1 argument, ex: args: [&#39;CAR4&#39;],
</span><span class="c1"></span><span class="c1">// queryAllCars chaincode function - requires no arguments , ex: args: [&#39;&#39;],
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">//targets : --- letting this default to the peers assigned to the channel
</span><span class="c1"></span>  <span class="nx">chaincodeId</span><span class="o">:</span> <span class="s1">&#39;fabcar&#39;</span><span class="p">,</span>
  <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;queryAllCars&#39;</span><span class="p">,</span>
  <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
<span class="p">}</span><span class="p">;</span>
</pre>
<p>这里指定了chaincodeId和functionName，当app运行时，会调用chaincode（fabcar）来执行queryAllCars函数，此处没有传输args。</p>

<p>chaincode代码在<code>fabric-samples/chaincode/fabcar/go/fabcar.go</code>中</p>
<pre class="chroma"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">SmartContract</span><span class="p">)</span> <span class="nf">queryAllCars</span><span class="p">(</span><span class="nx">APIstub</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">ChaincodeStubInterface</span><span class="p">)</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>

	<span class="nx">startKey</span> <span class="o">:=</span> <span class="s">&#34;CAR0&#34;</span>
	<span class="nx">endKey</span> <span class="o">:=</span> <span class="s">&#34;CAR999&#34;</span>

	<span class="nx">resultsIterator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">APIstub</span><span class="p">.</span><span class="nf">GetStateByRange</span><span class="p">(</span><span class="nx">startKey</span><span class="p">,</span> <span class="nx">endKey</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">resultsIterator</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>

	<span class="c1">// buffer is a JSON array containing QueryResults
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">buffer</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;[&#34;</span><span class="p">)</span>

	<span class="nx">bArrayMemberAlreadyWritten</span> <span class="o">:=</span> <span class="kc">false</span>
	<span class="k">for</span> <span class="nx">resultsIterator</span><span class="p">.</span><span class="nf">HasNext</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">queryResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resultsIterator</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c1">// Add a comma before array members, suppress it for the first array member
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">bArrayMemberAlreadyWritten</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
			<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;{\&#34;Key\&#34;:&#34;</span><span class="p">)</span>
		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;\&#34;&#34;</span><span class="p">)</span>
		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">queryResponse</span><span class="p">.</span><span class="nx">Key</span><span class="p">)</span>
		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;\&#34;&#34;</span><span class="p">)</span>

		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;, \&#34;Record\&#34;:&#34;</span><span class="p">)</span>
		<span class="c1">// Record is a JSON object, so we write as-is
</span><span class="c1"></span>		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">queryResponse</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span><span class="p">)</span>
		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;}&#34;</span><span class="p">)</span>
		<span class="nx">bArrayMemberAlreadyWritten</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}</span>
	<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;]&#34;</span><span class="p">)</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;- queryAllCars:\n%s\n&#34;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">Success</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</pre>
<blockquote>
<p>在chaincode源码中，我们有以下几个接口api，<code>initLedger</code>, <code>queryCar</code>, <code>queryAllCars</code>, <code>createCar</code>, and <code>changeCarOwner</code></p>
</blockquote>

<p><strong>带参数查询</strong><br />
复制query.js为queryCar.js，将queryAllCars改成queryCar，参数改为“CAR4”</p>
<pre class="chroma"><span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">//targets : --- letting this default to the peers assigned to the channel
</span><span class="c1"></span>        <span class="nx">chaincodeId</span><span class="o">:</span> <span class="s1">&#39;fabcar&#39;</span><span class="p">,</span>
        <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;queryCar&#39;</span><span class="p">,</span>
        <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CAR4&#39;</span><span class="p">]</span>
<span class="p">}</span><span class="p">;</span>
</pre>
<p>执行queryCar.js来查询“CAR4”</p>
<pre class="chroma">node queryCar.js
Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully loaded user1 from persistence
Query has completed, checking results
Response is  <span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;black&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Tesla&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;S&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Adriana&#34;</span><span class="o">}</span>
</pre>
<h4>4) 更新账本</h4>

<p>更新账本的流程：客户端发起交易给endorse节点 - endorse节点模拟执行交易对其背书并发回给客户端 - 客户端将背书后的交易请求发送给order节点 - order节点对交易请求排序发给commit节点对账本进行写入 - commit节点检查交易请求是否合法，合法则写入账本。</p>

<p>我们使用<code>invoke.js</code>来发起更新请求。发起请求部分的代码如下</p>
<pre class="chroma"><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">//targets: let default to the peer assigned to the client
</span><span class="c1"></span>        <span class="nx">chaincodeId</span><span class="o">:</span> <span class="s1">&#39;fabcar&#39;</span><span class="p">,</span>
        <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="p">,</span>
        <span class="nx">chainId</span><span class="o">:</span> <span class="s1">&#39;mychannel&#39;</span><span class="p">,</span>
        <span class="nx">txId</span><span class="o">:</span> <span class="nx">tx_id</span>
<span class="p">}</span><span class="p">;</span>
</pre>
<p><strong>增加CAR10</strong><br />
我们需要手动补充fcn和args</p>
<pre class="chroma"><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">//targets: let default to the peer assigned to the client
</span><span class="c1"></span>  <span class="nx">chaincodeId</span><span class="o">:</span> <span class="s1">&#39;fabcar&#39;</span><span class="p">,</span>
  <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;createCar&#39;</span><span class="p">,</span>
  <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CAR10&#39;</span><span class="p">,</span> <span class="s1">&#39;Chevy&#39;</span><span class="p">,</span> <span class="s1">&#39;Volt&#39;</span><span class="p">,</span> <span class="s1">&#39;Red&#39;</span><span class="p">,</span> <span class="s1">&#39;Nick&#39;</span><span class="p">]</span><span class="p">,</span>
  <span class="nx">chainId</span><span class="o">:</span> <span class="s1">&#39;mychannel&#39;</span><span class="p">,</span>
  <span class="nx">txId</span><span class="o">:</span> <span class="nx">tx_id</span>
<span class="p">}</span><span class="p">;</span>
</pre>
<p>执行并查询结果</p>
<pre class="chroma">node invoke.js
Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully loaded user1 from persistence
Assigning transaction_id:  1d099f203b819c03aaf21e86d67b1049de05b6bc3a1a1dad7bf1da8a2e225d34
Transaction proposal was good
Successfully sent Proposal and received ProposalResponse: Status - 200, message - <span class="s2">&#34;OK&#34;</span>
info: <span class="o">[</span>EventHub.js<span class="o">]</span>: _connect - options <span class="o">{</span><span class="s2">&#34;grpc.max_receive_message_length&#34;</span>:-1,<span class="s2">&#34;grpc.max_send_message_length&#34;</span>:-1<span class="o">}</span>
The transaction has been committed on peer localhost:7053
Send transaction promise and event listener promise have completed
Successfully sent transaction to the orderer.
Successfully committed the change to the ledger by the peer

<span class="c1"># 把queryCar.js中的CAR4改成CAR10</span>
node queryCar.js
Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully loaded user1 from persistence
Query has completed, checking results
Response is  <span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;Red&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Chevy&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Volt&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Nick&#34;</span><span class="o">}</span>
</pre>
<p><strong>修改owner</strong><br />
修改CAR10的owner为Dave</p>
<pre class="chroma"><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">//targets: let default to the peer assigned to the client
</span><span class="c1"></span>  <span class="nx">chaincodeId</span><span class="o">:</span> <span class="s1">&#39;fabcar&#39;</span><span class="p">,</span>
  <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;changeCarOwner&#39;</span><span class="p">,</span>
  <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CAR10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dave&#39;</span><span class="p">]</span><span class="p">,</span>
  <span class="nx">chainId</span><span class="o">:</span> <span class="s1">&#39;mychannel&#39;</span><span class="p">,</span>
  <span class="nx">txId</span><span class="o">:</span> <span class="nx">tx_id</span>
<span class="p">}</span><span class="p">;</span>
</pre>
<p>执行更新，并查询结构</p>
<pre class="chroma"><span class="c1"># 执行更改</span>
node invoke.js
Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully loaded user1 from persistence
Assigning transaction_id:  eedcb8a401ffabc32a56e2f836a8821a5280c127d82c3d9f8d6cfb217ac8431c
Transaction proposal was good
Successfully sent Proposal and received ProposalResponse: Status - 200, message - <span class="s2">&#34;OK&#34;</span>
info: <span class="o">[</span>EventHub.js<span class="o">]</span>: _connect - options <span class="o">{</span><span class="s2">&#34;grpc.max_receive_message_length&#34;</span>:-1,<span class="s2">&#34;grpc.max_send_message_length&#34;</span>:-1<span class="o">}</span>
The transaction has been committed on peer localhost:7053
Send transaction promise and event listener promise have completed
Successfully sent transaction to the orderer.
Successfully committed the change to the ledger by the peer

<span class="c1"># 查询结果</span>
node queryCar.js
Store path:/root/fabric-samples/fabcar/hfc-key-store
Successfully loaded user1 from persistence
Query has completed, checking results
Response is  <span class="o">{</span><span class="s2">&#34;colour&#34;</span>:<span class="s2">&#34;Red&#34;</span>,<span class="s2">&#34;make&#34;</span>:<span class="s2">&#34;Chevy&#34;</span>,<span class="s2">&#34;model&#34;</span>:<span class="s2">&#34;Volt&#34;</span>,<span class="s2">&#34;owner&#34;</span>:<span class="s2">&#34;Dave&#34;</span><span class="o">}</span>
</pre>
    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>