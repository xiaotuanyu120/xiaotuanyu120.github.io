<!DOCTYPE html>
<html lang="zh-cmn">

<head>
    <title>XTY Blog | Linux Ops Docs | SRE | DEVOPS</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link rel="stylesheet" href="/static/css/chroma.css">
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<div class="blog-title">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div>
					<a class="main-title" href="/">XTY的小站</a>
                </div>
                <div>
                    <a class="small-title" href="/">记录技术笔记和技术博客</a>
                </div>
			</div>
		</div>
	</div>
</div>

<body>
  <div class="container">

    <div class="col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1">
	  <div id="sidebar">

		<h3>最新文章</h3>
          <ul>

            <li>
              <a href="/linux/advance/network_tcp-reset.html">网络: TCP - RST简介</a>
            </li>
            <li>
              <a href="/linux/shell/shell_1.0.4_variable_string.html">SHELL: 1.0.4 变量：字符串及字符串切片</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.4_start_init.html">GO 1.1.4 入口函数和包初始化</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.3_build.html">GO 1.1.3 构建应用</a>
            </li>
            <li>
              <a href="/go/go/go_1.1.2_proj_struct.html">GO 1.1.2 目录结构</a>
            </li>
          </ul>

		<h3>文章分类</h3>
		  <ul>

            <li>
              <a href="/android/index.html">android</a>
            </li>
            <li>
              <a href="/bigdata/index.html">bigdata</a>
              <ul>
                <li>
                  <a href="/bigdata/cloudera/index.html">cloudera</a>
                </li>
                <li>
                  <a href="/bigdata/elk/index.html">elk</a>
                  <ul>
                    <li><a href="/bigdata/elk/elasticsearch_1.1.0_docker_installation.html">elasticsearch 1.1.0: docker installation</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.0_elasticsearch_concept.html">elk 1.0.0: elasticsearch concept</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.1_elasticsearch_removal_of_mapping_types.html">elk 1.0.1: elasticsearch removal of mapping types</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.2_after_installation_explore_your_cluster.html">elk 1.10.2: explore you cluster</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.3_after_installation_modify_your_data.html">elk 1.0.3: modify your data</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.4_after_installation_explore_your_data.html">elk 1.0.4: explore your data</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.5_elasticsearch_index_templates.html">elk 1.0.5: elasticsearch index templates</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.6_elasticsearch_mapping.html">elk 1.0.6: elasticsearch mapping</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.7.a_elasticsearch_cluster_api_cluster_setting.html">elk 1.0.7.a: elasticsearch cluster api - cluster setting</a></li>
                    <li><a href="/bigdata/elk/elk_1.0.8.a_elasticsearch_modules_snapshot_and_restore.html">elk 1.0.8.a: elasticsearch modules - snapshot and restore</a></li>
                    <li><a href="/bigdata/elk/elk_1.1.0_production_installation.html">elk 1.1.0: production installation</a></li>
                    <li><a href="/bigdata/elk/elk_1.1.1_production_installation_add_xpack.html">elk 1.1.1: production installation add xpack</a></li>
                    <li><a href="/bigdata/elk/elk_1.2.0_elasticsearch_upgrade_from_6.2.4_to_6.4.2.html">elk 1.2.0: elasticsearch upgrade from 6.2.4 to 6.4.2</a></li>
                    <li><a href="/bigdata/elk/elk_2.1.0_conf_logstash_index_name_date.html">elk 2.1.0 logstash config index name with current date</a></li>
                    <li><a href="/bigdata/elk/elk_2.2.0_conf_filebeat_logstash_kafka.html">elk 2.2.0 config kafka with filebeat and logstash</a></li>
                    <li><a href="/bigdata/elk/elk_2.2.1_error_filebeat_kafka_waiting_for_space.html">elk 2.2.1 config kafka with filebeat and logstash</a></li>
                    <li><a href="/bigdata/elk/elk_3.1.0_logstash_plugin_grok.html">elk 3.1.0 logstash plugin grok</a></li>
                    <li><a href="/bigdata/elk/elk_3.2.0_logstash_plugin_geoip_and_kibana_visualize.html">elk 3.2.0 logstash plugin geoip and kibana visualize</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <a href="/blockchain/index.html">blockchain</a>
            </li>
            <li>
              <a href="/blog/index.html">blog</a>
            </li>
            <li>
              <a href="/cloud/index.html">cloud</a>
            </li>
            <li>
              <a href="/cryptography/index.html">cryptography</a>
            </li>
            <li>
              <a href="/database/index.html">database</a>
            </li>
            <li>
              <a href="/devops/index.html">devops</a>
            </li>
            <li>
              <a href="/go/index.html">go</a>
            </li>
            <li>
              <a href="/ios/index.html">ios</a>
            </li>
            <li>
              <a href="/java/index.html">java</a>
            </li>
            <li>
              <a href="/linux/index.html">linux</a>
            </li>
            <li>
              <a href="/python/index.html">python</a>
            </li>
            <li>
              <a href="/service/index.html">service</a>
            </li>
            <li>
              <a href="/virtualization/index.html">virtualization</a>
            </li>
            <li>
              <a href="/web/index.html">web</a>
            </li>
          </ul>

      </div>
    </div>

    <div class="col-lg-7 col-md-7 col-sm-7">
      <h2>elk 1.0.4: explore your data</h2>
      <div>
        <hr style="border: 0; border-top: 1px dashed #a2a9b6">
      </div>
      <div class="postDate">
        <p>17 Oct 2018</p>
      </div>
      <div>
        <hr style="border: 0; border-bottom: 1px dashed #a2a9b6">
      </div>
<h2>Exploring Your Data</h2>

<h3>1. prepare data</h3>

<h4>Sample Dataset</h4>

<p>我们已经对基础有了一定的了解，现在我们尝试在更加真实的场景下来研究。这里我会准备一组虚拟的银行账户信息。每一条都类似于这样：</p>
<pre class="chroma"><span class="p">{</span>
    <span class="nt">&#34;account_number&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;balance&#34;</span><span class="p">:</span> <span class="mi">16623</span><span class="p">,</span>
    <span class="nt">&#34;firstname&#34;</span><span class="p">:</span> <span class="s2">&#34;Bradshaw&#34;</span><span class="p">,</span>
    <span class="nt">&#34;lastname&#34;</span><span class="p">:</span> <span class="s2">&#34;Mckenzie&#34;</span><span class="p">,</span>
    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
    <span class="nt">&#34;gender&#34;</span><span class="p">:</span> <span class="s2">&#34;F&#34;</span><span class="p">,</span>
    <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;244 Columbus Place&#34;</span><span class="p">,</span>
    <span class="nt">&#34;employer&#34;</span><span class="p">:</span> <span class="s2">&#34;Euron&#34;</span><span class="p">,</span>
    <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;bradshawmckenzie@euron.com&#34;</span><span class="p">,</span>
    <span class="nt">&#34;city&#34;</span><span class="p">:</span> <span class="s2">&#34;Hobucken&#34;</span><span class="p">,</span>
    <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="s2">&#34;CO&#34;</span>
<span class="p">}</span>
</pre>
<p>这些数据都是从 www.json-generator.com 生成的，所以请忽略其实际值。</p>

<h4>Loading the Sample Dataset</h4>

<p>你可以从<a href="https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json?raw=true">这里</a>下载到测试用的数据集。把文件放在当前目录，然后用下面的命令来导入它到elasticsearch集群中：</p>
<pre class="chroma">curl -H <span class="s2">&#34;Content-Type: application/json&#34;</span> -XPOST <span class="s2">&#34;localhost:9200/bank/_doc/_bulk?pretty&amp;refresh&#34;</span> --data-binary <span class="s2">&#34;@accounts.json&#34;</span>
curl <span class="s2">&#34;localhost:9200/_cat/indices?v&#34;</span>
</pre>
<p>返回结果是</p>
<pre class="chroma">health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   bank  l7sSYV2cQXmu6_4rJWVIww   5   1       1000            0    128.6kb        128.6kb
</pre>
<p>这意味着我们只是成功地将1000个文档批量索引到银行索引（在_doc类型下）。</p>

<h3>2. The Search API</h3>

<p>现在让我们从一些简单的搜索开始吧。运行搜索有两种基本方法：一种是通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/search-uri-request.html">REST请求URI</a>发送搜索参数，另一种是通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/search-request-body.html">REST请求体</a>发送搜索参数。请求体方法允许您更具表现力，并以更易读的JSON格式定义搜索。我们将尝试一个请求URI方法的示例，但是对于本教程的其余部分，我们将专门使用请求体方法。</p>

<p>可以从_search端点访问用于搜索的REST API。此示例返回银行索引中的所有文档：</p>
<pre class="chroma">GET /bank/_search?q=*&amp;sort=account_number:asc&amp;pretty
</pre>
<ul>
<li><code>/bank/_search</code>，在bank索引上执行搜索API</li>
<li><code>q=*</code>，匹配所有的在bank索引中的文档</li>
<li><code>sort=account_number:asc</code>，使用account_number排序，采用升序排序。</li>
<li><code>pretty</code>，只是告诉Elasticsearch返回漂亮的JSON结果。</li>
</ul>

<p>部分返回结果为：</p>
<pre class="chroma"><span class="p">{</span>
  <span class="nt">&#34;took&#34;</span> <span class="p">:</span> <span class="mi">63</span><span class="p">,</span>
  <span class="nt">&#34;timed_out&#34;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&#34;skipped&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span><span class="p">,</span>
  <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="nt">&#34;max_score&#34;</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
      <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;bank&#34;</span><span class="p">,</span>
      <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
      <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
      <span class="nt">&#34;sort&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">,</span>
      <span class="nt">&#34;_score&#34;</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span><span class="nt">&#34;account_number&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&#34;balance&#34;</span><span class="p">:</span><span class="mi">16623</span><span class="p">,</span><span class="nt">&#34;firstname&#34;</span><span class="p">:</span><span class="s2">&#34;Bradshaw&#34;</span><span class="p">,</span><span class="nt">&#34;lastname&#34;</span><span class="p">:</span><span class="s2">&#34;Mckenzie&#34;</span><span class="p">,</span><span class="nt">&#34;age&#34;</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span><span class="nt">&#34;gender&#34;</span><span class="p">:</span><span class="s2">&#34;F&#34;</span><span class="p">,</span><span class="nt">&#34;address&#34;</span><span class="p">:</span><span class="s2">&#34;244 Columbus Place&#34;</span><span class="p">,</span><span class="nt">&#34;employer&#34;</span><span class="p">:</span><span class="s2">&#34;Euron&#34;</span><span class="p">,</span><span class="nt">&#34;email&#34;</span><span class="p">:</span><span class="s2">&#34;bradshawmckenzie@euron.com&#34;</span><span class="p">,</span><span class="nt">&#34;city&#34;</span><span class="p">:</span><span class="s2">&#34;Hobucken&#34;</span><span class="p">,</span><span class="nt">&#34;state&#34;</span><span class="p">:</span><span class="s2">&#34;CO&#34;</span><span class="p">}</span>
    <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
      <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;bank&#34;</span><span class="p">,</span>
      <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
      <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
      <span class="nt">&#34;sort&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="p">,</span>
      <span class="nt">&#34;_score&#34;</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span><span class="nt">&#34;account_number&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&#34;balance&#34;</span><span class="p">:</span><span class="mi">39225</span><span class="p">,</span><span class="nt">&#34;firstname&#34;</span><span class="p">:</span><span class="s2">&#34;Amber&#34;</span><span class="p">,</span><span class="nt">&#34;lastname&#34;</span><span class="p">:</span><span class="s2">&#34;Duke&#34;</span><span class="p">,</span><span class="nt">&#34;age&#34;</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nt">&#34;gender&#34;</span><span class="p">:</span><span class="s2">&#34;M&#34;</span><span class="p">,</span><span class="nt">&#34;address&#34;</span><span class="p">:</span><span class="s2">&#34;880 Holmes Lane&#34;</span><span class="p">,</span><span class="nt">&#34;employer&#34;</span><span class="p">:</span><span class="s2">&#34;Pyrami&#34;</span><span class="p">,</span><span class="nt">&#34;email&#34;</span><span class="p">:</span><span class="s2">&#34;amberduke@pyrami.com&#34;</span><span class="p">,</span><span class="nt">&#34;city&#34;</span><span class="p">:</span><span class="s2">&#34;Brogan&#34;</span><span class="p">,</span><span class="nt">&#34;state&#34;</span><span class="p">:</span><span class="s2">&#34;IL&#34;</span><span class="p">}</span>
    <span class="p">}</span><span class="p">,</span> <span class="err">.</span><span class="err">.</span><span class="err">.</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>返回结果中，我们看到了如下部分：</p>

<ul>
<li><code>took</code> - Elasticsearch执行搜索的时间（以毫秒为单位）</li>
<li><code>timed_out</code> - 告诉我们搜索是否超时</li>
<li><code>_shards</code> - 告诉我们搜索了多少个分片，以及搜索成功/失败分片的计数</li>
<li><code>hits</code> - 搜索结果</li>
<li><code>hits.total</code> - 符合我们搜索条件的文档总数</li>
<li><code>hits.hits</code> - 实际的搜索结果数组（默认为前10个文档）</li>
<li><code>hits.sort</code> - 搜索结果排序的key（如果是按照score排序，则missing）</li>
<li><code>hits._score and max_score</code> - 目前不需要关注字段含义</li>
</ul>

<p>下面的操作效果和上面一样，只不过使用的是请求体方式：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match_all&#34;: {} },
  &#34;sort&#34;: [
    { &#34;account_number&#34;: &#34;asc&#34; }
  ]
}
</pre>
<p>重要的是要理解，一旦您获得了搜索结果，Elasticsearch就完全完成了请求，并且不会在结果中维护任何类型的服务器端资源或打开游标。这与SQL等许多其他平台形成鲜明对比，在其中您可能最初预先获得查询结果的部分子集，然后如果要获取（或翻页）其余的结果则必须连续返回到服务器端，这是使用某种有状态服务器端游标的结果。</p>

<h3>3. Introducing the Query Language</h3>

<p>Elasticsearch提供了一种JSON样式的特定于域的语言，可用于执行查询。这被称为<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/query-dsl.html">查询DSL</a>。</p>

<p>查询bank索引所有的文档</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match_all&#34;: {} }
}
</pre>
<p>query告诉我们这里是匹配结果的定义语句，match_all是告诉我们实际查询的语句。</p>

<p>除了query之外，我们还可以增加其他的参数来影响搜索的结果。之前我们使用了sort参数，这里我们尝试使用size参数：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match_all&#34;: {} },
  &#34;size&#34;: 1
}
</pre>
<p>size影响的是查询结果中返回的数组结果，如果不指定size的值，默认是10。</p>

<p>下面的例子返回查询结果中序号10-19</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match_all&#34;: {} },
  &#34;from&#34;: 10,
  &#34;size&#34;: 10
}
</pre>
<p>from的作用很明显，是指定结果数组中起始的index值，如果没有指定from，默认是0。</p>

<p>下面的例子是使用balance来降序排序：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match_all&#34;: {} },
  &#34;sort&#34;: { &#34;balance&#34;: { &#34;order&#34;: &#34;desc&#34; } }
}
</pre>
<h3>4. Executing Searches</h3>

<p>现在我们已经了解了一些基本的搜索参数，让我们继续了解查询DSL的更多吧。首先，让我们看一下返回结果中的字段。默认情况下，会在查询结果中返回完整的json格式的文档。这被称之为源（命中结果中的<code>_source</code>字段）。如果我们不希望返回整个源文档，我们可以选择只返回源的部分字段。</p>

<p>下面的例子展示了如何在搜索结果中只返回两个字段，account_number和balance:</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match_all&#34;: {} },
  &#34;_source&#34;: [&#34;account_number&#34;, &#34;balance&#34;]
}
</pre>
<p>在上面的例子中，我们只是简单的减少了_source参数的内容。它依然会返回_source，只是其中的内容仅包含account_number和balance。</p>

<p>如果你是从SQL世界中来，那么上面的请求类似于<code>select from</code>语句。</p>

<p>okay，现在让我们来看看查询部分。之前，我们已经看过了如何是用match_all来匹配索引中所有的文档了。现在让我们看一个新的参数<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/query-dsl-match-query.html">match</a>，这个参数可以认为可以进行一个基本的字段查询（根据一个或者一组字段来查询）。</p>

<p>下面这个例子返回account number为20的账户：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match&#34;: { &#34;account_number&#34;: 20 } }
}
</pre>
<p>下面这个例子返回地址中包含mill的账户：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match&#34;: { &#34;address&#34;: &#34;mill&#34; } }
}
</pre>
<p>下面这个例子返回地址中包含mill或者lane的账户：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match&#34;: { &#34;address&#34;: &#34;mill lane&#34; } }
}
</pre>
<p>下面这个例子使用了match的一个变种match_phrase，它会返回所有地址匹配“mill lane”的账户：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: { &#34;match_phrase&#34;: { &#34;address&#34;: &#34;mill lane&#34; } }
}
</pre>
<p>现在我们来聊聊<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/query-dsl-bool-query.html">bool查询</a>。bool查询允许我们使用布尔逻辑将较小的查询组成更大的查询。</p>

<p>下面这个例子中，组合了两个小查询成为一个大查询，查询结果中地址必须同时包含mill和lane：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must&#34;: [
        { &#34;match&#34;: { &#34;address&#34;: &#34;mill&#34; } },
        { &#34;match&#34;: { &#34;address&#34;: &#34;lane&#34; } }
      ]
    }
  }
}
</pre>
<p>在上面的示例中，bool must子句指定所有必须为true的查询才能将文档视为匹配项。</p>

<p>作为对比，下面这个例子中，查询结果中地址只要包含mill或lane其中一个即可：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;should&#34;: [
        { &#34;match&#34;: { &#34;address&#34;: &#34;mill&#34; } },
        { &#34;match&#34;: { &#34;address&#34;: &#34;lane&#34; } }
      ]
    }
  }
}
</pre>
<p>在上面的示例中，bool should字句指定查询中至少有一个为true才能将文档视为匹配项。</p>

<p>下面这个例子中，查询结果中地址既不可能包含mill也不能包含lane：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must_not&#34;: [
        { &#34;match&#34;: { &#34;address&#34;: &#34;mill&#34; } },
        { &#34;match&#34;: { &#34;address&#34;: &#34;lane&#34; } }
      ]
    }
  }
}
</pre>
<p>在上面的示例中，bool should字句指定查询中至少有一个为true才能将文档视为匹配项。</p>

<p>我们可以在bool查询中同时组合must，should和must_not子句。此外，我们可以在任何这些bool子句中组合bool查询来模仿任何复杂的多级布尔逻辑。</p>

<p>下面这个例子中，返回任何40岁但不住在ID（aho）的人的所有帐户：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must&#34;: [
        { &#34;match&#34;: { &#34;age&#34;: &#34;40&#34; } }
      ],
      &#34;must_not&#34;: [
        { &#34;match&#34;: { &#34;state&#34;: &#34;ID&#34; } }
      ]
    }
  }
}
</pre>
<h3>5. Executing Filters</h3>

<p>在前面，我们跳过了一个小细节，叫做文档score(搜索结果中的<code>_score</code>字段)。socre是一个数值，它是文档与我们指定的搜索查询条件匹配程度的相对值。分值越高，说明和搜索条件契合度越高，反之就是契合度越低。</p>

<p>但是查询并不总是需要产生分数，特别是当它们仅用于“过滤”文档集时。Elasticsearch会检测这些情况并自动优化查询执行，以便不计算无用的分数。</p>

<p>我们在前面中介绍的bool查询还支持过滤子句，这些子句可以来限制其他子句搜索匹配的文档，而不会更改计算得分的方式。举例子之前，让我们介绍<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/query-dsl-range-query.html">range查询</a>，它允许我们按一系列值过滤文档。这通常用于数字或日期过滤。</p>

<p>下面这个例子，我们使用bool查询到所有balance在20000-30000之间的账户：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must&#34;: { &#34;match_all&#34;: {} },
      &#34;filter&#34;: {
        &#34;range&#34;: {
          &#34;balance&#34;: {
            &#34;gte&#34;: 20000,
            &#34;lte&#34;: 30000
          }
        }
      }
    }
  }
}
</pre>
<p>上面的查询中，match_all是查询部分，range是filter部分。我们可以使用其他任何查询API来替换上面的查询部分和过滤部分。</p>

<p>除了match_all，match，bool和range查询之外，还有很多其他可用的查询类型，我们不会在这里讨论它们。由于我们已经基本了解它们的工作原理，因此将这些知识应用于学习和试验其他查询类型应该不会太困难。</p>

<h3>6. Executing Aggregations</h3>

<p>聚合提供了从数据中分组和提取统计信息的功能。理解聚合的最简单方法是将其大致等同于SQL GROUP BY和SQL聚合函数。在elasticsearch中，你可以执行返回命中结果的搜索，同时在同一个响应中返回单独的聚合信息。这是非常强大和高效的，通过使用简洁的API，你可以同时执行一个查询和多个聚合操作，然后一次性得到所有(或任一)结果，而避免了更多的网络开销。</p>

<p>首先，下面这个例子，使用state来分组所有账户，然后按照count的减序（默认减序）返回前十个（默认10个）state:</p>
<pre class="chroma">GET /bank/_search
{
  &#34;size&#34;: 0,
  &#34;aggs&#34;: {
    &#34;group_by_state&#34;: {
      &#34;terms&#34;: {
        &#34;field&#34;: &#34;state.keyword&#34;
      }
    }
  }
}
</pre>
<p>在SQL中，上述聚合在概念上类似于：</p>
<pre class="chroma"><span class="k">SELECT</span> <span class="k">state</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">bank</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">state</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre>
<p>返回结果是</p>
<pre class="chroma"><span class="p">{</span>
  <span class="nt">&#34;took&#34;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
  <span class="nt">&#34;timed_out&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&#34;skipped&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span><span class="p">,</span>
  <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="nt">&#34;max_score&#34;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
  <span class="p">}</span><span class="p">,</span>
  <span class="nt">&#34;aggregations&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;group_by_state&#34;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;doc_count_error_upper_bound&#34;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="nt">&#34;sum_other_doc_count&#34;</span><span class="p">:</span> <span class="mi">770</span><span class="p">,</span>
      <span class="nt">&#34;buckets&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;ID&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">27</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;TX&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">27</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;AL&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">25</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;MD&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">25</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;TN&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">23</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;MA&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">21</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;NC&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">21</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;ND&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">21</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;ME&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">20</span>
      <span class="p">}</span><span class="p">,</span> <span class="p">{</span>
        <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;MO&#34;</span><span class="p">,</span>
        <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">20</span>
      <span class="p">}</span> <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>我们可以看到，在ID生活的account有27个，TX的有27个&hellip;依次往下类推。</p>

<p>值得注意的是我们设定了size为0，是因为我们仅仅希望在响应中看到聚合的结果。</p>

<p>在前面聚合的基础上，这个例子根据state分组来计算了账户的balance平均值（同样仅针对按count降序排序的前10个state）:</p>
<pre class="chroma">GET /bank/_search
{
  &#34;size&#34;: 0,
  &#34;aggs&#34;: {
    &#34;group_by_state&#34;: {
      &#34;terms&#34;: {
        &#34;field&#34;: &#34;state.keyword&#34;
      },
      &#34;aggs&#34;: {
        &#34;average_balance&#34;: {
          &#34;avg&#34;: {
            &#34;field&#34;: &#34;balance&#34;
          }
        }
      }
    }
  }
}
</pre>
<p>请注意我们如何嵌套group_by_state聚合到average_balance聚合中的。这是聚合的常见模式。你可以在任意聚合中嵌套聚合，来从数据中提取你所需要的统计概要。</p>

<p>在前面聚合的基础上，下面的例子中，我们改用average_balance来降序排序：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;size&#34;: 0,
  &#34;aggs&#34;: {
    &#34;group_by_state&#34;: {
      &#34;terms&#34;: {
        &#34;field&#34;: &#34;state.keyword&#34;,
        &#34;order&#34;: {
          &#34;average_balance&#34;: &#34;desc&#34;
        }
      },
      &#34;aggs&#34;: {
        &#34;average_balance&#34;: {
          &#34;avg&#34;: {
            &#34;field&#34;: &#34;balance&#34;
          }
        }
      }
    }
  }
}
</pre>
<p>下面这个例子演示了如何使用年龄段分组，然后是用性别分组，最后得到一个每个性别中每个年龄段账户余额的平均值：</p>
<pre class="chroma">GET /bank/_search
{
  &#34;size&#34;: 0,
  &#34;aggs&#34;: {
    &#34;group_by_age&#34;: {
      &#34;range&#34;: {
        &#34;field&#34;: &#34;age&#34;,
        &#34;ranges&#34;: [
          {
            &#34;from&#34;: 20,
            &#34;to&#34;: 30
          },
          {
            &#34;from&#34;: 30,
            &#34;to&#34;: 40
          },
          {
            &#34;from&#34;: 40,
            &#34;to&#34;: 50
          }
        ]
      },
      &#34;aggs&#34;: {
        &#34;group_by_gender&#34;: {
          &#34;terms&#34;: {
            &#34;field&#34;: &#34;gender.keyword&#34;
          },
          &#34;aggs&#34;: {
            &#34;average_balance&#34;: {
              &#34;avg&#34;: {
                &#34;field&#34;: &#34;balance&#34;
              }
            }
          }
        }
      }
    }
  }
}
</pre>
<p>还有许多其他聚合功能，我们在此不再详述。如果您想进行进一步的实验，<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/search-aggregations.html">聚合参考指南</a>是一个很好的起点。</p>

    </div>

  </div>
</body>

<footer>
    <div class="container">
        <div class="row footer-links">
            <div class="col-lg-2 col-sm-2">
                <h3>友情链接</h3>
                <ul>
                    <li><a href="">友链位招租</a></li>
                    <li><a href="">友链位招租</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>没想好</h3>
                <ul>
                    <li><a href="">我爸没想好</a></li>
                    <li><a href="">我哥说我爸没想好</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>Hooray</h3>
                <ul>
                    <li><a href="">Hooray</a></li>
                    <li><a href="">What are we Hooray For?</a></li>
                </ul>
            </div>
            <div class="col-lg-2 col-sm-2">
                <h3>前面的footer太浪了</h3>
                <ul>
                    <li><a href="">就是就是</a></li>
                    <li><a href="">偷偷的表示羡慕</a></li>
                </ul>
            </div>
            <div class="col-lg-4 col-sm-4">
                <h3>网站信息</h3>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <a class="" href="" target="_blank"></a>
                <div class="fine-print">
                    <p>网战由以下技术支撑</p>
                    <ul>
                        <li>Markdown Processor: <a href="https://github.com/russross/blackfriday/tree/v2">Blackfriday V2</a></li>
                        <li>Renderer Engine: <a href="https://github.com/Depado/bfchroma/">bfchroma</a></li>
                        <li>Syntax Highlighter: <a href="https://github.com/alecthomas/chroma">Chroma</a></li>
                        <li>Coding Language: <a href="https://go.dev/">Golang</a></li>
                        <li>Others: Markdown, HTML, CSS</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

</html>